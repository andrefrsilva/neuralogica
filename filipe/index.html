<!DOCTYPE html><html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pastelaria Filipe - Encomendas</title>
  <link rel="manifest" href="manifest.json">
    <style>
        /* ---------------------------------- */
        /* 1. GLOBAIS & TEMA "PASTELARIA"
        /* ---------------------------------- */
        :root {
            --theme-primary: #811a31; /* Bordô */
            --theme-primary-dark: #611425;
            --theme-secondary: #f0ece0; /* Bege Claro */
            --theme-text-dark: #3d3636; /* Cinzento */
            --theme-text-light: #6a6363;
            --theme-accent: #b99a30; /* Dourado */
            --theme-background: #fff;
            --theme-border: #e0d9cd; /* Tom de bege/cinza para bordas */

        --status-recebido: #29B6F6;
        --status-producao: #FFA726;
        --status-terminado: #4CAF50;
        --status-levantado: #78909C;
        --status-entregue: #4CAF50;
        --status-cancelado: #E53935;
        
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --radius-md: 8px;
        --radius-lg: 12px;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }

    html {
        scroll-behavior: smooth;
    }

    body {
        font-family: Georgia, 'Times New Roman', Times, serif;
        background-color: var(--theme-secondary);
        color: var(--theme-text-dark);
        font-size: 16px;
        line-height: 1.6;
    }
    
    h1, h2, h3, h4 {
        font-family: 'Times New Roman', Times, serif;
        color: var(--theme-primary);
        font-weight: 700;
    }

    /* ---------------------------------- */
    /* 2. ESTRUTURA APP & FULLSCREEN
    /* ---------------------------------- */
    
    .launch-button {
        padding: 18px 36px;
        font-size: 1.25rem;
        font-weight: 700;
        font-family: Georgia, serif;
        color: #fff;
        background-color: var(--theme-primary);
        border: none;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .launch-button:hover {
        background-color: var(--theme-primary-dark);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    #app-container {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: var(--theme-background);
        overflow: hidden;
    }
    
    #app-container.running {
        display: flex;
    }

    header {
        background-color: var(--theme-background);
        padding: 10px 20px;
        border-bottom: 1px solid var(--theme-border);
        text-align: center;
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0;
    }
    
    .header-logo {
        max-width: 200px;
        max-height: 45px;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    #page-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 90px;
        background-color: var(--theme-secondary);
        -webkit-overflow-scrolling: touch;
    }

    #bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-top: 1px solid var(--theme-border);
        z-index: 100;
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        flex-shrink: 0;
    }

    .nav-button {
        flex: 1;
        padding: 12px 5px;
        background: none;
        border: none;
        cursor: pointer;
        text-align: center;
        color: var(--theme-text-light);
        font-size: 0.75rem;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        transition: all 0.2s ease-in-out;
    }
    .nav-button svg {
        width: 22px;
        height: 22px;
        stroke: var(--theme-text-light);
        stroke-width: 2;
        transition: all 0.2s ease-in-out;
    }
    .nav-button.active {
        color: var(--theme-primary);
    }
    .nav-button.active svg {
        stroke: var(--theme-primary);
        transform: scale(1.1);
    }

    .page {
        display: none;
        animation: fadeIn 0.4s ease;
    }
    .page.active {
        display: block;
    }
    
    .page-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    h2 {
        font-size: 1.8rem;
        margin-bottom: 10px;
    }
    h3 {
        font-size: 1.25rem;
        color: var(--theme-text-dark);
        margin-top: 25px;
        margin-bottom: 15px;
        border-bottom: 2px solid var(--theme-border);
        padding-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* ---------------------------------- */
    /* 3. COMPONENTES REUTILIZÁVEIS
    /* ---------------------------------- */
    .card {
        background: var(--theme-background);
        border-radius: var(--radius-lg);
        border: 1px solid var(--theme-border);
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
    }

    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 0.9rem;
        color: var(--theme-text-dark);
    }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="date"],
    .form-group input[type="time"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="file"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 14px;
        border: 1px solid var(--theme-border);
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-family: Arial, sans-serif;
        background: #fdfdfd;
        transition: all 0.2s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='%23811a31'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
        padding-right: 40px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--theme-primary);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(129, 26, 49, 0.2);
    }
    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }
    .form-group .field-note {
        font-size: 0.85rem;
        color: var(--theme-text-light);
        margin-top: 5px;
    }

    button.btn, .btn {
        display: inline-block;
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 1.1rem;
        font-weight: 700;
        font-family: Georgia, serif;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    button.btn-primary {
        background-color: var(--theme-primary);
        color: #fff;
    }
    button.btn-primary:hover, button.btn-primary:focus {
        background-color: var(--theme-primary-dark);
        box-shadow: 0 4px 10px rgba(129, 26, 49, 0.3);
        transform: translateY(-2px);
    }
    button.btn-primary:disabled {
        background-color: var(--theme-text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    button.btn-secondary {
        background-color: var(--theme-border);
        color: var(--theme-primary);
    }
    button.btn-secondary:hover, button.btn-secondary:focus {
        background-color: #d1c7b8;
    }
    
    button.btn-danger {
        background-color: var(--status-cancelado);
        color: #fff;
    }
    button.btn-danger:hover {
        background-color: #c42d2a;
    }
    .quantity-stepper {
        display: flex;
        align-items: center;
    }
    .quantity-stepper button {
        width: 40px;
        height: 40px;
        border: 1px solid var(--theme-border);
        background: var(--theme-background);
        color: var(--theme-primary);
        font-size: 1.5rem;
        font-weight: 700;
        cursor: pointer;
        border-radius: 50%;
        transition: all 0.2s ease;
        line-height: 1;
    }
    .quantity-stepper button:hover {
        background: var(--theme-secondary);
    }
    .quantity-stepper input {
        width: 50px;
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        border: none;
        background: none;
        margin: 0 5px;
        padding: 5px;
        -moz-appearance: textfield;
    }
    .quantity-stepper input::-webkit-outer-spin-button,
    .quantity-stepper input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* ---------------------------------- */
    /* 4. PÁGINA CLIENTE (B2C)
    /* ---------------------------------- */
    
    @media (min-width: 1024px) {
        #page-b2c .page-wrapper {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .product-grid, #revenda-content {
            width: 100%;
        }
        #revenda-search {
            max-width: none;
        }
    }
    
    .checkout-sidebar {
        position: sticky;
        top: 20px;
    }

    .product-card {
        display: flex;
        gap: 15px;
        background: #fff;
        padding: 15px;
        border-radius: var(--radius-md);
        border: 1px solid var(--theme-border);
        margin-bottom: 15px;
        box-shadow: var(--shadow-sm);
    }
    
   .product-image-thumb {
        width: 80px;
        height: 80px;
        flex-shrink: 0;
        border-radius: var(--radius-md);
        background-color: var(--theme-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: var(--theme-primary);
    }
    .product-image-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--radius-md);
    }
    
    .product-info {
        flex-grow: 1;
    }
    .product-info strong {
        display: block;
        font-size: 1.15rem;
        color: var(--theme-text-dark);
        font-family: Georgia, serif;
    }
    .product-info .product-price {
        font-size: 1rem;
        color: var(--theme-primary);
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .product-actions {
        margin-top: 10px;
    }
    
    #bolo-aniversario-form .product-actions {
        margin-top: 0;
    }
    .bolo-aniversario-fields {
        padding-top: 15px;
        margin-top: 15px;
        border-top: 1px dashed var(--theme-border);
    }
    
    #cart-summary {
        position: sticky;
        bottom: 70px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        padding: 15px 20px;
        margin: 20px -20px -20px -20px;
        border-top: 1px solid var(--theme-border);
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        z-index: 50;
    }
    
    #cart-summary-total {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--theme-primary);
        text-align: center;
        margin-bottom: 15px;
    }

    @media (min-width: 1024px) {
        #cart-summary {
            position: relative;
            bottom: auto;
            margin: 0;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        #cart-summary-total {
            text-align: left;
        }
    }
    
    #cart-items-list {
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 15px;
    }
    
    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--theme-border);
        font-size: 0.9rem;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    .cart-item-info {
        flex-grow: 1;
    }
    .cart-item-info strong {
        font-size: 0.95rem;
        color: var(--theme-text-dark);
    }
    .cart-item-info span {
        display: block;
        font-size: 0.85rem;
        color: var(--theme-text-light);
    }
    .cart-item-remove {
        width: 30px;
        height: 30px;
        flex-shrink: 0;
        background: none;
        border: 1px solid var(--status-cancelado);
        color: var(--status-cancelado);
        border-radius: 50%;
        font-weight: 700;
        font-size: 1rem;
        line-height: 1;
        cursor: pointer;
        margin-left: 10px;
    }

    #client-contact {
        text-align: center;
        padding: 15px;
        font-size: 0.9rem;
        color: var(--theme-text-light);
        background: var(--theme-secondary);
        border-radius: var(--radius-md);
        margin-top: 20px;
    }

    .toggle-view {
        display: flex;
        border: 1px solid var(--theme-primary);
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    .toggle-view button {
        flex: 1;
        padding: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        font-family: Arial, sans-serif;
        border: none;
        background: var(--theme-background);
        color: var(--theme-primary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .toggle-view button:first-child {
        border-right: 1px solid var(--theme-primary);
    }
    .toggle-view button.active {
        background: var(--theme-primary);
        color: #fff;
    }

    /* Revenda specific */
    #revenda-login {
        display: none;
    }
    #revenda-content {
        display: none;
    }
    #revenda-search {
        width: 100%;
        padding: 14px;
        border: 1px solid var(--theme-border);
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-family: Arial, sans-serif;
        background: #fdfdfd;
        transition: all 0.2s ease;
        margin-bottom: 20px;
    }
  
  #revenda-search:focus {
        outline: none;
        border-color: var(--theme-primary);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(129, 26, 49, 0.2);
    }
  
    .accordion-section {
        margin-bottom: 10px;
    }
  .accordion-header {
    cursor: pointer;
    padding: 10px;
    background: var(--theme-secondary);
    border-radius: var(--radius-md);
    font-weight: bold;
    position: relative;
    transition: background-color 0.2s ease; /* ADICIONA ISTO */
}

/* ADICIONA ESTA NOVA REGRA */
.accordion-header.active {
    background-color: #e0d9cd; /* Tom de bege mais escuro */
}

.accordion-header::after {
    content: '+';
    position: absolute;
    right: 10px;
    font-size: 1.2rem;
    transition: transform 0.3s ease-out; /* ADICIONA ISTO */
}

.accordion-header.active::after {
    content: '–'; /* Usei um 'en-dash' que é mais bonito que o '-' */
    transform: rotate(180deg); /* ADICIONA ISTO */
}

.accordion-content {
    max-height: 0; /* ADICIONA ISTO */
    overflow: hidden; /* ADICIONA ISTO */
    transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* ADICIONA ISTO */
    padding: 0 10px; /* ALTERA ISTO */
}

.accordion-content.active {
    max-height: 2000px; /* ADICIONA ISTO (um valor alto) */
    padding: 10px; /* ALTERA ISTO */
}
      
    #revenda-countdown {
        text-align: center;
        font-size: 1.2rem;
        margin-bottom: 20px;
    }
    #confetti-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 300;
    }

    /* ---------------------------------- */
    /* 4.5. PÁGINA "MINHAS ENCOMENDAS"
    /* ---------------------------------- */
    #my-orders-login {
        text-align: center;
    }
    #my-orders-login p {
        margin-bottom: 15px;
        color: var(--theme-text-light);
    }
    #my-orders-login .form-group {
        max-width: 400px;
        margin: 0 auto 15px auto;
    }
    #my-orders-login button {
        max-width: 400px;
    }
    #my-orders-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #my-orders-header button {
        font-size: 0.9rem;
        font-family: Arial, sans-serif;
        background: none;
        border: none;
        color: var(--theme-primary);
        cursor: pointer;
        font-weight: 700;
    }
    .my-order-ticket .ticket-details p strong {
        min-width: 100px; /* Mais curto para cliente */
    }
    
    /* ---------------------------------- */
    /* 5. PÁGINA STAFF
    /* ---------------------------------- */
    .staff-controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }
    .staff-controls .form-group {
        margin-bottom: 0;
    }
    
    .toggle-view {
        display: flex;
        border: 1px solid var(--theme-primary);
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    .toggle-view button {
        flex: 1;
        padding: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        font-family: Arial, sans-serif;
        border: none;
        background: var(--theme-background);
        color: var(--theme-primary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .toggle-view button:first-child {
        border-right: 1px solid var(--theme-primary);
    }
    .toggle-view button.active {
        background: var(--theme-primary);
        color: #fff;
    }
    
    @media (min-width: 768px) {
        .staff-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: center;
        }
        .staff-controls .toggle-view {
            grid-column: 1 / -1;
        }
    }
    @media (min-width: 1024px) {
        .staff-controls {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }
        .staff-controls .toggle-view {
            grid-column: auto;
        }
    }
    
    .order-ticket {
        border-left: 5px solid var(--status-recebido);
    }
    .order-ticket.status-producao { border-left-color: var(--status-producao); }
    .order-ticket.status-terminado { border-left-color: var(--status-terminado); }
    .order-ticket.status-levantado {
        border-left-color: var(--status-levantado);
        opacity: 0.7;
        background: #f9f9f9;
    }
    .order-ticket.status-entregue {
        border-left-color: var(--status-entregue);
        opacity: 0.7;
        background: #f9f9f9;
    }
    .order-ticket.status-cancelado {
        border-left-color: var(--status-cancelado);
        opacity: 0.6;
    }

    .ticket-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .ticket-header strong {
        font-size: 1.2rem;
        color: var(--theme-primary);
    }
    .ticket-header .ticket-id {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--theme-text-light);
    }
    
    .ticket-details p {
        font-size: 0.95rem;
        margin-bottom: 5px;
    }
    .ticket-details p strong {
        color: var(--theme-text-dark);
        min-width: 130px;
        display: inline-block;
    }
    
    .ticket-items {
        margin-top: 15px;
        font-size: 0.9rem;
    }
    .ticket-items-list {
        padding-left: 20px;
        list-style-type: disc;
        color: var(--theme-text-light);
        max-height: 80px;
        overflow: hidden;
        position: relative;
    }
    .ticket-items-list.expanded {
        max-height: none;
    }
    .ticket-items-list.expandable::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 30px;
        background: linear-gradient(to bottom, transparent, #fff);
    }
    .ticket-items-list.expanded::after {
        display: none;
    }
    .ticket-items-list li {
        margin-bottom: 3px;
    }
    .ticket-items-list li .item-status {
        font-size: 0.8rem;
        font-weight: 700;
        padding: 2px 5px;
        border-radius: 4px;
        margin-left: 5px;
        color: #fff;
        background: var(--status-recebido);
    }
    .ticket-items-list li .item-status-producao { background: var(--status-producao); }
    .ticket-items-list li .item-status-terminado { background: var(--status-terminado); }
    .ticket-items-list li .item-status-levantado { background: var(--status-levantado); }
    .ticket-items-list li .item-status-entregue { background: var(--status-entregue); }
    .ticket-items-list li .item-status-cancelado { background: var(--status-cancelado); }
    
    .expand-items-btn {
        background: none;
        border: none;
        color: var(--theme-primary);
        font-weight: 700;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    /* Botões de estado segmentados (REVERTIDO) */
    .order-status-segmented {
        display: flex;
        width: 100%;
        border: 1px solid var(--theme-primary);
        border-radius: var(--radius-md);
        overflow: hidden;
        margin-top: 20px;
    }
    .order-status-segmented button {
        flex: 1;
        background: #fff;
        color: var(--theme-primary);
        border: none;
        border-left: 1px solid var(--theme-border);
        padding: 10px 5px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: Arial, sans-serif;
    }
    .order-status-segmented button:first-child { border-left: none; }
    .order-status-segmented button.active {
        color: #fff;
        font-weight: 700;
    }
    .order-status-segmented button[data-status="recebido"].active { background-color: var(--status-recebido); }
    .order-status-segmented button[data-status="producao"].active { background-color: var(--status-producao); }
    .order-status-segmented button[data-status="terminado"].active { background-color: var(--status-terminado); }
    .order-status-segmented button[data-status="levantado"].active { background-color: var(--status-levantado); }
    .order-status-segmented button[data-status="entregue"].active { background-color: var(--status-entregue); }
    .order-status-segmented button[data-status="cancelado"].active { background-color: var(--status-cancelado); }
    .order-status-segmented button[data-status="cancelado"] { color: var(--status-cancelado); }
    .order-status-segmented button[data-status="cancelado"].active { color: #fff; }
    .ticket-status-control {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    .ticket-status-control button {
        font-size: 0.9rem;
        padding: 10px 14px;
        font-weight: 700;
    }

    #staff-subtotal {
        font-size: 1.2rem;
        font-weight: bold;
        margin: 10px 0;
    }

    /* ---------------------------------- */
    /* 6. PÁGINA ADMIN
    /* ---------------------------------- */
    .admin-filters {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    .admin-filters .form-group { margin-bottom: 0; }
    
    @media (min-width: 1024px) {
        .admin-filters {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 25px;
    }
    
    @media (min-width: 768px) {
        .kpi-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    .kpi-card {
        background: var(--theme-background);
        border: 1px solid var(--theme-border);
        padding: 15px;
        border-radius: var(--radius-md);
        text-align: center;
    }
    .kpi-card .kpi-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--theme-primary);
        line-height: 1.2;
    }
    .kpi-card .kpi-label {
        font-size: 0.8rem;
        color: var(--theme-text-light);
        font-weight: 600;
    }
    .kpi-card .kpi-sub-value {
        font-size: 0.8rem;
        color: var(--theme-text-light);
    }
    
    .chart-nav {
        display: flex;
        gap: 8px;
    }
    .chart-nav button {
        background: var(--theme-border);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-weight: 700;
        color: var(--theme-primary);
        cursor: pointer;
        line-height: 1;
    }
    .chart-nav button:hover {
        background: #d1c7b8;
    }

    .chart-container-scrollable {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border: 1px solid var(--theme-border);
        border-radius: var(--radius-md);
        background: var(--theme-background);
    }

    .chart-container {
        width: 100%;
        height: 250px;
        padding: 20px;
        padding-bottom: 40px;
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        gap: 10px;
    }
    
    #admin-chart-month.chart-container {
        min-width: 900px;
    }
    #admin-chart-week.chart-container {
        min-width: 300px;
    }

    .chart-bar {
        flex: 1;
        background-color: var(--theme-primary);
        border-radius: 6px 6px 0 0;
        position: relative;
        animation: barRise 1s ease-out;
        transition: height 0.5s ease-out;
        min-width: 20px; 
    }
    .chart-bar[style*="height: 0%"] {
        animation: none;
    }
    .chart-bar .bar-label {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--theme-text-light);
        white-space: nowrap;
    }
    .chart-bar .bar-value {
        position: absolute;
        top: -22px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--theme-primary);
        white-space: nowrap;
    }
    @keyframes barRise {
        from { height: 0; }
    }

    /* ---------------------------------- */
    /* 7. MODAIS (IMAGEM & NOTIFICAÇÃO)
    /* ---------------------------------- */
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: none; 
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none; /* DESLIGADO POR DEFEITO */
    }
    .modal-overlay.visible {
        display: flex;
        opacity: 1;
        pointer-events: auto; /* LIGADO QUANDO VISÍVEL */
    }

    #image-modal-content {
        pointer-events: auto; 
        background: #fff;
        padding: 0;
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 800px;
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        position: relative;
        height: 80%;
        max-height: 80vh;
    }
    
    .modal-overlay.visible #image-modal-content {
        transform: scale(1);
    }

    #image-modal-content img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: var(--radius-lg);
    }
    .modal-close-btn {
        position: absolute;
        top: -15px;
        right: -15px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--theme-primary);
        color: #fff;
        border: 2px solid #fff;
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
        cursor: pointer;
        z-index: 210;
        box-shadow: var(--shadow-md);
        pointer-events: auto;
    }

    #toast-notification {
        position: fixed;
        bottom: 100px; /* Acima da nav-bar */
        left: 50%;
        transform: translate(-50%, 100px);
        background: var(--theme-text-dark);
        color: #fff;
        padding: 12px 20px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.9rem;
        font-family: Arial, sans-serif;
        z-index: 300;
        box-shadow: var(--shadow-md);
        transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1);
        opacity: 0;
        pointer-events: none; /* Toast nunca bloqueia cliques */
    }
    #toast-notification.show {
        transform: translate(-50%, 0);
        opacity: 1;
    }
</style></head>
<body>

<div id="app-container">

    <header>
        <img src="https://i.postimg.cc/02xn5CRv/image.png" alt="Pastelaria Filipe" class="header-logo">
    </header>

    <main id="page-content">

        <section id="page-b2c" class="page active">
            <div class="page-wrapper">
                
                <div class="toggle-view" id="mode-toggle">
                    <button class="active" data-mode="particular">Particular</button>
                    <button data-mode="revenda">Revenda</button>
                </div>
                
                <div id="particular-content">
                    <div class="product-grid">
                        <h2>As Nossas Especialidades</h2>
                        
                        <div id="product-list-container"></div>
                    </div>
                </div>

                <div id="revenda-login" class="card">
                    <h3>Login Revenda</h3>
                    <form id="revenda-login-form">
                        <div class="form-group">
                            <label for="revenda-username">Username</label>
                            <input type="text" id="revenda-username" required>
                        </div>
                        <div class="form-group">
                            <label for="revenda-password">Palavra-passe</label>
                            <input type="password" id="revenda-password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Entrar</button>
                    </form>
                    <p id="revenda-login-error" style="color: red; display: none;">Credenciais inválidas. Contacte a gerência: 21 948 8720</p>
                </div>

<div id="revenda-content">
    <h2>Encomenda Revenda para Amanhã</h2>
    <div id="revenda-countdown"></div>

    <div id="revenda-summary-box" class="card" style="position: sticky; top: 10px; z-index: 50; margin-bottom: 20px;">
        <h3>Subtotal Revenda</h3>
        <div id="revenda-summary-total" style="font-size: 1.5rem; font-weight: 700; color: var(--theme-primary); margin-bottom: 15px;">Total: 0.00€</div>
        <button id="revenda-submit-sticky" class="btn btn-primary">Enviar Encomenda</button>
    </div>
    <input type="text" id="revenda-search" placeholder="Pesquisar artigos..." class="form-group">
    <div id="revenda-product-list"></div>
    
    </div>

                <aside class="checkout-sidebar">
                    <div id="cart-summary" class="card">
                        <h3>A sua Encomenda</h3>
                        <div id="cart-items-list">
                            <p id="cart-empty-msg" style="color: var(--theme-text-light);">O seu carrinho está vazio.</p>
                        </div>
                        <div id="cart-summary-total">Total: 0.00€</div>
                        <button id="checkout-btn" class="btn btn-primary" disabled>Finalizar Encomenda</button>
                    </div>
                    
                    <div id="checkout-form-container" class="card" style="display: none;">
                        <h3>Dados de Levantamento</h3>
                        <form id="form-b2c-checkout">
                            <div class="form-group">
                                <label for="b2c-nome-cliente">O seu Nome</label>
                                <input type="text" id="b2c-nome-cliente" placeholder="Nome completo" required>
                            </div>
                            <div class="form-group">
                                <label for="b2c-telemovel">O seu Telemóvel</label>
                                <input type="text" id="b2c-telemovel" placeholder="912 345 678" required>
                            </div>
                            <div class="form-group">
                                <label for="b2c-pickup-location">Local de Levantamento</label>
                                <select id="b2c-pickup-location" required>
                                    <option value="">Selecione um local...</option>
                                    <option value="R. Cidade de Nova Lisboa 70, 2680-035 Camarate">R. Cidade de Nova Lisboa 70, 2680-035 Camarate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="b2c-data-levantamento">Data de Levantamento</label>
                                <input type="date" id="b2c-data-levantamento" required>
                                <p class="field-note" id="pickup-date-note"></p>
                            </div>
                            <div class="form-group">
                                <label for="b2c-hora-levantamento">Hora de Levantamento (08:00 - 20:00)</label>
                                <input type="time" id="b2c-hora-levantamento" min="08:00" max="20:00" required>
                            </div>
                            <div class="form-group">
                                <label for="b2c-codigo-cliente">Código de Cliente (Opcional)</label>
                                <input type="text" id="b2c-codigo-cliente" placeholder="Ex: CLIENTE_VIP">
                            </div>
                            <button type="submit" id="b2c-submit" class="btn btn-primary">Confirmar Encomenda</button>
                        </form>
                    </div>
                    
                    <div id="client-contact" class="card">
                        Precisa de ajuda ou de algo especial?
                        

                        Ligue-nos: <strong>21 948 8720</strong>
                    </div>

                </aside>
            </div>
        </section>
        
        <section id="page-my-orders" class="page">
            <div class="page-wrapper">
                
                <div id="my-orders-login" class="card" style="display: none;">
                    <h2>Minhas Encomendas</h2>
                    <p>Insira o seu número de telemóvel para ver o estado das suas encomendas.</p>
                    <form id="my-orders-login-form">
                        <div class="form-group">
                            <input type="text" id="my-orders-phone-input" placeholder="912 345 678" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Ver Encomendas</button>
                    </form>
                </div>

                <div id="my-orders-list-container" style="display: none;">
                    <div id="my-orders-header">
                        <h2>Minhas Encomendas</h2>
                        <button id="my-orders-logout-btn">Mudar Utilizador</button>
                    </div>
                    <p style="color: var(--theme-text-light); margin-top: -10px; margin-bottom: 20px;">
                        A ver encomendas para: <strong id="my-orders-phone-display"></strong>
                    </p>
                    <div id="my-orders-list">
                        </div>
                </div>
            </div>
        </section>
        
        <section id="page-staff" class="page">
            <div class="page-wrapper">
                <h2>Painel Staff</h2>
                
                <div class="staff-controls card">
                    <div class="toggle-view" id="staff-mode-toggle">
                        <button id="staff-view-particular-btn" class="active" data-mode="particular">Particular</button>
                        <button id="staff-view-revenda-btn" data-mode="revenda">Revenda</button>
                    </div>
                    <div class="toggle-view">
                        <button id="staff-view-item-btn" class="active" data-view="item">Ver por Item</button>
                        <button id="staff-view-order-btn" data-view="order">Ver por Encomenda</button>
                    </div>
                    <div class="form-group">
                        <input type="text" id="staff-search-input" placeholder="Pesquisar por cliente...">
                    </div>
                    <div class="form-group">
                        <select id="staff-filter-status">
                            <option value="all_active">Ativos (Pendentes)</option>
                            <option value="all">Todos os Estados</option>
                            <option value="recebido">Recebido</option>
                            <option value="producao">Em Produção</option>
                            <option value="terminado">Terminado</option>
                            <option value="levantado">Levantado</option>
                            <option value="entregue">Entregue</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="staff-sort-by">
                            <option value="pickupDateAsc">Ordenar por Levantamento (Asc)</option>
                            <option value="pickupDateDesc">Ordenar por Levantamento (Desc)</option>
                            <option value="orderDateAsc">Ordenar por Encomenda (Asc)</option>
                            <option value="orderDateDesc">Ordenar por Encomenda (Desc)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="staff-filter-pickup-date">Filtrar Dia Levantamento:</label>
                        <input type="date" id="staff-filter-pickup-date">
                    </div>
                     <div class="form-group">
                        <label for="staff-filter-order-date">Filtrar Dia Encomenda:</label>
                        <input type="date" id="staff-filter-order-date">
                    </div>
                </div>

                <div id="staff-subtotal"></div>

                <div id="staff-order-list">
                    <div class="card" id="no-orders-message">
                        <p>Nenhuma encomenda encontrada.</p>
                    </div>
                    </div>
            </div>
        </section>
        
        <section id="page-admin" class="page">
            <div class="page-wrapper">
                <h2>Dashboard Administrador</h2>

                <div class="admin-filters card">
                    <div class="form-group">
                        <label for="admin-filter-date">Dia (Levantamento)</label>
                        <input type="date" id="admin-filter-date" placeholder="Todos">
                    </div>
                    <div class="form-group">
                        <label for="admin-filter-status">Estado</label>
                        <select id="admin-filter-status">
                            <option value="all">Todos</option>
                            <option value="recebido">Recebido</option>
                            <option value="producao">Produção</option>
                            <option value="terminado">Terminado</option>
                            <option value="pago">Pago</option>
                            <option value="levantado">Levantado</option>
                            <option value="entregue">Entregue</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admin-filter-item">Item</label>
                        <select id="admin-filter-item">
                            <option value="all">Todos os Itens</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admin-filter-client">Cliente</label>
                        <select id="admin-filter-client">
                            <option value="all">Todos os Clientes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admin-filter-location">Local</label>
                        <select id="admin-filter-location">
                            <option value="all">Todos os Locais</option>
                            <option value="R. Cidade de Nova Lisboa 70, 2680-035 Camarate">R. Cidade de Nova Lisboa 70, 2680-035 Camarate</option>
                        </select>
                    </div>
                </div>
                
                <h3>Métricas (Filtros Aplicados)</h3>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-revenue">0.00€</div>
                        <div class="kpi-label">Receita Total</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-orders">0</div>
                        <div class="kpi-label">Nº Encomendas</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-avg-ticket">0.00€</div>
                        <div class="kpi-label">Ticket Médio</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-waste">0%</div>
                        <div class="kpi-label">% Canceladas</div>
                        <div class="kpi-sub-value" id="admin-kpi-waste-sub">0 / 0</div>
                    </div>
                </div>
                
                <h3>Tempos de Produção (Filtros Aplicados)</h3>
                 <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-time-full">--</div>
                        <div class="kpi-label">Pedido → Terminado</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-time-prod">--</div>
                        <div class="kpi-label">Produção → Terminado</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-time-deadline">0%</div>
                        <div class="kpi-label">% Prod. Atrasada</div>
                    </div>
                     <div class="kpi-card">
                        <div class="kpi-value" id="admin-kpi-time-pickup">0%</div>
                        <div class="kpi-label">% Não Levantadas</div>
                    </div>
                </div>

                <div class="card">
                    <h3 id="admin-chart-week-title">Receita (€) por Dia da Semana</h3>
                        <div class="chart-nav">
                            <button id="admin-chart-week-prev"><</button>
                            <button id="admin-chart-week-next">></button>
                        </div>
                    <div class="chart-container-scrollable">
                        <div class="chart-container" id="admin-chart-week"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 id="admin-chart-month-title">Receita (€) por Dia do Mês</h3>
                        <div class="chart-nav">
                            <button id="admin-chart-month-prev"><</button>
                            <button id="admin-chart-month-next">></button>
                        </div>
                    <div class="chart-container-scrollable">
                        <div class="chart-container" id="admin-chart-month"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Exportar Dados</h3>
                    <p style="margin-bottom: 15px; color: var(--theme-text-light);">Faça download de um ficheiro CSV com todas as encomendas registadas em sistema.</p>
                    <button id="admin-export-csv" class="btn btn-secondary" style="width: auto;">Download CSV</button>
                </div>

            </div>
        </section>
    </main>

    <nav id="bottom-nav">
        <button class="nav-button active" data-page="page-b2c" aria-label="Encomendar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
            <span>Encomendar</span>
        </button>
         <button class="nav-button" data-page="page-my-orders" aria-label="Minhas Encomendas">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <span>As Minhas</span>
        </button>
        <button class="nav-button" data-page="page-staff" aria-label="Área Staff">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
            <span>Staff</span>
        </button>
        <button class="nav-button" data-page="page-admin" aria-label="Área Admin">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            <span>Admin</span>
        </button>
    </nav>
</div>

<div id="image-modal" class="modal-overlay">
    <div id="image-modal-content">
        <button id="image-modal-close-btn" class="modal-close-btn">&times;</button>
        <img id="image-modal-src" src="" alt="Imagem do Produto">
    </div>
</div>

<div id="toast-notification" role="alert">
    <span id="toast-message"></span>
</div>

<canvas id="confetti-canvas"></canvas>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- ESTADO GLOBAL DA APLICAÇÃO ---
        let state = {
            orders: [],
            cart: [],
            staffView: 'order',
            staffMode: 'particular',
            mode: 'particular',
            adminFilters: {
                chartViewDate: new Date()
            },
            nextOrderId: 1001
        };
        
        const PRODUCT_CATALOG = {
            particular: {
                natal: [
                    { id: 'BOLO_OVO_NATAL', name: 'Bolo com doce de ovo de Natal', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_CHANTILLY_FRUTA', name: 'Bolo Chantilly (com fruta)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRANCHE_CARAMELO', name: 'Tranche de Caramelo', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRANCHE_CHANTILLY_FRUTA', name: 'Tranche Chantilly (C/Fruta)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'SEMIFRIOS', name: 'Semifrios (Morango, Laranja)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TARTES_AMENDOA', name: 'Tartes de Amêndoa', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TARTES_NATA', name: 'Tartes de Nata', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRAVESSEIRO_NOIVA', name: 'Travesseiro de Noiva', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TORTAS', name: 'Tortas (Ovo, Choc, Mant, Simples)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TORTA_LEITE', name: 'Torta de Leite', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TORTA_LARANJA', name: 'Torta de Laranja', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'RUSSO_MANTEIGA', name: 'Russo de Manteiga', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_NOZ', name: 'Bolo de Noz', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_BRIGADEIRO', name: 'Bolo Brigadeiro', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'PROFITEROL', name: 'Profiteroles', price: 11.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'PUDIM', name: 'Pudim', price: 10.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'MOLOTOF', name: 'Molotof', price: 10.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'BOLO_BOLACHA', name: 'Bolo de Bolacha', price: 11.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'LAMPREIA', name: 'Lampreia', price: 22.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRONCO_NATAL', name: 'Tronco de Natal (Choc/Ovo)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'PAO_LO_SIMPLES', name: 'Pão de Ló Simples', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_REI', name: 'Bolo-Rei', price: 11.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_RAINHA', name: 'Bolo-Rainha', price: 11.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BROA_CASTELAR', name: 'Broa Castelar', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'SONHOS', name: 'Sonhos', price: 13.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'COSCOROES', name: 'Coscorões', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'FILHOS', name: 'Filhós', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'FATIAS_DOURADAS', name: 'Fatias Douradas', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'AZEVIAS', name: 'Azevias', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                ],
                especiais: [
                    { 
                        id: 'BOLO_ANIV', 
                        name: 'Bolo de Aniversário', 
                        price: 13.00, 
                        unit: 'kg (min 1kg)', 
                        step: 0.5, 
                        min: 1.0, 
                        img: '',
                        types: {
                            'pao de lo normal': 13.00,
                            'manteiga': 14.00,
                            'pasta de acucar': 14.00
                        },
                        customFields: [
                            { id: 'bolo_type', label: 'Tipo de Bolo', type: 'select', options: ['pao de lo normal', 'manteiga', 'pasta de acucar'] },
                            { id: 'imagem_edivel', label: 'Imagem Impressa Comestível (+3€)', type: 'checkbox' },
                            { id: 'upload_imagem', label: 'Upload Imagem (max 10MB)', type: 'file' },
                            { id: 'nome_aniversariante', label: 'Nome no Bolo', type: 'text', placeholder: 'Ex: Parabéns João' },
                            { id: 'idade_aniversariante', label: 'Idade (opcional)', type: 'number', placeholder: 'Ex: 10' },
                            { id: 'obs_bolo', label: 'Outras Informações', type: 'textarea', placeholder: 'Ex: Massa de chocolate, recheio de morango...' }
                        ]
                    }
                ]
            },
            revenda: {
                pastelaria: [
                    { id: 'TRANCA_CREME', name: 'Trança C/ Creme', price: 1.00, unit: 'unid', img: '' },
                    { id: 'TRANCA_COCO', name: 'Trança C/ Côco', price: 1.00, unit: 'unid', img: '' },
                    { id: 'CROISSANT_SIMPLES', name: 'Croissant Simples', price: 1.00, unit: 'unid', img: '' },
                    { id: 'SALAMES', name: 'Salames', price: 1.00, unit: 'unid', img: '' },
                ],
                bolos_especiais: [
                    { id: 'FATIA_CHANTILLY', name: 'Fatia de Chantilly', price: 1.00, unit: 'unid', img: '' },
                    { id: 'FATIA_CARAMELO', name: 'Fatia de Caramelo', price: 1.00, unit: 'unid', img: '' },
                    { id: 'FATIA_BRIGADEIRO', name: 'Fatia de Brigadeiro', price: 1.00, unit: 'unid', img: '' },
                    { id: 'DUCHESSE', name: 'Duchesse', price: 1.00, unit: 'unid', img: '' },
                    { id: 'TIGELADA', name: 'Tigelada', price: 1.00, unit: 'unid', img: '' },
                    { id: 'TARTELETE_NATA', name: 'Tartelete Nata', price: 1.00, unit: 'unid', img: '' },
                    { id: 'TARTELETE_AMENDOA', name: 'Tartelete Amêndoa', price: 1.00, unit: 'unid', img: '' },
                ],
                salgados: [
                    { id: 'EMPADA_GALINHA', name: 'Empada de Galinha', price: 1.00, unit: 'unid', img: '' },
                    { id: 'EMPADA_CARNE', name: 'Empada de Carne', price: 1.00, unit: 'unid', img: '' },
                    { id: 'EMPADA_SALSICHA', name: 'Empada Salsicha', price: 1.00, unit: 'unid', img: '' },
                ],
                pao: [
                    { id: 'CARCACAS', name: 'Carcaças', price: 1.00, unit: 'unid', img: '' },
                    { id: 'BOLAS_MISTURA', name: 'Bolas de Mistura', price: 1.00, unit: 'unid', img: '' },
                    { id: 'BOLAS_AGUA', name: 'Bolas de Água', price: 1.00, unit: 'unid', img: '' },
                    { id: 'PAO_INTEGRAL', name: 'Pão Integral', price: 1.00, unit: 'unid', img: '' },
                    { id: 'PAO_FORMA_BAIXO', name: 'Pão de Forma Baixo', price: 1.00, unit: 'unid', img: '' },
                    { id: 'PAO_FORMA_ALTO', name: 'Pão de Forma Alto', price: 1.00, unit: 'unid', img: '' },
                    { id: 'PAO_MISTURA_GRANDE', name: 'Pão de Mistura Grande', price: 1.00, unit: 'unid', img: '' },
                    { id: 'BAGUETE_TRIGO_GRANDE', name: 'Baguete Trigo Grande', price: 1.00, unit: 'unid', img: '' },
                    { id: 'BAGUETE_TRIGO_PEQUENA', name: 'Baguete Trigo Pequena', price: 1.00, unit: 'unid', img: '' },
                    { id: 'BAGUETE_CEREAIS', name: 'Baguete Cereais', price: 1.00, unit: 'unid', img: '' },
                    { id: 'PAO_AZEITE', name: 'Pão de Azeite', price: 1.00, unit: 'unid', img: '' },
                ],
                natal: [
                    { id: 'BOLO_OVO_NATAL', name: 'Bolo com doce de ovo de Natal', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_CHANTILLY_FRUTA', name: 'Bolo Chantilly (com fruta)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRANCHE_CARAMELO', name: 'Tranche de Caramelo', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRANCHE_CHANTILLY_FRUTA', name: 'Tranche Chantilly (C/Fruta)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'SEMIFRIOS', name: 'Semifrios (Morango, Laranja)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TARTES_AMENDOA', name: 'Tartes de Amêndoa', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TARTES_NATA', name: 'Tartes de Nata', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRAVESSEIRO_NOIVA', name: 'Travesseiro de Noiva', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TORTAS', name: 'Tortas (Ovo, Choc, Mant, Simples)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TORTA_LEITE', name: 'Torta de Leite', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TORTA_LARANJA', name: 'Torta de Laranja', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'RUSSO_MANTEIGA', name: 'Russo de Manteiga', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_NOZ', name: 'Bolo de Noz', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_BRIGADEIRO', name: 'Bolo Brigadeiro', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'PROFITEROL', name: 'Profiteroles', price: 11.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'PUDIM', name: 'Pudim', price: 10.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'MOLOTOF', name: 'Molotof', price: 10.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'BOLO_BOLACHA', name: 'Bolo de Bolacha', price: 11.00, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'LAMPREIA', name: 'Lampreia', price: 22.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'TRONCO_NATAL', name: 'Tronco de Natal (Choc/Ovo)', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'PAO_LO_SIMPLES', name: 'Pão de Ló Simples', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_REI', name: 'Bolo-Rei', price: 11.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BOLO_RAINHA', name: 'Bolo-Rainha', price: 11.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'BROA_CASTELAR', name: 'Broa Castelar', price: 10.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'SONHOS', name: 'Sonhos', price: 13.00, unit: 'kg', step: 0.5, min: 0.5, img: '' },
                    { id: 'COSCOROES', name: 'Coscorões', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'FILHOS', name: 'Filhós', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'FATIAS_DOURADAS', name: 'Fatias Douradas', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'AZEVIAS', name: 'Azevias', price: 1.20, unit: 'unid', step: 1, min: 1, img: '' },
                    { id: 'CAIXA_COND', name: 'Caixa de Condução', price: 0.80, unit: 'unid', step: 1, min: 1, img: '' },
                ],
                especiais: [
                    { 
                        id: 'BOLO_ANIV', 
                        name: 'Bolo de Aniversário', 
                        price: 8.00, 
                        unit: 'kg (min 1kg)', 
                        step: 0.5, 
                        min: 1.0, 
                        img: '',
                        types: {
                            'pao de lo normal': 8.00,
                            'manteiga': 10.00,
                            'pasta de acucar': 12.00
                        },
                        customFields: [
                            { id: 'bolo_type', label: 'Tipo de Bolo', type: 'select', options: ['pao de lo normal', 'manteiga', 'pasta de acucar'] },
                            { id: 'imagem_edivel', label: 'Imagem Impressa Comestível (+3€)', type: 'checkbox' },
                            { id: 'upload_imagem', label: 'Upload Imagem (max 10MB)', type: 'file' },
                            { id: 'nome_aniversariante', label: 'Nome no Bolo', type: 'text', placeholder: 'Ex: Parabéns João' },
                            { id: 'idade_aniversariante', label: 'Idade (opcional)', type: 'number', placeholder: 'Ex: 10' },
                            { id: 'obs_bolo', label: 'Outras Informações', type: 'textarea', placeholder: 'Ex: Massa de chocolate, recheio de morango...' }
                        ]
                    }
                ]
            }
        };

        const REVENDA_USERS = {
            'maxipao': '123'
        };

        // --- ELEMENTOS DOM GLOBAIS ---
        const launchBtn = document.getElementById('launch-app-btn');
        const launchWrapper = document.getElementById('launch-button-wrapper');
        const appContainer = document.getElementById('app-container');
        const pageContent = document.getElementById('page-content');
        const navButtons = document.querySelectorAll('.nav-button');
        
        const toast = document.getElementById('toast-notification');
        const toastMsg = document.getElementById('toast-message');
        
        const imgModal = document.getElementById('image-modal');
        const imgModalSrc = document.getElementById('image-modal-src');
        const imgModalCloseBtn = document.getElementById('image-modal-close-btn');

        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');

        // --- 1. CORE APP (FULLSCREEN, NAVEGAÇÃO, MODAIS) ---

        function initAppCore() {
            // Remove launchBtn.addEventListener and fullscreen functions
            document.getElementById('bottom-nav').addEventListener('click', (e) => {
                const navButton = e.target.closest('.nav-button');
                if (navButton && navButton.dataset.page) {
                    showPage(navButton.dataset.page);
                }
            });
            
            // Eventos da Modal de Imagem
            imgModalCloseBtn.addEventListener('click', hideImageModal);
            imgModal.addEventListener('click', (e) => {
                if (e.target === imgModal) {
                    hideImageModal();
                }
            });
        }

        function showPage(pageId) {
            pageContent.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
            
            if (pageId === 'page-my-orders') {
                renderMyOrdersPage();
            }
            if (pageId === 'page-staff') {
                renderStaffPage();
            }
            if (pageId === 'page-admin') {
                renderAdminDashboard(); 
            }
        }
        
        let toastTimer;
        function showToast(message) {
            clearTimeout(toastTimer);
            toastMsg.textContent = message;
            toast.classList.add('show');
            toastTimer = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); // 3 segundos
        }

        // CORREÇÃO DEFINITIVA BUG MOBILE:
        function showModal(modalElement) {
            modalElement.style.display = 'flex';
            setTimeout(() => { // Delay de 10ms para forçar o reflow
                modalElement.classList.add('visible');
            }, 10);
        }

        function hideModal(modalElement) {
            // Remove a animação de fade-out e esconde imediatamente
            modalElement.classList.remove('visible');
            modalElement.style.display = 'none';
            // Força o browser a recalcular o layout, matando qualquer "fantasma"
            void document.body.offsetHeight;
        }
        
        function showImageModal(src, alt) {
            imgModalSrc.src = src;
            imgModalSrc.alt = alt;
            showModal(imgModal);
        }

        function hideImageModal() {
            hideModal(imgModal);
        }

        function launchConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            let particles = [];
            const numParticles = 300; // Increased
            const colors = ['#ff0000', '#ff9900', '#ffff00', '#00ff00', '#00ffff', '#0000ff', '#9900ff', '#ff00ff'];
            for (let i = 0; i < numParticles; i++) {
                particles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * confettiCanvas.height - confettiCanvas.height,
                    r: Math.random() * 6 + 2, // Smaller for more
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 10 + 5, // Faster
                    angle: Math.random() * Math.PI * 2,
                    rotation: Math.random() * Math.PI * 2,
                    rotSpeed: (Math.random() - 0.5) * 0.2, // Rotation
                    gravity: 0.05, // Add gravity
                    vx: (Math.random() - 0.5) * 10, // Horizontal velocity for explosion
                    vy: Math.random() * -15 - 10 // Upward explosion
                });
            }
            let animationFrame;
            function animate() {
                confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                particles.forEach(p => {
                    p.vy += p.gravity;
                    p.x += p.vx;
                    p.y += p.vy;
                    p.rotation += p.rotSpeed;
                    confettiCtx.save();
                    confettiCtx.translate(p.x, p.y);
                    confettiCtx.rotate(p.rotation);
                    confettiCtx.fillStyle = p.color;
                    confettiCtx.fillRect(-p.r / 2, -p.r / 4, p.r, p.r / 2); // Rectangle for confetti shape
                    confettiCtx.restore();
                    if (p.y > confettiCanvas.height + p.r) {
                        particles = particles.filter(part => part !== p);
                    }
                });
                if (particles.length > 0) {
                    animationFrame = requestAnimationFrame(animate);
                }
            }
            animate();
            setTimeout(() => {
                cancelAnimationFrame(animationFrame);
                confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            }, 5000);
        }
      
        // --- 2. GESTÃO DE ESTADO (LOCAL STORAGE & SEEDING) ---

        function saveState() {
            const data = {
                orders: state.orders,
                nextOrderId: state.nextOrderId
            };
            localStorage.setItem('pastelariaFilipeState', JSON.stringify(data));
        }

        function loadState() {
            const data = localStorage.getItem('pastelariaFilipeState');
            if (data) {
                const parsedData = JSON.parse(data);
                state.orders = parsedData.orders || [];
                state.nextOrderId = parsedData.nextOrderId || 1001;
            } else {
                seedInitialData();
                saveState();
            }
            renderCart();
            renderStaffPage();
        }
        
        function seedInitialData() {
            console.log("A criar dados de demonstração (seeding)...");
            const demoOrders = [];
            let orderId = 1001;
            const clients = [
                { name: 'Ana Silva', phone: '912345678', type: 'particular' },
                { name: 'Bruno Martins', phone: '965432100', type: 'particular' },
                { name: 'Carla Dias', phone: '934567890', type: 'particular' },
                { name: 'David Rocha', phone: '923456789', type: 'particular' },
                { name: 'MaxiPao', username: 'maxipao', type: 'revenda' },
                { name: 'OutraRevenda', username: 'outra', type: 'revenda' }
            ];
            const locations = ["R. Cidade de Nova Lisboa 70, 2680-035 Camarate"];
            const items = PRODUCT_CATALOG.particular.natal.concat(PRODUCT_CATALOG.particular.especiais).concat(PRODUCT_CATALOG.revenda.pastelaria).concat(PRODUCT_CATALOG.revenda.bolos_especiais).concat(PRODUCT_CATALOG.revenda.salgados).concat(PRODUCT_CATALOG.revenda.pao).concat(PRODUCT_CATALOG.revenda.natal);
            const today = new Date();
            
            // CORREÇÃO GRÁFICOS: Adicionar dados para os últimos 7 dias
            for (let i = 0; i < 10; i++) { // 10 encomendas na última semana
                const dayOffset = Math.floor(Math.random() * 7); // 0-6 dias atrás
                const pickupDate = new Date(today);
                pickupDate.setDate(today.getDate() - dayOffset);
                pickupDate.setHours(Math.floor(Math.random() * 10) + 9); // 9h-19h
                
                const orderDate = new Date(pickupDate);
                orderDate.setDate(pickupDate.getDate() - 1);
                
                const client = clients[i % clients.length];
                const item = items[i % items.length];
                const isKg = item.unit.includes('kg');
                const quantity = isKg ? (Math.random() * 1.5 + 0.5).toFixed(1) : Math.floor(Math.random() * 5) + 1;
                const total = (item.price * quantity) + (Math.random() * 5); // Adiciona alguma variação
                
                const status = (dayOffset < 2) ? 'producao' : 'levantado'; // Encomendas de hoje/ontem em produção

                demoOrders.push({
                    id: `PF-${orderId++}`,
                    clientName: client.name,
                    clientPhone: client.phone || '',
                    username: client.username || '',
                    orderDate: orderDate.toISOString(),
                    pickupDate: pickupDate.toISOString(),
                    pickupLocation: locations[0],
                    clientCode: 'N/A',
                    total: total,
                    status: status,
                    paid: (status === 'levantado'),
                    type: client.type,
                    items: [{
                        itemId: item.id, name: item.name, quantity: quantity,
                        unit: item.unit.split(' ')[0], price: item.price,
                        status: status, customFields: {}
                    }],
                    timestamps: {
                        recebido: orderDate.toISOString(),
                        producao: (status !== 'recebido') ? new Date(orderDate.getTime() + 3600000).toISOString() : null,
                        terminado: (status === 'terminado' || status === 'levantado') ? new Date(orderDate.getTime() + 14400000).toISOString() : null,
                        levantado: (status === 'levantado') ? new Date(pickupDate.getTime() + 3600000).toISOString() : null,
                        entregue: null,
                        cancelado: null
                    }
                });
            }
            
            // Adiciona encomendas futuras (para o staff ver)
            const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1); tomorrow.setHours(14, 0, 0);
            const dayAfter = new Date(); dayAfter.setDate(today.getDate() + 2); dayAfter.setHours(10, 30, 0);

            demoOrders.push({
                id: `PF-${orderId++}`, clientName: 'Filipe Antunes', clientPhone: '919999999',
                orderDate: today.toISOString(), pickupDate: tomorrow.toISOString(),
                pickupLocation: 'Casa Mãe – Praça da Figueira 18B', total: 60, status: 'recebido', paid: true,
                type: 'particular',
                items: [{ itemId: 'BOLO_ANIV', name: 'Bolo de Aniversário', quantity: 2, unit: 'kg', price: 30, status: 'recebido', customFields: { nome_aniversariante: 'Parabéns', bolo_type: 'pao de lo normal', imagem_edivel: false } }],
                timestamps: { recebido: today.toISOString(), producao: null, terminado: null, levantado: null, entregue: null, cancelado: null }
            });
             demoOrders.push({
                id: `PF-${orderId++}`, clientName: 'Maria Cliente', clientPhone: '960000000',
                orderDate: today.toISOString(), pickupDate: dayAfter.toISOString(),
                pickupLocation: 'Belém – Av Brasília', total: 5.25, status: 'recebido', paid: false,
                type: 'particular',
                items: [{ itemId: 'TRANCA_CREME', name: 'Trança C/ Creme', quantity: 3, unit: 'unidade', price: 1.75, status: 'recebido', customFields: {} }],
                timestamps: { recebido: today.toISOString(), producao: null, terminado: null, levantado: null, entregue: null, cancelado: null }
            });
            
            // Revenda samples for today
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            demoOrders.push({
                id: `PF-${orderId++}`, clientName: 'MaxiPao', username: 'maxipao',
                orderDate: yesterday.toISOString(), pickupDate: today.toISOString(),
                pickupLocation: 'Fábrica – Campo de Ourique', total: 20, status: 'recebido', paid: false,
                type: 'revenda',
                items: [{ itemId: 'TRANCA_CREME', name: 'Trança C/ Creme', quantity: 10, unit: 'unid', price: 1.00, status: 'recebido', customFields: {} }],
                timestamps: { recebido: yesterday.toISOString(), producao: null, terminado: null, levantado: null, entregue: null, cancelado: null }
            });
            demoOrders.push({
                id: `PF-${orderId++}`, clientName: 'OutraRevenda', username: 'outra',
                orderDate: yesterday.toISOString(), pickupDate: today.toISOString(),
                pickupLocation: 'Fábrica – Campo de Ourique', total: 20, status: 'recebido', paid: false,
                type: 'revenda',
                items: [{ itemId: 'TRANCA_CREME', name: 'Trança C/ Creme', quantity: 10, unit: 'unid', price: 1.00, status: 'recebido', customFields: {} }],
                timestamps: { recebido: yesterday.toISOString(), producao: null, terminado: null, levantado: null, entregue: null, cancelado: null }
            });
            
            state.orders = demoOrders;
            state.nextOrderId = orderId;
        }

        // --- 3. PÁGINA CLIENTE (B2C) ---
        
        const productListContainer = document.getElementById('product-list-container');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartEmptyMsg = document.getElementById('cart-empty-msg');
        const cartTotalEl = document.getElementById('cart-summary-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const checkoutFormContainer = document.getElementById('checkout-form-container');
        const b2cForm = document.getElementById('form-b2c-checkout');
        const pickupDateInput = document.getElementById('b2c-data-levantamento');
        const pickupTimeInput = document.getElementById('b2c-hora-levantamento');
        const pickupDateNote = document.getElementById('pickup-date-note');
        const particularContent = document.getElementById('particular-content');
        const revendaLogin = document.getElementById('revenda-login');
        const revendaContent = document.getElementById('revenda-content');
        const revendaProductList = document.getElementById('revenda-product-list');
        const revendaSearch = document.getElementById('revenda-search');
        const revendaCountdown = document.getElementById('revenda-countdown');
        const revendaSubmit = document.getElementById('revenda-submit');
        const revendaLoginForm = document.getElementById('revenda-login-form');
        const revendaLoginError = document.getElementById('revenda-login-error');
        const modeToggle = document.getElementById('mode-toggle');

      function updateRevendaTotal() {
    let total = 0;
    // Loop pelos cartões de produto visíveis na página de revenda
    document.querySelectorAll('#revenda-product-list .product-card').forEach(card => {
        const qty = parseFloat(card.querySelector('.qty-input').value || 0);
        if (qty > 0) {
            const productId = card.dataset.productId;
            const product = findProduct(productId);
            if (product) {
                let price = product.price; // Preço base (pode ter sido alterado pelo dropdown 'tipo de bolo')
                
                // Verifica se tem campos customizados (Ex: imagem comestível)initClientPage
                const imgCheckbox = card.querySelector('[data-field-id="imagem_edivel"]');
                if (imgCheckbox && imgCheckbox.checked) {
                    price += 3; // Adiciona o extra da imagem
                }
                total += qty * price;
            }
        }
    });
    
    const totalEl = document.getElementById('revenda-summary-total');
    if (totalEl) {
        totalEl.textContent = `Total: ${formatCurrency(total)}`;
    }
}
      
       function initClientPage() {
    renderAllProducts();
    initPickupDatePicker();
    productListContainer.addEventListener('click', handleProductClick);
    cartItemsList.addEventListener('click', handleCartItemRemove);
    checkoutBtn.addEventListener('click', () => {
        checkoutFormContainer.style.display = 'block';
        checkoutFormContainer.scrollIntoView({ behavior: 'smooth' });
    });
    b2cForm.addEventListener('submit', handleOrderSubmit);
    pickupDateInput.addEventListener('change', initPickupDatePicker);
    modeToggle.addEventListener('click', handleModeToggle);
    revendaLoginForm.addEventListener('submit', handleRevendaLogin);
    revendaSearch.addEventListener('input', handleRevendaSearch);
    
    // REMOVIDO: revendaSubmit.addEventListener('click', handleRevendaSubmit);
    
    // ADICIONADO: Listener no contentor para o novo botão sticky
    revendaContent.addEventListener('click', (e) => {
        if (e.target.id === 'revenda-submit-sticky') {
            handleRevendaSubmit();
        }
    });

    revendaProductList.addEventListener('click', (e) => {
        handleAccordionClick(e);
        handleProductClick(e);
    });
    checkRevendaLogin();
}
function handleModeToggle(e) {
    const button = e.target.closest('button');
    if (!button) return;
    state.mode = button.dataset.mode;
    modeToggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    button.classList.add('active');
    particularContent.style.display = state.mode === 'particular' ? 'block' : 'none';
    revendaLogin.style.display = state.mode === 'revenda' && !localStorage.getItem('revendaUser') ? 'block' : 'none';
    revendaContent.style.display = state.mode === 'revenda' && localStorage.getItem('revendaUser') ? 'block' : 'none';
    checkoutFormContainer.style.display = 'none';
    checkoutBtn.disabled = true;
    state.cart = [];
    renderCart();
    if (state.mode === 'revenda') {
        renderRevendaProducts();
        startCountdown();
        updateRevendaTotal(); // <-- ADICIONA ESTA CHAMADA
    } else {
        renderAllProducts();
    }
}
function handleRevendaLogin(e) {
    e.preventDefault();
    const username = document.getElementById('revenda-username').value.toLowerCase();
    const password = document.getElementById('revenda-password').value;
    if (REVENDA_USERS[username] && REVENDA_USERS[username] === password) {
        localStorage.setItem('revendaUser', username);
        revendaLogin.style.display = 'none';
        revendaContent.style.display = 'block';
        renderRevendaProducts();
        startCountdown();
        updateRevendaTotal(); // <-- ADICIONA ESTA CHAMADA
        revendaLoginError.style.display = 'none';
    } else {
        revendaLoginError.style.display = 'block';
    }
}
      
function checkRevendaLogin() {
    const user = localStorage.getItem('revendaUser');
    if (user && REVENDA_USERS[user]) {
        revendaLogin.style.display = 'none';
        revendaContent.style.display = 'block';
        renderRevendaProducts();
        startCountdown();
        updateRevendaTotal(); // <-- ADICIONA ESTA CHAMADA
    }
}
        function startCountdown() {
            const updateCountdown = () => {
                const now = new Date();
                const deadline = new Date(now);
                deadline.setHours(19, 0, 0, 0);
                if (now > deadline) {
                    revendaCountdown.textContent = 'Prazo para encomenda de amanhã expirado.';
                    revendaSubmit.disabled = true;
                    return;
                }
                const diff = deadline - now;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                revendaCountdown.textContent = `Tempo restante para encomenda de amanhã: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (localStorage.getItem(`revendaOrderDone_${now.toDateString()}`)) {
                    revendaCountdown.textContent += ' (Encomenda já enviada hoje)';
                } else {
                    revendaCountdown.textContent += ' (Ainda não fez a sua encomenda para amanhã)';
                }
            };
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        function renderAllProducts() {
            let html = '';
            const catalog = PRODUCT_CATALOG[state.mode].natal || PRODUCT_CATALOG.particular.natal;
            html += '<h3> Especial Natal</h3>';
            catalog.forEach(p => html += createProductCard(p));
            
            const especiais = PRODUCT_CATALOG[state.mode].especiais || PRODUCT_CATALOG.particular.especiais;
            html += '<h3> Bolos Especiais</h3>';
            especiais.forEach(p => html += createProductCard(p));
            
            productListContainer.innerHTML = html;
        }

        function renderRevendaProducts(search = '') {
    let html = '';
    const catalog = PRODUCT_CATALOG.revenda;
    const sections = ['pastelaria', 'bolos_especiais', 'salgados', 'pao', 'natal', 'especiais'];
    sections.forEach(section => {
        let itemsHtml = '';
        catalog[section].forEach(p => {
            if (search && !removeAccents(p.name.toLowerCase()).includes(removeAccents(search.toLowerCase()))) return;
            itemsHtml += createProductCard(p, true);
        });
        if (itemsHtml) {
            html += `
                <div class="accordion-section">
                    <div class="accordion-header"># ${section.charAt(0).toUpperCase() + section.slice(1)}</div>
                    <div class="accordion-content">${itemsHtml}</div> 
                </div> 
            `; // <-- A CLASSE 'active' FOI REMOVIDA DAQUI
        }
    });
    revendaProductList.innerHTML = html;
}
        function handleRevendaSearch(e) {
            renderRevendaProducts(e.target.value);
        }

function handleAccordionClick(e) {
    const header = e.target.closest('.accordion-header');
    if (header) {
        header.classList.toggle('active'); // <-- ADICIONA ESTA LINHA
        const content = header.nextElementSibling;
        content.classList.toggle('active');
    }
}

        function createProductCard(product, isRevenda = false) {
            const isKg = product.unit.includes('kg');
            const step = product.step || 1;
            const min = product.min || (isKg ? 0.5 : 1);
            
            let customFieldsHtml = '';
            if (product.customFields) {
                customFieldsHtml = '<div class="bolo-aniversario-fields">';
                product.customFields.forEach(field => {
                    if (field.type === 'select') {
                        customFieldsHtml += `
                            <div class="form-group">
                                <label for="field-${product.id}-${field.id}">${field.label}</label>
                                <select id="field-${product.id}-${field.id}" data-field-id="${field.id}">
                                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            </div>`;
                    } else if (field.type === 'checkbox') {
                        customFieldsHtml += `
                            <div class="form-group">
                                <input type="checkbox" id="field-${product.id}-${field.id}" data-field-id="${field.id}">
                                <label for="field-${product.id}-${field.id}">${field.label}</label>
                            </div>`;
                    } else if (field.type === 'file') {
                        customFieldsHtml += `
                            <div class="form-group" id="upload-group-${product.id}" style="display: none;">
                                <label for="field-${product.id}-${field.id}">${field.label}</label>
                                <input type="file" id="field-${product.id}-${field.id}" data-field-id="${field.id}" accept="image/*">
                            </div>`;
                    } else if (field.type === 'textarea') {
                        customFieldsHtml += `
                            <div class="form-group">
                                <label for="field-${product.id}-${field.id}">${field.label}</label>
                                <textarea id="field-${product.id}-${field.id}" data-field-id="${field.id}" placeholder="${field.placeholder || ''}"></textarea>
                            </div>`;
                    } else {
                         customFieldsHtml += `
                            <div class="form-group">
                                <label for="field-${product.id}-${field.id}">${field.label}</label>
                                <input type="${field.type}" id="field-${product.id}-${field.id}" data-field-id="${field.id}" placeholder="${field.placeholder || ''}">
                            </div>`;
                    }
                });
                customFieldsHtml += '<p>Velas de oferta incluídas.</p></div>';
            }

            let imgHtml = product.img ? `
                <div class="product-image-thumb" data-img-src="${product.img}" data-img-alt="${product.name}">
                    <img src="${product.img}" alt="${product.name}">
                </div>` : `<div class="product-image-thumb">${product.name.charAt(0)}</div>`;

            return `
                <div class="product-card" id="form-${product.id}" data-product-id="${product.id}">
                    ${imgHtml}
                    
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <span class="product-price">${formatCurrency(product.price)} / ${product.unit}</span>
                        
                        <div class="product-actions">
                            <div class="quantity-stepper">
                                <button type="button" class="qty-minus" data-step="${step}" data-min="${min}">-</button>
                                <input type="number" value="${isRevenda && localStorage.getItem(`revenda_${product.id}`) || 0}" min="0" step="${step}" class="qty-input" ${isKg ? '' : 'readonly'}>
                                <button type="button" class="qty-plus" data-step="${step}" data-min="${min}">+</button>
                            </div>
                        </div>
                        
                        ${customFieldsHtml}
                        
                        ${!isRevenda ? '<button type="button" class="btn btn-secondary btn-add-cart" style="width: auto; padding: 8px 15px; font-size: 0.9rem; margin-top: 15px;">Adicionar</button>' : ''}
                    </div>
                </div>
            `;
        }
        
        function handleProductClick(e) {
    const target = e.target;
    if (target.closest('.product-image-thumb')) {
        const thumb = target.closest('.product-image-thumb');
        if(thumb.dataset.imgSrc) {
            showImageModal(thumb.dataset.imgSrc, thumb.dataset.imgAlt);
        }
    }

    const stepper = target.closest('.quantity-stepper');
    if (stepper) {
        const input = stepper.querySelector('.qty-input');
        const step = parseFloat(target.dataset.step || 1);
        const min = parseFloat(target.dataset.min || 0);
        let val = parseFloat(input.value);
        if (target.classList.contains('qty-plus')) {
            val = (val < min) ? min : val + step;
        } else if (target.classList.contains('qty-minus')) {
            val = Math.max(0, val - step);
        }
        input.value = (step < 1) ? val.toFixed(1) : val.toFixed(0);
        if (state.mode === 'revenda') {
            const productId = stepper.closest('.product-card').dataset.productId;
            if (val > 0) {
                localStorage.setItem(`revenda_${productId}`, val);
            } else {
                localStorage.removeItem(`revenda_${productId}`);
            }
            updateRevendaTotal(); // <-- ADICIONA ESTA CHAMADA
        }
    }

    if (target.classList.contains('btn-add-cart')) {
        const card = target.closest('.product-card');
        const productId = card.dataset.productId;
        const product = findProduct(productId);
        if (product) {
            const quantity = parseFloat(card.querySelector('.qty-input').value);
            if (quantity <= 0) {
                showToast("Por favor, adicione uma quantidade válida.");
                return;
            }
            let customFields = {};
            let customDesc = [];
            if (product.customFields) {
                card.querySelectorAll('.bolo-aniversario-fields [data-field-id]').forEach(field => {
                    if (field.type === 'checkbox') {
                        customFields[field.dataset.fieldId] = field.checked;
                        if (field.checked) customDesc.push(field.labels[0].textContent);
                    } else if (field.type === 'file') {
                        if (field.files[0] && field.files[0].size <= 10 * 1024 * 1024) {
                            const reader = new FileReader();
                            reader.onload = () => {
                                customFields[field.dataset.fieldId] = reader.result;
                            };
                            reader.readAsDataURL(field.files[0]);
                        }
                    } else if (field.value) {
                        customFields[field.dataset.fieldId] = field.value;
                        customDesc.push(`${field.labels[0].textContent}: ${field.value}`);
                    }
                });
            }
            card.querySelector('.qty-input').value = 0;
            addToCart(product, quantity, customFields, customDesc.join(', '));
        }
    }

    if (target.dataset.fieldId === 'bolo_type') {
        const card = target.closest('.product-card');
        const productId = card.dataset.productId;
        const product = findProduct(productId);
        const priceEl = card.querySelector('.product-price');
        const newPrice = product.types[target.value];
        product.price = newPrice; // Isto atualiza o preço na referência do catálogo
        priceEl.textContent = `${formatCurrency(newPrice)} / ${product.unit}`;
        if (state.mode === 'revenda') updateRevendaTotal(); // <-- ADICIONA ESTA CHAMADA
    }

    if (target.dataset.fieldId === 'imagem_edivel') {
        const card = target.closest('.product-card');
        const uploadGroup = card.querySelector(`#upload-group-${card.dataset.productId}`);
        uploadGroup.style.display = target.checked ? 'block' : 'none';
        if (state.mode === 'revenda') updateRevendaTotal(); // <-- ADICIONA ESTA CHAMADA
    }
}
      
        function findProduct(id) {
            const modeCatalog = PRODUCT_CATALOG[state.mode];
            for (let section in modeCatalog) {
                const prod = modeCatalog[section].find(p => p.id === id);
                if (prod) return prod;
            }
            return null;
        }

        function getCartId(product, customDesc) {
            const customId = customDesc ? customDesc.replace(/[\s,:]/g, '').toLowerCase() : '';
            return `${product.id}_${customId}`;
        }

        function addToCart(product, quantity, customFields, customDesc) {
            const cartId = getCartId(product, customDesc);
            const existingItem = state.cart.find(item => item.cartId === cartId);
            
            if (existingItem) {
                existingItem.quantity = parseFloat(existingItem.quantity) + parseFloat(quantity);
                showToast(`Quantidade atualizada para ${existingItem.quantity}x ${product.name}.`);
            } else {
                const cartItem = {
                    cartId: cartId, id: product.id, name: product.name,
                    quantity: quantity, unit: product.unit.split(' ')[0],
                    price: product.price, customFields: customFields, customDesc: customDesc
                };
                state.cart.push(cartItem);
                showToast(`${quantity}x ${product.name} adicionado ao carrinho.`);
            }
            
            renderCart();
        }
        
        function handleCartItemRemove(e) {
            if (e.target.classList.contains('cart-item-remove')) {
                const cartId = e.target.dataset.cartId;
                state.cart = state.cart.filter(item => item.cartId !== cartId);
                renderCart();
                showToast("Item removido do carrinho.");
            }
        }

        function renderCart() {
            if (state.cart.length === 0) {
                cartItemsList.innerHTML = '';
                cartEmptyMsg.style.display = 'block';
                cartTotalEl.textContent = 'Total: 0.00€';
                checkoutBtn.disabled = true;
                checkoutFormContainer.style.display = 'none';
                return;
            }
            
            cartEmptyMsg.style.display = 'none';
            let html = '';
            let total = 0;
            
            state.cart.forEach(item => {
                let itemPrice = item.price;
                if (item.customFields.imagem_edivel) itemPrice += 3;
                const itemTotal = itemPrice * item.quantity;
                total += itemTotal;
                
                const qtyDisplay = item.unit === 'kg' ? `${item.quantity} kg` : `${item.quantity}x`;
                
                html += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <strong>${qtyDisplay} ${item.name}</strong>
                            <span>${formatCurrency(itemTotal)}</span>
                            ${item.customDesc ? `<span>${item.customDesc}</span>` : ''}
                        </div>
                        <button class="cart-item-remove" data-cart-id="${item.cartId}">&times;</button>
                    </div>
                `;
            });
            
            cartItemsList.innerHTML = html;
            cartTotalEl.textContent = `Total: ${formatCurrency(total)}`;
            checkoutBtn.disabled = false;
        }
        
        function getMinPickupDate() {
            const now = new Date();
            const minDate = new Date();
            const cutoffHour = 15;
            
            if (now.getHours() >= cutoffHour) {
                minDate.setDate(minDate.getDate() + 2);
            } else {
                minDate.setDate(minDate.getDate() + 1);
            }
            minDate.setHours(0, 0, 0, 0);
            return minDate;
        }

        function initPickupDatePicker() {
            const minDate = getMinPickupDate();
            const minDateString = minDate.toISOString().split('T')[0];
            
            pickupDateInput.min = minDateString;
            
            const now = new Date();
            const cutoffHour = 15;
            if (now.getHours() >= cutoffHour) {
                pickupDateNote.textContent = 'Encomendas após as 15h, levantamento a partir de depois de amanhã.';
            } else {
                pickupDateNote.textContent = 'Encomendas antes das 15h, levantamento a partir de amanhã.';
            }
        }
        
        function handleOrderSubmit(e) {
            e.preventDefault();
            
            const selectedDateStr = pickupDateInput.value;
            const selectedTimeStr = pickupTimeInput.value;
            
            if (!selectedDateStr || !selectedTimeStr) {
                showToast("Por favor, preencha a data e hora de levantamento.");
                return;
            }
            
            const selectedDate = new Date(selectedDateStr + "T00:00:00");
            const minDate = getMinPickupDate();

            if (selectedDate < minDate) {
                showToast("Data de levantamento inválida. Por favor, verifique as regras.");
                initPickupDatePicker();
                return;
            }
            
            if (selectedTimeStr < "08:00" || selectedTimeStr > "20:00") {
                showToast("Hora de levantamento inválida. (Disponível das 08:00 às 20:00)");
                return;
            }

            const orderId = `PF-${state.nextOrderId}`;
            state.nextOrderId++;
            
            let total = state.cart.reduce((sum, item) => {
                let price = item.price;
                if (item.customFields.imagem_edivel) price += 3;
                return sum + (price * item.quantity);
            }, 0);
            const orderDateISO = new Date().toISOString();
            const clientPhone = document.getElementById('b2c-telemovel').value;
            
            const newOrder = {
                id: orderId,
                clientName: document.getElementById('b2c-nome-cliente').value,
                clientPhone: clientPhone,
                orderDate: orderDateISO,
                pickupDate: `${selectedDateStr}T${selectedTimeStr}:00`,
                pickupLocation: document.getElementById('b2c-pickup-location').value,
                clientCode: document.getElementById('b2c-codigo-cliente').value || 'N/A',
                total: total,
                status: 'recebido',
                paid: false,
                type: 'particular',
                items: state.cart.map(cartItem => ({
                    itemId: cartItem.id, name: cartItem.name, quantity: cartItem.quantity,
                    unit: cartItem.unit, price: cartItem.price, status: 'recebido',
                    customFields: cartItem.customFields
                })),
                timestamps: {
                    recebido: orderDateISO, producao: null, terminado: null,
                    levantado: null, entregue: null, cancelado: null
                }
            };

            state.orders.push(newOrder);
            saveState();
            
            localStorage.setItem('currentUserPhone', clientPhone);
            
            state.cart = [];
            renderCart();
            b2cForm.reset();
            initPickupDatePicker();
            checkoutFormContainer.style.display = 'none';
            
            showToast(`Encomenda #${orderId} recebida! Pode vê-la em "As Minhas".`);
            launchConfetti();
        }

function handleRevendaSubmit() {
    const orderId = `PF-${state.nextOrderId}`;
    state.nextOrderId++;
    const today = new Date().toDateString();
    localStorage.setItem(`revendaOrderDone_${today}`, true);
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const items = [];
    // A lógica de ler do DOM está correta e é consistente com updateRevendaTotal
    revendaProductList.querySelectorAll('.qty-input').forEach(input => {
        const qty = parseFloat(input.value);
        if (qty > 0) {
            const card = input.closest('.product-card');
            const productId = card.dataset.productId;
            const product = findProduct(productId);
            
            let customFields = {};
            let itemPrice = product.price; // Preço atualizado pelo dropdown

            if (product.customFields) {
                card.querySelectorAll('.bolo-aniversario-fields [data-field-id]').forEach(field => {
                    if (field.type === 'checkbox') {
                        customFields[field.dataset.fieldId] = field.checked;
                        if (field.dataset.fieldId === 'imagem_edivel' && field.checked) {
                            itemPrice += 3; // Adiciona preço da imagem aqui
                        }
                    } else if (field.type === 'file') {
                        // ... (lógica de file... nota: isto é assíncrono, pode falhar no submit)
                        // Assumindo que o upload não é crítico para o preço, exceto o checkbox
                    } else if (field.value) {
                        customFields[field.dataset.fieldId] = field.value;
                    }
                });
            }
            
            items.push({
                itemId: productId,
                name: product.name,
                quantity: qty,
                unit: product.unit.split(' ')[0],
                price: product.price, // Grava o preço base
                status: 'recebido',
                customFields: customFields // Grava os campos custom
            });
        }
    });

    // O cálculo do Total no 'handleRevendaSubmit' original estava ligeiramente diferente
    // Vamos corrigir para ser 100% igual ao que o updateRevendaTotal calcula
    const total = items.reduce((sum, item) => {
        let price = item.price; // Preço base
        if (item.customFields.imagem_edivel) {
            price += 3; // Adiciona extra
        }
        return sum + (price * item.quantity);
    }, 0);

    const user = localStorage.getItem('revendaUser');
    const newOrder = {
        id: orderId,
        clientName: user.charAt(0).toUpperCase() + user.slice(1),
        username: user,
        orderDate: new Date().toISOString(),
        pickupDate: tomorrow.toISOString(),
        pickupLocation: 'Fábrica – Campo de Ourique',
        clientCode: 'N/A',
        total: total, // USA O TOTAL CORRIGIDO
        status: 'recebido',
        paid: false,
        type: 'revenda',
        items: items,
        timestamps: { recebido: new Date().toISOString(), producao: null, terminado: null, levantado: null, entregue: null, cancelado: null }
    };
    
    state.orders.push(newOrder);
    saveState();
    showToast(`Encomenda #${orderId} enviada com sucesso!`);
    launchConfetti();
    
    revendaProductList.querySelectorAll('.qty-input').forEach(input => input.value = 0);
    // Limpa o localStorage para a próxima encomenda
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith('revenda_')) {
            localStorage.removeItem(key);
        }
    });
    
    startCountdown(); // Reinicia o countdown
    updateRevendaTotal(); // <-- ADICIONA ESTA CHAMADA (vai resetar para 0.00€)
}
        // --- 4. PÁGINA "MINHAS ENCOMENDAS" (NOVO) ---
        
        const myOrdersPage = document.getElementById('page-my-orders');
        const myOrdersLogin = document.getElementById('my-orders-login');
        const myOrdersLoginForm = document.getElementById('my-orders-login-form');
        const myOrdersLoginInput = document.getElementById('my-orders-phone-input');
        const myOrdersListContainer = document.getElementById('my-orders-list-container');
        const myOrdersList = document.getElementById('my-orders-list');
        const myOrdersPhoneDisplay = document.getElementById('my-orders-phone-display');
        const myOrdersLogoutBtn = document.getElementById('my-orders-logout-btn');

        function initMyOrdersPage() {
            myOrdersLoginForm.addEventListener('submit', handleMyOrdersLogin);
            myOrdersLogoutBtn.addEventListener('click', handleMyOrdersLogout);
            renderMyOrdersPage();
        }

        function handleMyOrdersLogin(e) {
            e.preventDefault();
            const phone = myOrdersLoginInput.value;
            if (phone) {
                localStorage.setItem('currentUserPhone', phone);
                renderMyOrdersPage();
            }
        }

        function handleMyOrdersLogout() {
            localStorage.removeItem('currentUserPhone');
            myOrdersLoginInput.value = '';
            renderMyOrdersPage();
        }

        function renderMyOrdersPage() {
            const phone = localStorage.getItem('currentUserPhone');
            
            if (!phone) {
                myOrdersLogin.style.display = 'block';
                myOrdersListContainer.style.display = 'none';
            } else {
                myOrdersLogin.style.display = 'none';
                myOrdersListContainer.style.display = 'block';
                myOrdersPhoneDisplay.textContent = phone;
                
                const clientOrders = state.orders
                    .filter(o => o.clientPhone === phone)
                    .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                    
                if (clientOrders.length === 0) {
                    myOrdersList.innerHTML = '<p class="card">Ainda não tem encomendas registadas com este número.</p>';
                    return;
                }
                
                myOrdersList.innerHTML = clientOrders.map(createMyOrderTicket).join('');
            }
        }
        
        function createMyOrderTicket(order) {
            const pickupDate = new Date(order.pickupDate);
            
            const statusMap = {
                recebido: 'Recebida',
                producao: 'Em Produção',
                terminado: 'Pronta a Levantar',
                levantado: 'Levantada',
                entregue: 'Entregue',
                cancelado: 'Cancelada'
            };
            
            return `
            <div class="card order-ticket my-order-ticket status-${order.status}">
                <div class="ticket-header">
                    <strong>Encomenda #${order.id}</strong>
                    <span class="ticket-id" style="color: var(--theme-primary); font-weight: 700;">${statusMap[order.status] || order.status}</span>
                </div>
                <div class="ticket-details">
                    <p><strong>Levantamento:</strong> ${formatDateTime(pickupDate)}</p>
                    <p><strong>Local:</strong> ${order.pickupLocation}</p>
                    <p><strong>Total:</strong> ${formatCurrency(order.total)}</p>
                    <p><strong>Pagamento:</strong> <span style="font-weight: 700; color: ${order.paid ? 'var(--status-terminado)' : 'var(--status-cancelado)'}">${order.paid ? 'Pago' : 'Pendente'}</span></p>
                </div>
                <div class="ticket-items">
                    <strong>Itens:</strong>
                    <ul class="ticket-items-list" style="max-height: none; list-style-type: none; padding-left: 0;">
                        ${order.items.map(item => {
                            const qtyDisplay = item.unit === 'kg' ? `${item.quantity} kg` : `${item.quantity}x`;
                            return `<li>- ${qtyDisplay} ${item.name}</li>`;
                        }).join('')}
                    </ul>
                </div>
            </div>`;
        }

        // --- 5. PÁGINA STAFF ---
        
        const staffOrderList = document.getElementById('staff-order-list');
        const noOrdersMsg = document.getElementById('no-orders-message');
        const staffViewItemBtn = document.getElementById('staff-view-item-btn');
        const staffViewOrderBtn = document.getElementById('staff-view-order-btn');
        const staffModeParticularBtn = document.getElementById('staff-view-particular-btn');
        const staffModeRevendaBtn = document.getElementById('staff-view-revenda-btn');
        
        const staffSearchInput = document.getElementById('staff-search-input');
        const staffFilterStatus = document.getElementById('staff-filter-status');
        const staffSortBy = document.getElementById('staff-sort-by');
        const staffFilterPickupDate = document.getElementById('staff-filter-pickup-date');
        const staffFilterOrderDate = document.getElementById('staff-filter-order-date');
        const staffSubtotal = document.getElementById('staff-subtotal');

        function initStaffPage() {
            staffFilterStatus.value = 'all_active';
            staffSortBy.value = 'pickupDateAsc';
            
            staffViewItemBtn.addEventListener('click', () => setStaffView('item'));
            staffViewOrderBtn.addEventListener('click', () => setStaffView('order'));
            staffModeParticularBtn.addEventListener('click', () => setStaffMode('particular'));
            staffModeRevendaBtn.addEventListener('click', () => setStaffMode('revenda'));
            
            [staffSearchInput, staffFilterStatus, staffSortBy, staffFilterPickupDate, staffFilterOrderDate].forEach(el => {
                el.addEventListener('input', renderStaffPage);
            });
            
            staffOrderList.addEventListener('click', handleStaffTicketClick);
            
            renderStaffPage();
        }
        
        function setStaffView(view) {
            state.staffView = view;
            staffViewItemBtn.classList.toggle('active', view === 'item');
            staffViewOrderBtn.classList.toggle('active', view === 'order');
            renderStaffPage();
        }
        
        function setStaffMode(mode) {
            state.staffMode = mode;
            staffModeParticularBtn.classList.toggle('active', mode === 'particular');
            staffModeRevendaBtn.classList.toggle('active', mode === 'revenda');
            renderStaffPage();
        }

        function getFilteredAndSortedData() {
            const search = staffSearchInput.value.toLowerCase();
            const status = staffFilterStatus.value;
            const sort = staffSortBy.value;
            const pickupDate = staffFilterPickupDate.value;
            const orderDate = staffFilterOrderDate.value;
            
            let data = [];
            
            let filteredOrders = state.orders.filter(o => o.type === state.staffMode);
            if (state.staffMode === 'revenda') {
                const todayStr = new Date().toISOString().split('T')[0];
                filteredOrders = filteredOrders.filter(o => o.pickupDate.startsWith(todayStr));
            }

            if (state.staffView === 'order') {
                data = filteredOrders;
            } else {
                let aggregated = {};
                filteredOrders.forEach(order => {
                    order.items.forEach(item => {
                        if (!aggregated[item.name]) {
                            aggregated[item.name] = { ...item, quantity: 0, orders: [] };
                        }
                        aggregated[item.name].quantity += item.quantity;
                        aggregated[item.name].orders.push(order);
                    });
                });
                data = Object.values(aggregated);
            }
            
            let filteredData = data.filter(d => {
                const clientName = (d.clientName || '').toLowerCase();
                if (search && !clientName.includes(search)) return false;
                
                const itemStatus = d.status;
                if (status === 'all_active' && (itemStatus === 'levantado' || itemStatus === 'entregue' || itemStatus === 'cancelado')) return false;
                else if (status !== 'all' && status !== 'all_active' && itemStatus !== status) return false;
                
                if (pickupDate && !d.pickupDate.startsWith(pickupDate)) return false;
                
                if (orderDate && !d.orderDate.startsWith(orderDate)) return false;
                
                return true;
            });
            
            filteredData.sort((a, b) => {
                switch (sort) {
                    case 'pickupDateAsc': return new Date(a.pickupDate) - new Date(b.pickupDate);
                    case 'pickupDateDesc': return new Date(b.pickupDate) - new Date(a.pickupDate);
                    case 'orderDateAsc': return new Date(a.orderDate) - new Date(b.orderDate);
                    case 'orderDateDesc': return new Date(b.orderDate) - new Date(a.orderDate);
                    default: return new Date(a.pickupDate) - new Date(b.pickupDate);
                }
            });
            
            return filteredData;
        }

        function renderStaffPage() {
            const data = getFilteredAndSortedData();
            
            if (data.length === 0) {
                staffOrderList.innerHTML = '';
                staffOrderList.appendChild(noOrdersMsg.cloneNode(true));
                staffSubtotal.textContent = '';
                return;
            }
            
            let html = '';
            let subtotalPaid = 0;
            let subtotalUnpaid = 0;
            if (state.staffView === 'order') {
                data.forEach(order => {
                    html += createOrderTicket(order);
                    const total = order.total;
                    if (order.paid) subtotalPaid += total;
                    else subtotalUnpaid += total;
                });
            } else {
                data.forEach(item => html += createItemTicket(item));
            }
            staffOrderList.innerHTML = html;
            staffSubtotal.textContent = `Subtotal: Pagos ${formatCurrency(subtotalPaid)} | Não Pagos ${formatCurrency(subtotalUnpaid)} | Total ${formatCurrency(subtotalPaid + subtotalUnpaid)}`;
        }

      function createOrderTicket(order) {
    const orderDate = new Date(order.orderDate);
    const pickupDate = new Date(order.pickupDate);
    const needsExpansion = order.items.length > 3;

    // Lógica condicional para formato da data
    const pickupDateStr = (order.type === 'revenda')
        ? formatDate(pickupDate)
        : formatDateTime(pickupDate);

    return `
        <div class="card order-ticket status-${order.status}" data-order-id="${order.id}">
            <div class="ticket-header">
                <strong>${order.clientName || order.username}</strong>
                <span class="ticket-id">#${order.id}</span>
            </div>
            <div class="ticket-details">
                <p><strong>Levantamento:</strong> ${pickupDateStr}</p> <p><strong>Encomenda:</strong> ${formatDateTime(orderDate)}</p>
                <p><strong>Contacto:</strong> ${order.clientPhone || ''}</p>
                <p><strong>Pagamento:</strong> <span style="font-weight: 700; color: ${order.paid ? 'var(--status-terminado)' : 'var(--status-cancelado)'}">${order.paid ? 'Pago' : 'Pendente'}</span></p>
                <p><strong>Total:</strong> ${formatCurrency(order.total)}</p>
            </div>
            <div class="ticket-items">
                <strong>Itens (${order.items.length}):</strong>
                <ul class="ticket-items-list ${needsExpansion ? 'expandable' : ''}">
                    ${order.items.map(item => {
                        const qtyDisplay = item.unit === 'kg' ? `${item.quantity} kg` : `${item.quantity}x`;
                        let customHtml = '';
                        if (item.customFields.upload_imagem) {
                            customHtml = `<button data-action="view-image" data-src="${item.customFields.upload_imagem}">Ver Imagem</button> <a href="${item.customFields.upload_imagem}" download>Download</a>`;
                        }
                        return `
                            <li>
                                ${qtyDisplay} ${item.name}
                                <span class="item-status item-status-${item.status}">${item.status}</span>
                                ${customHtml}
                            </li>
                        `}).join('')}
                </ul>
                ${needsExpansion ? '<button class="expand-items-btn" data-action="expand-items">[Ver Todos]</button>' : ''}
            </div>
            <div class="order-status-segmented">
                <button data-action="set-status" data-status="recebido" class="${order.status === 'recebido' ? 'active' : ''}">Recebido</button>
                <button data-action="set-status" data-status="producao" class="${order.status === 'producao' ? 'active' : ''}">Produção</button>
                <button data-action="set-status" data-status="terminado" class="${order.status === 'terminado' ? 'active' : ''}">Terminado</button>
                <button data-action="set-status" data-status="levantado" class="${order.status === 'levantado' ? 'active' : ''}">Levantado</button>
                <button data-action="set-status" data-status="entregue" class="${order.status === 'entregue' ? 'active' : ''}">Entregue</button>
                <button data-action="set-status" data-status="cancelado" class="${order.status === 'cancelado' ? 'active' : ''}">x</button>
            </div>
            <div class="ticket-status-control">
                <button class="btn ${order.paid ? 'btn-secondary' : 'btn-primary'}" data-action="toggle-paid">
                    ${order.paid ? 'Marcar Pendente' : 'Marcar Pago'}
                </button>
            </div>
        </div>`;
}

      function createItemTicket(item) {
    // CORREÇÃO DE BUG: O item agregado não tem 'pickupDate' ou 'orderDate'
    // Temos de ir buscá-los à primeira encomenda (orders[0])
    const firstOrder = item.orders[0];
    const pickupDate = new Date(firstOrder.pickupDate);
    const orderType = firstOrder.type; // Precisamos do tipo da encomenda

    const qtyDisplay = item.unit === 'kg' ? `${item.quantity} kg` : `${item.quantity}x`;

    // Lógica condicional para formato da data
    const pickupDateStr = (orderType === 'revenda')
        ? formatDate(pickupDate)
        : formatDateTime(pickupDate);

    return `
        <div class="card order-ticket status-${item.status}" data-order-id="${firstOrder.id}" data-item-id="${item.itemId}" data-item-name="${item.name}">
            <div class="ticket-header">
                <strong>${qtyDisplay} ${item.name}</strong>
                <span class="ticket-id">Item da Enc. #${firstOrder.id}</span>
            </div>
            <div class="ticket-details">
                <p><strong>Cliente:</strong> ${item.orders.map(o => o.clientName).join(', ')}</p>
                <p><strong>Levantamento:</strong> ${pickupDateStr}</p> <p><strong>Pagamento:</strong> <span style="font-weight: 700; color: ${firstOrder.paid ? 'var(--status-terminado)' : 'var(--status-cancelado)'}">${firstOrder.paid ? 'Pago' : 'Pendente'}</span></p>
                ${item.customFields && Object.keys(item.customFields).length > 0 ? `<p><strong>Obs:</strong> ${Object.values(item.customFields).join(', ')}</p>` : ''}
            </div>
            <div class="order-status-segmented">
                <button data-action="set-status" data-status="recebido" class="${item.status === 'recebido' ? 'active' : ''}">Recebido</button>
                <button data-action="set-status" data-status="producao" class="${item.status === 'producao' ? 'active' : ''}">Produção</button>
                <button data-action="set-status" data-status="terminado" class="${item.status === 'terminado' ? 'active' : ''}">Terminado</button>
                <button data-action="set-status" data-status="levantado" class="${item.status === 'levantado' ? 'active' : ''}">Levantado</button>
                <button data-action="set-status" data-status="entregue" class="${item.status === 'entregue' ? 'active' : ''}">Entregue</button>
                <button data-action="set-status" data-status="cancelado" class="${item.status === 'cancelado' ? 'active' : ''}">Cancelado</button>
            </div>
        </div>`;
}
        
        function handleStaffTicketClick(e) {
            const action = e.target.dataset.action;
            const card = e.target.closest('.order-ticket');
            if (!action || !card) return;
            
            const orderId = card.dataset.orderId;
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            
            if (action === 'expand-items') {
                const list = card.querySelector('.ticket-items-list');
                list.classList.toggle('expanded');
                list.classList.remove('expandable');
                e.target.textContent = list.classList.contains('expanded') ? '[Esconder]' : '[Ver Todos]';
                return;
            }
            
            if (action === 'toggle-paid') {
                order.paid = !order.paid;
                showToast(`Pagamento da #${orderId} atualizado para "${order.paid ? 'Pago' : 'Pendente'}".`);
            }
            
            if (action === 'set-status') {
                const newStatus = e.target.dataset.status;
                
                if (state.staffView === 'order') {
                    order.status = newStatus;
                    if (!order.timestamps[newStatus]) order.timestamps[newStatus] = new Date().toISOString();
                    
                    order.items.forEach(item => {
                        if (item.status !== 'cancelado' && item.status !== 'levantado' && item.status !== 'entregue') {
                           item.status = newStatus;
                        }
                    });
                    showToast(`Encomenda #${orderId} atualizada para "${newStatus}".`);
                
                } else {
                    const itemId = card.dataset.itemId;
                    const itemName = card.dataset.itemName;
                    
                    const item = order.items.find(i => i.itemId === itemId && i.name === itemName);
                    
                    if(item) {
                        item.status = newStatus;
                        if(newStatus === 'producao' && !order.timestamps.producao) order.timestamps.producao = new Date().toISOString();
                    }
                    
                    updateOrderStatusFromItems(order);
                    showToast(`Item ${item.name} da #${orderId} atualizado para "${newStatus}".`);
                }
            }

            if (action === 'view-image') {
                showImageModal(e.target.dataset.src, 'Imagem do Bolo');
            }
            
            saveState();
            renderStaffPage();
        }
        
        function updateOrderStatusFromItems(order) {
            const itemStatuses = order.items.map(i => i.status);
            
            if (itemStatuses.every(s => s === 'levantado' || s === 'entregue')) order.status = 'levantado';
            else if (itemStatuses.every(s => s === 'terminado' || s === 'levantado' || s === 'entregue')) order.status = 'terminado';
            else if (itemStatuses.some(s => s === 'producao')) order.status = 'producao';
            else if (itemStatuses.every(s => s === 'recebido')) order.status = 'recebido';

            if(order.status === 'terminado' && !order.timestamps.terminado) order.timestamps.terminado = new Date().toISOString();
            if(order.status === 'levantado' && !order.timestamps.levantado) order.timestamps.levantado = new Date().toISOString();
            if(order.status === 'entregue' && !order.timestamps.entregue) order.timestamps.entregue = new Date().toISOString();
        }

        // --- 6. PÁGINA ADMIN ---
        
        const adminFilterDate = document.getElementById('admin-filter-date');
        const adminFilterStatus = document.getElementById('admin-filter-status');
        const adminFilterItem = document.getElementById('admin-filter-item');
        const adminFilterClient = document.getElementById('admin-filter-client');
        const adminFilterLocation = document.getElementById('admin-filter-location');
        const adminExportBtn = document.getElementById('admin-export-csv');

        function initAdminPage() {
            adminFilterDate.value = ''; 
            
            populateAdminFilters();
            
            const filters = [adminFilterDate, adminFilterStatus, adminFilterItem, adminFilterClient, adminFilterLocation];
            filters.forEach(f => f.addEventListener('change', () => {
                state.adminFilters.chartViewDate = new Date(adminFilterDate.value || new Date());
                renderAdminDashboard();
            }));
            
            adminExportBtn.addEventListener('click', exportDataToCSV);
            
            document.getElementById('admin-chart-week-prev').addEventListener('click', () => navigateChart('week', -1));
            document.getElementById('admin-chart-week-next').addEventListener('click', () => navigateChart('week', 1));
            document.getElementById('admin-chart-month-prev').addEventListener('click', () => navigateChart('month', -1));
            document.getElementById('admin-chart-month-next').addEventListener('click', () => navigateChart('month', 1));

            renderAdminDashboard();
        }
        
        function navigateChart(unit, direction) {
            const d = state.adminFilters.chartViewDate;
            if (unit === 'week') {
                d.setDate(d.getDate() + (7 * direction));
            } else if (unit === 'month') {
                d.setMonth(d.getMonth() + direction);
            }
            state.adminFilters.chartViewDate = new Date(d);
            renderCharts();
        }

        function populateAdminFilters() {
            const itemNames = new Set();
            const clientNames = new Set();
            
            state.orders.forEach(order => {
                clientNames.add(order.clientName);
                order.items.forEach(item => itemNames.add(item.name));
            });
            
            adminFilterItem.innerHTML = '<option value="all">Todos os Itens</option>';
            [...itemNames].sort().forEach(name => {
                adminFilterItem.innerHTML += `<option value="${name}">${name}</option>`;
            });
            
            adminFilterClient.innerHTML = '<option value="all">Todos os Clientes</option>';
            [...clientNames].sort().forEach(name => {
                adminFilterClient.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
        
        function getFilteredAdminOrders() {
            const date = adminFilterDate.value;
            const status = adminFilterStatus.value;
            const item = adminFilterItem.value;
            const client = adminFilterClient.value;
            const location = adminFilterLocation.value;
            
            return state.orders.filter(order => {
                if (date && !order.pickupDate.startsWith(date)) return false;
                
                if (status !== 'all') {
                    if (status === 'pago' && !order.paid) return false;
                    if (status !== 'pago' && order.status !== status) return false;
                }
                
                if (client !== 'all' && order.clientName !== client) return false;
                
                if (location !== 'all' && order.pickupLocation !== location) return false;
                
                if (item !== 'all' && !order.items.some(i => i.name === item)) return false;
                
                return true;
            });
        }

        function renderAdminDashboard() {
            const filteredOrders = getFilteredAdminOrders();
            
            const totalRevenue = filteredOrders.reduce((sum, o) => sum + o.total, 0);
            const totalOrders = filteredOrders.length;
            const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            document.getElementById('admin-kpi-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('admin-kpi-orders').textContent = totalOrders;
            document.getElementById('admin-kpi-avg-ticket').textContent = formatCurrency(avgTicket);
            
            const canceledOrders = filteredOrders.filter(o => o.status === 'cancelado').length;
            const wastePerc = totalOrders > 0 ? (canceledOrders / totalOrders) * 100 : 0;
            
            document.getElementById('admin-kpi-waste').textContent = `${wastePerc.toFixed(0)}%`;
            document.getElementById('admin-kpi-waste-sub').textContent = `${canceledOrders} / ${totalOrders}`;
            
            const fullTimes = [], prodTimes = [];
            let lateProd = 0, notPicked = 0;
            const now = new Date();
            
            filteredOrders.forEach(o => {
                if (o.timestamps.recebido && o.timestamps.terminado) {
                    fullTimes.push(new Date(o.timestamps.terminado) - new Date(o.timestamps.recebido));
                }
                if (o.timestamps.producao && o.timestamps.terminado) {
                    prodTimes.push(new Date(o.timestamps.terminado) - new Date(o.timestamps.producao));
                }
                if (o.timestamps.terminado && new Date(o.timestamps.terminado) > new Date(o.pickupDate)) {
                    lateProd++;
                }
                if (now > new Date(o.pickupDate) && o.status !== 'levantado' && o.status !== 'entregue' && o.status !== 'cancelado') {
                    notPicked++;
                }
            });

            document.getElementById('admin-kpi-time-full').textContent = formatAvgTime(fullTimes);
            document.getElementById('admin-kpi-time-prod').textContent = formatAvgTime(prodTimes);
            document.getElementById('admin-kpi-time-deadline').textContent = totalOrders > 0 ? `${((lateProd / totalOrders) * 100).toFixed(0)}%` : '0%';
            document.getElementById('admin-kpi-time-pickup').textContent = totalOrders > 0 ? `${((notPicked / totalOrders) * 100).toFixed(0)}%` : '0%';

            renderCharts();
        }
        
        function renderCharts() {
            const viewDate = state.adminFilters.chartViewDate;
            
            const weekStart = new Date(viewDate);
            weekStart.setDate(viewDate.getDate() - viewDate.getDay());
            const weekData = [];
            const weekLabels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            for(let i=0; i<7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const dayStr = d.toISOString().split('T')[0];
                const dayTotal = state.orders
                    .filter(o => o.pickupDate.startsWith(dayStr))
                    .reduce((sum, o) => sum + o.total, 0);
                weekData.push({ label: weekLabels[i], value: dayTotal });
            }
            
            document.getElementById('admin-chart-week-title').textContent = `Receita (€) - Semana de ${weekStart.toLocaleDateString('pt-PT', {day:'2-digit', month:'2-digit'})}`;
            renderChart('admin-chart-week', weekData);

            const monthStart = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const monthData = [];
            
            for(let i=1; i<=daysInMonth; i++) {
                const d = new Date(monthStart);
                d.setDate(i);
                const dayStr = d.toISOString().split('T')[0];
                const dayTotal = state.orders
                    .filter(o => o.pickupDate.startsWith(dayStr))
                    .reduce((sum, o) => sum + o.total, 0);
                monthData.push({ label: `${i}`, value: dayTotal });
            }

            document.getElementById('admin-chart-month-title').textContent = `Receita (€) - ${monthStart.toLocaleString('pt-PT', { month: 'long', year: 'numeric' })}`;
            renderChart('admin-chart-month', monthData);
        }
        
        function renderChart(containerId, data) {
            const container = document.getElementById(containerId);
            const maxValue = Math.max(10, ...data.map(d => d.value));
            let html = '';
            
            data.forEach(bar => {
                const height = maxValue > 0 ? (bar.value / maxValue) * 100 : 0;
                html += `
                    <div class="chart-bar" style="height: ${height.toFixed(0)}%;">
                        <span class="bar-value">${bar.value > 1 ? formatCurrency(bar.value, 0) : ''}</span>
                        <span class="bar-label">${bar.label}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function exportDataToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            const headers = [
                "OrderID", "Tipo", "Cliente", "Telemovel", "Username", "Data Encomenda", "Data Levantamento", 
                "Local", "Status", "Pago", "Total", "ItemID", "ItemNome", "Quantidade", 
                "Unidade", "ItemStatus", "CustomFields"
            ];
            csvContent += headers.join(";") + "\r\n";
            
            state.orders.forEach(order => {
                order.items.forEach(item => {
                    const row = [
                        order.id, order.type, `"${order.clientName}"`, order.clientPhone || '',
                        order.username || '', order.orderDate, order.pickupDate, `"${order.pickupLocation}"`,
                        order.status, order.paid, order.total, item.itemId,
                        `"${item.name}"`, item.quantity, item.unit, item.status,
                        `"${JSON.stringify(item.customFields).replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(";") + "\r\n";
                });
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "export_encomendas_pastelaria_filipe.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- 7. HELPERS ---
        
      function formatDate(date) {
    return date.toLocaleString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}
      
        function formatCurrency(value, decimals = 2) {
            return new Intl.NumberFormat('pt-PT', { 
                style: 'currency', currency: 'EUR',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }
        
        function formatDateTime(date) {
            return date.toLocaleString('pt-PT', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        function formatAvgTime(times) {
            if (times.length === 0) return '--';
            const avgMs = times.reduce((a, b) => a + b, 0) / times.length;
            if (avgMs < 0) return 'Inválido';
            const hours = Math.floor(avgMs / 3600000);
            const minutes = Math.floor((avgMs % 3600000) / 60000);
            return `${hours}h ${minutes}m`;
        }

        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // --- INICIALIZAÇÃO ---
        loadState();
        initAppCore();
        initClientPage();
        initMyOrdersPage();
        initStaffPage();
        initAdminPage();
    });
</script></body>
</html>
