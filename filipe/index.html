<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pastelaria Filipe - Encomendas</title>
    <style>
        /* ---------------------------------- */
        /* 1. GLOBAIS & TEMA "CONFEITARIA"
        /* ---------------------------------- */
        :root {
            --theme-primary: #811a31; /* Bordô */
            --theme-primary-dark: #611425;
            --theme-secondary: #f0ece0; /* Bege Claro */
            --theme-text-dark: #3d3636; /* Cinzento */
            --theme-text-light: #6a6363;
            --theme-accent: #b99a30; /* Dourado */
            --theme-background: #fff;
            --theme-border: #e0d9cd; /* Tom de bege/cinza para bordas */

            --status-recebido: #29B6F6;
            --status-producao: #FFA726;
            --status-terminado: #4CAF50;
            --status-levantado: #78909C;
            --status-cancelado: #E53935;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background-color: var(--theme-secondary);
            color: var(--theme-text-dark);
            font-size: 16px;
            line-height: 1.6;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Times New Roman', Times, serif;
            color: var(--theme-primary);
            font-weight: 700;
        }

        /* ---------------------------------- */
        /* 2. ESTRUTURA APP & FULLSCREEN
        /* ---------------------------------- */

        #launch-button-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="100" height="100" fill="%23f0ece0" /><path d="M 10 10 L 90 90 M 10 90 L 90 10" stroke="%23e0d9cd" stroke-width="1" /></svg>');
            background-size: 50px;
        }
        
        .launch-button {
            padding: 18px 36px;
            font-size: 1.25rem;
            font-weight: 700;
            font-family: Georgia, serif;
            color: #fff;
            background-color: var(--theme-primary);
            border: none;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .launch-button:hover {
            background-color: var(--theme-primary-dark);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        #app-container {
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            display: none;
            flex-direction: column;
            background-color: var(--theme-background);
            overflow: hidden;
        }
        
        #app-container.running {
            display: flex;
        }

        header {
            background-color: var(--theme-background);
            padding: 10px 20px;
            border-bottom: 1px solid var(--theme-border);
            text-align: center;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-logo {
            max-width: 200px;
            max-height: 45px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        #page-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 90px;
            background-color: var(--theme-secondary);
            -webkit-overflow-scrolling: touch;
        }

        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--theme-border);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .nav-button {
            flex: 1;
            padding: 12px 5px;
            background: none;
            border: none;
            cursor: pointer;
            text-align: center;
            color: var(--theme-text-light);
            font-size: 0.75rem;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease-in-out;
        }
        .nav-button svg {
            width: 22px;
            height: 22px;
            stroke: var(--theme-text-light);
            stroke-width: 2;
            transition: all 0.2s ease-in-out;
        }
        .nav-button.active {
            color: var(--theme-primary);
        }
        .nav-button.active svg {
            stroke: var(--theme-primary);
            transform: scale(1.1);
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .page.active {
            display: block;
        }
        
        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        h3 {
            font-size: 1.25rem;
            color: var(--theme-text-dark);
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--theme-border);
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ---------------------------------- */
        /* 3. COMPONENTES REUTILIZÁVEIS
        /* ---------------------------------- */
        .card {
            background: var(--theme-background);
            border-radius: var(--radius-lg);
            border: 1px solid var(--theme-border);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: var(--theme-text-dark);
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: Arial, sans-serif;
            background: #fdfdfd;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='%23811a31'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px;
            padding-right: 40px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--theme-primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(129, 26, 49, 0.2);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group .field-note {
            font-size: 0.85rem;
            color: var(--theme-text-light);
            margin-top: 5px;
        }
        /* Checkbox Clicável */
        .form-group-checkbox {
            display: flex;
            align-items: center;
            padding: 14px;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            background-color: #fdfdfd;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .form-group-checkbox:hover {
            background-color: var(--theme-secondary);
        }
        .form-group-checkbox input[type="checkbox"] {
            -webkit-appearance: checkbox;
            -moz-appearance: checkbox;
            appearance: checkbox;
            width: 20px;
            height: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .form-group-checkbox label {
            margin: 0;
            flex: 1;
            font-weight: 600;
        }
        .form-group-checkbox .price-tag {
            font-weight: 700;
            color: var(--theme-primary);
        }
        /* Upload de Ficheiro */
        .file-upload-wrapper {
            border: 2px dashed var(--theme-border);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #fdfdfd;
            transition: all 0.2s ease;
        }
        .file-upload-wrapper:hover {
            background: var(--theme-secondary);
        }
        .file-upload-wrapper.active {
            border-color: var(--theme-primary);
            background: var(--theme-secondary);
        }
        .file-upload-wrapper input[type="file"] { display: none; }
        .file-upload-wrapper label { cursor: pointer; font-weight: 600; color: var(--theme-primary);}
        .file-upload-wrapper span { display: block; font-size: 0.9rem; color: var(--theme-text-light); }

        button.btn, .btn {
            display: inline-block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 700;
            font-family: Georgia, serif;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        button.btn-primary {
            background-color: var(--theme-primary);
            color: #fff;
        }
        button.btn-primary:hover, button.btn-primary:focus {
            background-color: var(--theme-primary-dark);
            box-shadow: 0 4px 10px rgba(129, 26, 49, 0.3);
            transform: translateY(-2px);
        }
        button.btn-primary:disabled {
            background-color: var(--theme-text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.btn-secondary {
            background-color: var(--theme-border);
            color: var(--theme-primary);
        }
        button.btn-secondary:hover, button.btn-secondary:focus {
            background-color: #d1c7b8;
        }
        
        button.btn-danger {
            background-color: var(--status-cancelado);
            color: #fff;
        }
        button.btn-danger:hover {
            background-color: #c42d2a;
        }

        /* Toggle Genérico (usado em B2C e Staff) */
        .toggle-view {
            display: flex;
            border: 1px solid var(--theme-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .toggle-view button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            font-weight: 600;
            font-family: Georgia, serif;
            border: none;
            background: var(--theme-background);
            color: var(--theme-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-view button:first-child {
            border-right: 1px solid var(--theme-primary);
        }
        .toggle-view button.active {
            background: var(--theme-primary);
            color: #fff;
        }


        .quantity-stepper {
            display: flex;
            align-items: center;
        }
        .quantity-stepper button {
            width: 40px;
            height: 40px;
            border: 1px solid var(--theme-border);
            background: var(--theme-background);
            color: var(--theme-primary);
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            line-height: 1;
        }
        .quantity-stepper button:hover {
            background: var(--theme-secondary);
        }
        .quantity-stepper input {
            width: 50px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            background: none;
            margin: 0 5px;
            padding: 5px;
            -moz-appearance: textfield;
        }
        .quantity-stepper input::-webkit-outer-spin-button,
        .quantity-stepper input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* ---------------------------------- */
        /* 4. PÁGINA "ENCOMENDAR" (B2C + B2B)
        /* ---------------------------------- */
        
        @media (min-width: 1024px) {
            #page-b2c-wrapper {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 30px;
                align-items: flex-start;
            }
        }
        
        .checkout-sidebar {
            position: sticky;
            top: 20px;
        }

        .product-card {
            display: flex;
            gap: 15px;
            background: #fff;
            padding: 15px;
            border-radius: var(--radius-md);
            border: 1px solid var(--theme-border);
            margin-bottom: 15px;
            box-shadow: var(--shadow-sm);
        }
        
        .product-image-thumb {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border-radius: var(--radius-md);
            background-color: var(--theme-secondary);
            cursor: pointer;
            /* Placeholder */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--theme-primary);
            font-weight: 700;
        }
        .product-image-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-md);
        }
        
        .product-info {
            flex-grow: 1;
        }
        .product-info strong {
            display: block;
            font-size: 1.15rem;
            color: var(--theme-text-dark);
            font-family: Georgia, serif;
        }
        .product-info .product-price {
            font-size: 1rem;
            color: var(--theme-primary);
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .product-actions {
            margin-top: 10px;
        }
        
        .bolo-aniversario-fields {
            padding-top: 15px;
            margin-top: 15px;
            border-top: 1px dashed var(--theme-border);
        }
        
        #cart-summary {
            position: sticky;
            bottom: 70px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px 20px;
            margin: 20px -20px -20px -20px;
            border-top: 1px solid var(--theme-border);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            z-index: 50;
        }
        
        #cart-summary-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--theme-primary);
            text-align: center;
            margin-bottom: 15px;
        }

        @media (min-width: 1024px) {
            #cart-summary {
                position: relative;
                bottom: auto;
                margin: 0;
                border: 1px solid var(--theme-border);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-sm);
            }
            #cart-summary-total {
                text-align: left;
            }
        }
        
        #cart-items-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--theme-border);
            font-size: 0.9rem;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-info strong {
            font-size: 0.95rem;
            color: var(--theme-text-dark);
        }
        .cart-item-info span {
            display: block;
            font-size: 0.85rem;
            color: var(--theme-text-light);
        }
        .cart-item-remove {
            width: 30px;
            height: 30px;
            flex-shrink: 0;
            background: none;
            border: 1px solid var(--status-cancelado);
            color: var(--status-cancelado);
            border-radius: 50%;
            font-weight: 700;
            font-size: 1rem;
            line-height: 1;
            cursor: pointer;
            margin-left: 10px;
        }

        #client-contact {
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            color: var(--theme-text-light);
            background: var(--theme-secondary);
            border-radius: var(--radius-md);
            margin-top: 20px;
        }
        
        /* ---------------------------------- */
        /* 4.B. PÁGINA B2B (REVENDA)
        /* ---------------------------------- */
        #b2b-login-screen {
            max-width: 400px;
            margin: 20px auto;
            text-align: center;
        }
        #b2b-login-screen p {
            margin-bottom: 15px;
            color: var(--theme-text-light);
        }
        #b2b-order-screen {
            display: none; /* Escondido até login */
        }
        .b2b-header-card {
            background: var(--theme-primary);
            color: #fff;
        }
        .b2b-header-card h2, .b2b-header-card p {
            color: #fff;
        }
        .b2b-header-card strong {
            color: var(--theme-secondary);
            font-size: 1.5rem;
        }
        
        .b2b-accordion-section summary {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--theme-primary);
            cursor: pointer;
            padding: 15px;
            background: var(--theme-background);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            list-style: none;
            margin-top: 10px;
            transition: background 0.2s ease;
        }
        .b2b-accordion-section summary:hover {
            background: var(--theme-secondary);
        }
        .b2b-accordion-section summary::-webkit-details-marker {
            display: none;
        }
        /* Adiciona um indicador +/ - */
        .b2b-accordion-section summary::after {
            content: '+';
            float: right;
            font-size: 1.5rem;
            line-height: 1;
            font-family: Arial, sans-serif;
        }
        .b2b-accordion-section[open] summary::after {
            content: '−';
        }
        .b2b-accordion-section[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .b2b-accordion-content {
            padding: 15px;
            border: 1px solid var(--theme-border);
            border-top: none;
            border-bottom-left-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
        }
        
        .b2b-product-item {
            display: grid;
            grid-template-columns: 40px 1fr 120px;
            align-items: center;
            gap: 5px;
            padding: 4px 0;
            border-bottom: 1px solid var(--theme-border);
        }
        .b2b-product-item:last-child { border-bottom: none; }
        
        .b2b-placeholder-img {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            border-radius: 50%;
            background-color: var(--theme-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--theme-primary);
            font-weight: 700;
        }
        
        .b2b-product-info strong {
            font-size: 1rem;
            color: var(--theme-text-dark);
            font-family: Arial, sans-serif;
            font-weight: 600;
        }
        .b2b-product-info span {
            font-size: 0.9rem;
            color: var(--theme-text-light);
        }

        /* Layout Desktop para B2B */
        @media (min-width: 768px) {
             .b2b-product-item {
                grid-template-columns: 50px 1fr 1fr 150px;
            }
            .b2b-product-info {
                display: contents; /* Permite que os filhos se alinhem à grid */
            }
            .b2b-product-info span {
                text-align: right;
                padding-right: 20px;
            }
          
          .b2b-product-item .quantity-stepper {
        padding: 5px;
        background: var(--theme-secondary);
        border-radius: var(--radius-md);
        justify-content: space-between; /* Garante espaço */
    }
    .b2b-product-item .quantity-stepper input {
        width: 50px; /* Mais largo */
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--theme-primary);
    }
    .b2b-product-item .quantity-stepper button {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
          
        }
        @media (max-width: 400px) {
            .b2b-product-item {
                grid-template-columns: 1fr 120px;
            }
            .b2b-product-item .b2b-placeholder-img {
                display: none;
            }
        }
        
        #b2b-submit-wrapper {
            position: sticky;
            bottom: 70px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px 20px;
            margin: 20px -20px -20px -20px;
            border-top: 1px solid var(--theme-border);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            z-index: 50;
          
          
        }
        /* Para Desktop B2B, o botão não é sticky */
        @media (min-width: 1024px) {
            #b2b-submit-wrapper {
                position: relative;
                bottom: auto;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            #b2b-submit-order {
                max-width: 400px;
                margin-top: 20px;
            }
        }

        /* ---------------------------------- */
        /* 4.5. PÁGINA "MINHAS ENCOMENDAS"
        /* ---------------------------------- */
        #my-orders-login {
            text-align: center;
        }
        #my-orders-login p {
            margin-bottom: 15px;
            color: var(--theme-text-light);
        }
        #my-orders-login .form-group {
            max-width: 400px;
            margin: 0 auto 15px auto;
        }
        #my-orders-login button {
            max-width: 400px;
        }
        #my-orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #my-orders-header button {
            font-size: 0.9rem;
            font-family: Arial, sans-serif;
            background: none;
            border: none;
            color: var(--theme-primary);
            cursor: pointer;
            font-weight: 700;
        }
        .my-order-ticket .ticket-details p strong {
            min-width: 100px;
        }
        
        /* ---------------------------------- */
        /* 5. PÁGINA STAFF
        /* ---------------------------------- */
        .staff-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .staff-controls .form-group {
            margin-bottom: 0;
        }
        
        .staff-subtotals {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: -10px;
            margin-bottom: 15px;
            font-family: Arial, sans-serif;
            font-weight: 700;
        }
        .staff-subtotals div {
            padding: 10px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        #staff-subtotal-paid {
            background-color: var(--status-terminado);
            color: #fff;
        }
        #staff-subtotal-pending {
            background-color: var(--status-producao);
            color: #fff;
        }
        
        @media (min-width: 768px) {
            .staff-controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                align-items: center;
            }
            #staff-view-toggle-container { /* O toggle de view de staff */
                grid-column: 1 / -1;
            }
        }
        @media (min-width: 1024px) {
            .staff-controls {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
            #staff-view-toggle-container {
                grid-column: auto;
            }
            .staff-controls.revenda-view { /* Grelha com 5 colunas para revenda */
                grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            }
        }
        
        .order-ticket {
            border-left: 5px solid var(--status-recebido);
        }
        .order-ticket.status-producao { border-left-color: var(--status-producao); }
        .order-ticket.status-terminado { border-left-color: var(--status-terminado); }
        .order-ticket.status-levantado {
            border-left-color: var(--status-levantado);
            opacity: 0.7;
            background: #f9f9f9;
        }
        .order-ticket.status-cancelado {
            border-left-color: var(--status-cancelado);
            opacity: 0.6;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .ticket-header strong {
            font-size: 1.2rem;
            color: var(--theme-primary);
        }
        .ticket-header .ticket-id {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--theme-text-light);
        }
        
        .ticket-details p {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }
        .ticket-details p strong {
            color: var(--theme-text-dark);
            min-width: 130px;
            display: inline-block;
        }
        
        .ticket-items {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .ticket-items-list {
            padding-left: 20px;
            list-style-type: disc;
            color: var(--theme-text-light);
            max-height: 80px;
            overflow: hidden;
            position: relative;
        }
        .ticket-items-list.expanded {
            max-height: none;
        }
        .ticket-items-list.expandable::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, transparent, #fff);
        }
        .ticket-items-list.expanded::after {
            display: none;
        }
        .ticket-items-list li {
            margin-bottom: 3px;
        }
        .ticket-items-list li .item-status {
            font-size: 0.8rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 5px;
            color: #fff;
            background: var(--status-recebido);
        }
        .ticket-items-list li .item-status-producao { background: var(--status-producao); }
        .ticket-items-list li .item-status-terminado { background: var(--status-terminado); }
        .ticket-items-list li .item-status-levantado { background: var(--status-levantado); }
        .ticket-items-list li .item-status-cancelado { background: var(--status-cancelado); }
        
        .expand-items-btn {
            background: none;
            border: none;
            color: var(--theme-primary);
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .order-status-segmented {
            display: flex;
            width: 100%;
            border: 1px solid var(--theme-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: 20px;
        }
        .order-status-segmented button {
            flex: 1;
            background: #fff;
            color: var(--theme-primary);
            border: none;
            border-left: 1px solid var(--theme-border);
            padding: 10px 5px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: Arial, sans-serif;
        }
        .order-status-segmented button:first-child { border-left: none; }
        .order-status-segmented button.active {
            color: #fff;
            font-weight: 700;
        }
        .order-status-segmented button[data-status="recebido"].active { background-color: var(--status-recebido); }
        .order-status-segmented button[data-status="producao"].active { background-color: var(--status-producao); }
        .order-status-segmented button[data-status="terminado"].active { background-color: var(--status-terminado); }
        .order-status-segmented button[data-status="levantado"].active { background-color: var(--status-levantado); }
        .order-status-segmented button[data-status="cancelado"].active { background-color: var(--status-cancelado); }
        .order-status-segmented button[data-status="cancelado"] { color: var(--status-cancelado); }
        .order-status-segmented button[data-status="cancelado"].active { color: #fff; }


        .ticket-status-control {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .ticket-status-control button {
            font-size: 0.9rem;
            padding: 10px 14px;
            font-weight: 700;
        }
        .ticket-image-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .ticket-image-actions .btn {
            width: auto;
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }


        /* ---------------------------------- */
        /* 6. PÁGINA ADMIN
        /* ---------------------------------- */
        .admin-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .admin-filters .form-group { margin-bottom: 0; }
        
        @media (min-width: 1024px) {
            .admin-filters {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .kpi-card {
            background: var(--theme-background);
            border: 1px solid var(--theme-border);
            padding: 15px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        .kpi-card .kpi-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--theme-primary);
            line-height: 1.2;
        }
        .kpi-card .kpi-label {
            font-size: 0.8rem;
            color: var(--theme-text-light);
            font-weight: 600;
        }
        .kpi-card .kpi-sub-value {
            font-size: 0.8rem;
            color: var(--theme-text-light);
        }
        
        .chart-nav {
            display: flex;
            gap: 8px;
        }
        .chart-nav button {
            background: var(--theme-border);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: 700;
            color: var(--theme-primary);
            cursor: pointer;
            line-height: 1;
        }
        .chart-nav button:hover {
            background: #d1c7b8;
        }

        .chart-container-scrollable {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-md);
            background: var(--theme-background);
        }

        .chart-container {
            width: 100%;
            height: 250px;
            padding: 20px;
            padding-bottom: 40px;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            gap: 10px;
        }
        
        #admin-chart-month.chart-container {
            min-width: 900px;
        }
        #admin-chart-week.chart-container {
            min-width: 300px;
        }

        .chart-bar {
            flex: 1;
            background-color: var(--theme-primary);
            border-radius: 6px 6px 0 0;
            position: relative;
            animation: barRise 1s ease-out;
            transition: height 0.5s ease-out;
            min-width: 20px; 
        }
        .chart-bar[style*="height: 0%"] {
            animation: none;
        }
        .chart-bar .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--theme-text-light);
            white-space: nowrap;
        }
        .chart-bar .bar-value {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--theme-primary);
            white-space: nowrap;
        }
        @keyframes barRise {
            from { height: 0; }
        }

        /* ---------------------------------- */
        /* 7. MODAIS & EFEITOS
        /* ---------------------------------- */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: none; 
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* DESLIGADO POR DEFEITO */
        }
        .modal-overlay.visible {
            display: flex;
            opacity: 1;
            pointer-events: auto; /* LIGADO QUANDO VISÍVEL */
        }

        #image-modal-content {
            pointer-events: auto; 
            background: #fff;
            padding: 0;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 800px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
            height: 80%;
            max-height: 80vh;
        }
        
        .modal-overlay.visible #image-modal-content {
            transform: scale(1);
        }

        #image-modal-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--radius-lg);
        }
        .modal-close-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--theme-primary);
            color: #fff;
            border: 2px solid #fff;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            cursor: pointer;
            z-index: 210;
            box-shadow: var(--shadow-md);
            pointer-events: auto;
        }
        #image-modal-download {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* Escondido por defeito */
            width: auto;
            white-space: nowrap;
        }

        #toast-notification {
            position: fixed;
            bottom: 100px; /* Acima da nav-bar */
            left: 50%;
            transform: translate(-50%, 100px);
            background: var(--theme-text-dark);
            color: #fff;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9rem;
            font-family: Arial, sans-serif;
            z-index: 300;
            box-shadow: var(--shadow-md);
            transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1);
            opacity: 0;
            pointer-events: none; /* Toast nunca bloqueia cliques */
        }
        #toast-notification.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }
        
        /* Efeito Confetti (para velhotes) */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            overflow: hidden;
        }
        .confetti {
            width: 10px;
            height: 20px;
            background-color: var(--theme-primary);
            position: absolute;
            top: -20px; /* Começa fora do ecrã */
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards;
        }
        .confetti:nth-child(2n) { background-color: var(--theme-accent); }
        .confetti:nth-child(3n) { background-color: var(--status-terminado); }
        .confetti:nth-child(4n) { height: 10px; width: 10px; border-radius: 50%; }

        @keyframes confetti-fall {
            0% { top: -20px; opacity: 1; transform: rotate(0deg) translateX(0px); }
            100% { top: 100vh; opacity: 1; transform: rotate(720deg) translateX(-100px); }
        }

    </style>
</head>
<body>

    <div id="launch-button-wrapper">
        <button id="launch-app-btn" class="launch-button">Encomendar</button>
    </div>

    <div id="app-container">

        <header>
            <img src="https://via.placeholder.com/200x45/811a31/FFFFFF?text=Nova+Pastelaria" alt="Nova Pastelaria" id="header-logo-img" class="header-logo">
        </header>

        <main id="page-content">

            <section id="page-b2c" class="page active">
                <div class="page-wrapper">
                    
                    <div class="toggle-view">
                        <button id="b2c-view-toggle-particular" class="active" data-view="particular">Particular</button>
                        <button id="b2c-view-toggle-revenda" data-view="revenda">Revenda</button>
                    </div>

                    <div id="b2c-particular-view">
                        <div id="page-b2c-wrapper">
                            <div class="product-grid">
                                <h2>As Nossas Especialidades</h2>
                                <div id="product-list-container">
                                    </div>
                            </div>
                            <aside class="checkout-sidebar">
                                <div id="cart-summary" class="card">
                                    <h3>A sua Encomenda</h3>
                                    <div id="cart-items-list">
                                        <p id="cart-empty-msg" style="color: var(--theme-text-light);">O seu carrinho está vazio.</p>
                                    </div>
                                    <div id="cart-summary-total">Total: 0.00€</div>
                                    <button id="checkout-btn" class="btn btn-primary" disabled>Finalizar Encomenda</button>
                                </div>
                                <div id="checkout-form-container" class="card" style="display: none;">
                                    <h3>Dados de Levantamento</h3>
                                    <form id="form-b2c-checkout">
                                        <div class="form-group">
                                            <label for="b2c-nome-cliente">O seu Nome</label>
                                            <input type="text" id="b2c-nome-cliente" placeholder="Nome completo" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="b2c-telemovel">O seu Telemóvel</label>
                                            <input type="text" id="b2c-telemovel" placeholder="912 345 678" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="b2c-pickup-location">Local de Levantamento</label>
                                            <select id="b2c-pickup-location" required>
                                                <option value="">Selecione um local...</option>
                                                <option value="Casa Mãe – Praça da Figueira 18B">Casa Mãe – Praça da Figueira 18B</option>
                                                <option value="Belém – Av Brasília">Belém – Av Brasília (junto à Torre)</option>
                                                <option value="Quisque Amoreiras Shopping">Quisque Amoreiras Shopping (junto aos CTT)</option>
                                                <option value="Fábrica – Campo de Ourique">Fábrica – Campo de Ourique</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="b2c-data-levantamento">Data de Levantamento</label>
                                            <input type="date" id="b2c-data-levantamento" required>
                                            <p class="field-note" id="pickup-date-note"></p>
                                        </div>
                                        <div class="form-group">
                                            <label for="b2c-hora-levantamento">Hora de Levantamento (08:00 - 20:00)</label>
                                            <input type="time" id="b2c-hora-levantamento" min="08:00" max="20:00" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="b2c-codigo-cliente">Código de Cliente (Opcional)</label>
                                            <input type="text" id="b2c-codigo-cliente" placeholder="Ex: CLIENTE_VIP">
                                        </div>
                                        <button type="submit" id="b2c-submit" class="btn btn-primary">Confirmar Encomenda</button>
                                    </form>
                                </div>
                                <div id="client-contact" class="card">
                                    Precisa de ajuda ou de algo especial?
                                    <br>
                                    Ligue-nos: <strong id="phone-number-display">21 948 8720</strong>
                                </div>
                            </aside>
                        </div>
                    </div>

                    <div id="b2c-revenda-view" style="display: none;">
                        <div id="b2b-login-screen" class="card">
                            <h2>Acesso Revenda</h2>
                            <p>Esta área é reservada a clientes de revenda. Por favor, autentique-se.</p>
                            <form id="b2b-login-form">
                                <div class="form-group">
                                    <label for="b2b-username">Utilizador</label>
                                    <input type="text" id="b2b-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="b2b-password">Palavra-passe</label>
                                    <input type="password" id="b2b-password" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Entrar</button>
                            </form>
                            <p style="margin-top: 15px; font-size: 0.9rem;">Não tem acesso? Contacte a gerência: <strong id="b2b-phone-contact">21 948 8720</strong></p>
                        </div>
                        
                        <div id="b2b-order-screen" style="display: none;">
                            <div class="b2b-header-card card">
                                <h2 id="b2b-welcome-msg">Bem-vindo!</h2>
                                <p>Encomendas para amanhã fecham às 19:00h.</p>
                                <strong id="b2b-countdown">--:--:--</strong>
                            </div>
                            
                            <div class="card">
                                <div class="form-group">
                                    <label for="b2b-search-input">Pesquisa Rápida</label>
                                    <input type="text" id="b2b-search-input" placeholder="Escreva o nome de um artigo...">
                                </div>
                            </div>
                            
                            <div id="b2b-product-list-container">
                                </div>
                            
                            <div id="b2b-submit-wrapper">
                                <button id="b2b-submit-order" class="btn btn-primary">Enviar Encomenda para Amanhã</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </section>
            
            <section id="page-my-orders" class="page">
                <div class="page-wrapper">
                    
                    <div id="my-orders-login" class="card" style="display: none;">
                        <h2>Minhas Encomendas</h2>
                        <p>Insira o seu número de telemóvel para ver o estado das suas encomendas.</p>
                        <form id="my-orders-login-form">
                            <div class="form-group">
                                <input type="text" id="my-orders-phone-input" placeholder="912 345 678" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Ver Encomendas</button>
                        </form>
                    </div>

                    <div id="my-orders-list-container" style="display: none;">
                        <div id="my-orders-header">
                            <h2>Minhas Encomendas</h2>
                            <button id="my-orders-logout-btn">Mudar Utilizador</button>
                        </div>
                        <p style="color: var(--theme-text-light); margin-top: -10px; margin-bottom: 20px;">
                            A ver encomendas para: <strong id="my-orders-phone-display"></strong>
                        </p>
                        <div id="my-orders-list">
                            </div>
                    </div>
                </div>
            </section>
            
            <section id="page-staff" class="page">
                <div class="page-wrapper">
                    <h2>Painel Staff</h2>
                    
                    <div class="toggle-view">
                        <button id="staff-type-toggle-particular" class="active" data-type="particular">Particular</button>
                        <button id="staff-type-toggle-revenda" data-type="revenda">Revenda</button>
                    </div>

                    <div class="staff-controls card">
                        <div class="toggle-view" id="staff-view-toggle-container">
                            <button id="staff-view-toggle-order" class="active" data-view="order">Ver por Encomenda</button>
                            <button id="staff-view-toggle-item" data-view="item_agg">Ver por Item Agregado</button>
                        </div>
                        <div class="form-group">
                            <input type="text" id="staff-search-input" placeholder="Pesquisar por cliente...">
                        </div>
                        <div class="form-group">
                            <select id="staff-filter-status">
                                <option value="all_active">Ativos (Pendentes)</option>
                                <option value="all">Todos os Estados</option>
                                <option value="recebido">Recebido</option>
                                <option value="producao">Em Produção</option>
                                <option value="terminado">Terminado</option>
                                <option value="levantado">Levantado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="staff-sort-by">
                                <option value="pickupDateAsc">Ordenar por Levantamento (Asc)</option>
                                <option value="pickupDateDesc">Ordenar por Levantamento (Desc)</option>
                                <option value="orderDateAsc">Ordenar por Encomenda (Asc)</option>
                                <option value="orderDateDesc">Ordenar por Encomenda (Desc)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="staff-filter-pickup-date">Filtrar Dia Levantamento:</label>
                            <input type="date" id="staff-filter-pickup-date">
                        </div>
                         <div class="form-group">
                            <label for="staff-filter-order-date">Filtrar Dia Encomenda:</label>
                            <input type="date" id="staff-filter-order-date">
                        </div>
                    </div>
                    
                    <div class="staff-subtotals card">
                        <div id="staff-subtotal-pending">Pendente: 0.00€</div>
                        <div id="staff-subtotal-paid">Pago: 0.00€</div>
                    </div>

                    <div id="staff-order-list">
                        <div class="card" id="no-orders-message">
                            <p>Nenhuma encomenda encontrada.</p>
                        </div>
                        </div>
                </div>
            </section>
            
            <section id="page-admin" class="page">
                <div class="page-wrapper">
                    <h2>Dashboard Administrador</h2>

                    <div class="admin-filters card">
                        <div class="form-group">
                            <label for="admin-filter-date">Dia (Levantamento)</label>
                            <input type="date" id="admin-filter-date" placeholder="Todos">
                        </div>
                        <div class="form-group">
                            <label for="admin-filter-status">Estado</label>
                            <select id="admin-filter-status">
                                <option value="all">Todos</option>
                                <option value="recebido">Recebido</option>
                                <option value="producao">Produção</option>
                                <option value="terminado">Terminado</option>
                                <option value="pago">Pago</option>
                                <option value="levantado">Levantado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="admin-filter-item">Item</label>
                            <select id="admin-filter-item">
                                <option value="all">Todos os Itens</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="admin-filter-client">Cliente</label>
                            <select id="admin-filter-client">
                                <option value="all">Todos os Clientes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="admin-filter-location">Local</label>
                            <select id="admin-filter-location">
                                <option value="all">Todos os Locais</option>
                                <option value="Casa Mãe – Praça da Figueira 18B">Casa Mãe</option>
                                <option value="Belém – Av Brasília">Belém</option>
                                <option value="Quisque Amoreiras Shopping">Amoreiras</option>
                                <option value="Fábrica – Campo de Ourique">Fábrica</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3>Métricas (Filtros Aplicados)</h3>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-revenue">0.00€</div>
                            <div class="kpi-label">Receita Total</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-orders">0</div>
                            <div class="kpi-label">Nº Encomendas</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-avg-ticket">0.00€</div>
                            <div class="kpi-label">Ticket Médio</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-waste">0%</div>
                            <div class="kpi-label">% Canceladas</div>
                            <div class="kpi-sub-value" id="admin-kpi-waste-sub">0 / 0</div>
                        </div>
                    </div>
                    
                    <h3>Tempos de Produção (Filtros Aplicados)</h3>
                     <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-time-full">--</div>
                            <div class="kpi-label">Pedido → Terminado</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-time-prod">--</div>
                            <div class="kpi-label">Produção → Terminado</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-time-deadline">0%</div>
                            <div class="kpi-label">% Prod. Atrasada</div>
                        </div>
                         <div class="kpi-card">
                            <div class="kpi-value" id="admin-kpi-time-pickup">0%</div>
                            <div class="kpi-label">% Não Levantadas</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 id="admin-chart-week-title">Receita (€) por Dia da Semana</h3>
                            <div class="chart-nav">
                                <button id="admin-chart-week-prev">&lt;</button>
                                <button id="admin-chart-week-next">&gt;</button>
                            </div>
                        <div class="chart-container-scrollable">
                            <div class="chart-container" id="admin-chart-week"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 id="admin-chart-month-title">Receita (€) por Dia do Mês</h3>
                            <div class="chart-nav">
                                <button id="admin-chart-month-prev">&lt;</button>
                                <button id="admin-chart-month-next">&gt;</button>
                            </div>
                        <div class="chart-container-scrollable">
                            <div class="chart-container" id="admin-chart-month"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Exportar Dados</h3>
                        <p style="margin-bottom: 15px; color: var(--theme-text-light);">Faça download de um ficheiro CSV com todas as encomendas registadas em sistema.</p>
                        <button id="admin-export-csv" class="btn btn-secondary" style="width: auto;">Download CSV</button>
                    </div>

                </div>
            </section>
        </main>

        <nav id="bottom-nav">
            <button class="nav-button active" data-page="page-b2c" aria-label="Encomendar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                <span>Encomendar</span>
            </button>
             <button class="nav-button" data-page="page-my-orders" aria-label="Minhas Encomendas">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span>As Minhas</span>
            </button>
            <button class="nav-button" data-page="page-staff" aria-label="Área Staff">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                <span>Staff</span>
            </button>
            <button class="nav-button" data-page="page-admin" aria-label="Área Admin">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span>Admin</span>
            </button>
        </nav>
    </div>

    <div id="confetti-container"></div>

    <div id="image-modal" class="modal-overlay">
        <div id="image-modal-content">
            <button id="image-modal-close-btn" class="modal-close-btn">&times;</button>
            <img id="image-modal-src" src="" alt="Imagem do Produto">
            <a href="#" id="image-modal-download" class="btn btn-primary" download="imagem_bolo.png">Download Imagem</a>
        </div>
    </div>
    
    <div id="toast-notification" role="alert">
        <span id="toast-message"></span>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- ESTADO GLOBAL DA APLICAÇÃO ---
            let state = {
                orders: [], // Todas as encomendas (B2C e B2B)
                cart: [], // Carrinho B2C
                staffView: 'order', // 'order' ou 'item_agg'
                staffType: 'particular', // 'particular' ou 'revenda'
                adminFilters: {
                    chartViewDate: new Date()
                },
                nextOrderId: 1001,
                b2bUser: null, // Utilizador B2B com login
                b2bCountdownTimer: null,
                currentB2BOrder: {} // Armazena quantidades B2B
            };
            
            // --- CONSTANTES ---
            const NEW_PHONE_NUMBER = "21 948 8720";
          const NEW_LOGO_URL = "https://i.postimg.cc/02xn5CRv/image.png";
            
            // --- CATÁLOGOS DE PRODUTOS ---

            // Catálogo B2C (Particular)
            const B2C_PRODUCT_CATALOG = {
                // (Os produtos de Natal/etc. foram substituídos pelo Bolo de Aniversário melhorado)
                especiais: [
                    { 
                        id: 'B2C_BOLO_ANIV', 
                        name: 'Bolo de Aniversário', 
                        unit: 'kg (min 1kg)', 
                        step: 0.5, 
                        min: 1.0, 
                        img: 'https://i.postimg.cc/B67MybKV/image.png',
                        // Preços base por tipo
                        prices: {
                            'pao_de_lo': 13.00,
                            'manteiga': 14.00,
                            'pasta_acucar': 14.00
                        },
                        extras: {
                            imagem: 3.00
                        },
                        customFields: [
                            { id: 'tipo_bolo', label: 'Tipo de Bolo', type: 'select', options: [
                                { value: 'pao_de_lo', text: `Pão de Ló (${formatCurrency(13)})/kg` },
                                { value: 'manteiga', text: `Manteiga (${formatCurrency(14)})/kg` },
                                { value: 'pasta_acucar', text: `Pasta de Açúcar (${formatCurrency(14)})/kg` }
                            ]},
                            { id: 'nome_aniversariante', label: 'Nome no Bolo', type: 'text', placeholder: 'Ex: Parabéns João' },
                            { id: 'idade_aniversariante', label: 'Idade (opcional)', type: 'number', placeholder: 'Ex: 10' },
                            { id: 'imagem_check', label: `Imagem Comestível (+${formatCurrency(3)})`, type: 'checkbox' },
                            { id: 'imagem_upload', label: 'Carregar Imagem (max 10MB)', type: 'file', hidden: true },
                            { id: 'obs_bolo', label: 'Outras Informações (Velas de oferta)', type: 'textarea', placeholder: 'Ex: Massa de chocolate, recheio de morango...' }
                        ]
                    }
                ]
            };
            
            // Catálogo B2B (Revenda)
          // Catálogo B2B (Revenda)
            const B2B_USERS = { "maxipao": "123" };
            const B2B_CATALOG = {
                "Pastelaria": [
                    { "id": "B2B_TRANCA_CREME", "name": "Trança C/ Creme", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TRANCA_COCO", "name": "Trança C/ Côco", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CROISSANT_SIMPLES", "name": "Croissant Simples", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CROISSANT_CREME", "name": "Croissant C/ Creme", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CROISSANT_CHOCOLATE", "name": "Croissant C/ Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_LEITE", "name": "Pão de Leite", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_LEITE_MANTEIGA", "name": "Pão de Leite C/Manteiga", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ARGENTINO", "name": "Argentino", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ORELHA", "name": "Orelha", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_DEUS", "name": "Pão de Deus", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BOLO_ARROZ", "name": "Bolo de Arroz", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CARACOL", "name": "Caracol", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_QUEQUE_NORMAL", "name": "Queque Normal", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_QUEQUE_GRANDE", "name": "Queque Grande", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_QUEQUE_NOZ", "name": "Queque de Noz", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ESTRELA_FOLHADA", "name": "Estrela Folhada", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CORNOCOPIO_ACUCAR", "name": "Cornôcopio C/ Açúcar", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CORNOCOPIO_CARAMELO", "name": "Cornôcopio C/ Caramelo", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CORNOCOPIO_CHOCOLATE", "name": "Cornôcopio C/ Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_LINGUA_SOGRA", "name": "Língua da Sogra", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PASTEL_FEIJAO", "name": "Pastel de Feijão", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PASTEL_COCO", "name": "Pastel de Côco", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BOLA_CREME", "name": "Bola C/ Creme", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BOLA_CHOCOLATE", "name": "Bola C/ Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BOLA_SCREME", "name": "Bola S/ Creme", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ARGOLA_CHOCOLATE", "name": "Argola C/ Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ARGOLA_SCREME", "name": "Argola S/ Creme", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_RIM_CHOCOLATE", "name": "Rim de Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_MIL_FOLHAS_ESCURO", "name": "Mil Folhas Escuro", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_MIL_FOLHAS_BRANCO", "name": "Mil Folhas Branco", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_MIL_FOLHAS_OVO", "name": "Mil Folhas de Ovo", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TRAVESSIRO_CREME", "name": "Travessiro C/ Creme", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PASTEL_NATA", "name": "Pastel de Nata", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BOM_BOCADO", "name": "Bom Bocado", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PARA_FOLHADA", "name": "Para Folhada", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_JESUITA_AMENDOA", "name": "Jesuíta C/ Amêndoa", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PALMIER_SIMPLES", "name": "Palmier Simples", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PALMIER_RECHEADO", "name": "Palmier Recheado", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PALMIER_COBERTO", "name": "Palmier Coberto", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PALMIER_GLACE", "name": "Palmier C/ Glacé", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PALMIER_LEQUE", "name": "Palmier Leque", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_DELICIA_FOLHADA", "name": "Delícia Folhada", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_FOLHADO_FRUTA", "name": "Folhado de Fruta", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TRINITA", "name": "Trinitá", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_FOLHADO_GILA", "name": "Folhado de Gila", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_RUSSO_CANELA", "name": "Russo de Canela", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_RUSSO_COCO", "name": "Russo de Côco", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_RUSSO_PAO_LO", "name": "Russo C/ Pão de Ló", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PIRAMIDE_CHOCOLATE", "name": "Pirâmide de Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_XADREZ_MANTEIGA", "name": "Xadrez de Manteiga", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_XADREZ_CHOCOLATE", "name": "Xadrez de Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TOTOLOTO", "name": "Totoloto", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PATADA_VEADO", "name": "Patada de Veado", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_GUARDANAPO", "name": "Guardanapo", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TROUXA_SIMPLES", "name": "Trouxa Simples", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TROUXA_OVO_COCO", "name": "Trouxa de Ovo C/ Côco", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TORTA_OVO", "name": "Torta de Ovo", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TORTA_OVO_COCO", "name": "Torta de Ovo C/ Côco", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TORTA_CHOCOLATE", "name": "Torta de Chocolate", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TORTA_MANTEIGA", "name": "Torta de Manteiga", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_QUEIJADA_LARANJA", "name": "Queijada de Laranja", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_QUEIJADA_COCO", "name": "Queijada de Côco", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CEPO", "name": "Cepo", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAMPILHO", "name": "Pampilho", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_NOZ_PECAN", "name": "Noz Pecan", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BRISA", "name": "Brisa", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ECLAIRS", "name": "Éclairs", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_SALAMES", "name": "Salames", "price": 1.00, "unit": "unid" }
                ],
                "Bolos Especiais": [
                    { "id": "B2B_FATIA_CHANTILLY", "name": "Fatia de Chantilly", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_FATIA_CARAMELO", "name": "Fatia de Caramelo", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_FATIA_BRIGADEIRO", "name": "Fatia de Brigadeiro", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_DUCHESSE", "name": "Duchesse", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TIGELADA", "name": "Tigelada", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TARTELETE_NATA", "name": "Tartelete Nata", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_TARTELETE_AMENDOA", "name": "Tartelete Amêndoa", "price": 1.00, "unit": "unid" },
                    // Bolo de Aniversário B2B
                    { 
                        id: 'B2B_BOLO_ANIV', 
                        name: 'Bolo de Aniversário (Revenda)', 
                        unit: 'kg (min 1kg)', 
                        step: 0.5, 
                        min: 1.0, 
                        prices: { 'pao_de_lo': 8.00, 'manteiga': 10.00, 'pasta_acucar': 12.00 },
                        extras: { imagem: 3.00 },
                        customFields: [
                            { id: 'tipo_bolo', label: 'Tipo de Bolo', type: 'select', options: [
                                { value: 'pao_de_lo', text: `Pão de Ló (${formatCurrency(8)})/kg` },
                                { value: 'manteiga', text: `Manteiga (${formatCurrency(10)})/kg` },
                                { value: 'pasta_acucar', text: `Pasta de Açúcar (${formatCurrency(12)})/kg` }
                            ]},
                            { id: 'nome_aniversariante', label: 'Nome no Bolo', type: 'text', placeholder: 'Ex: Parabéns Cliente' },
                            { id: 'idade_aniversariante', label: 'Idade (opcional)', type: 'number', placeholder: 'Ex: 10' },
                            { id: 'imagem_check', label: `Imagem Comestível (+${formatCurrency(3)})`, type: 'checkbox' },
                            { id: 'imagem_upload', label: 'Carregar Imagem (max 10MB)', type: 'file', hidden: true },
                            { id: 'obs_bolo', label: 'Outras Informações (Velas de oferta)', type: 'textarea', placeholder: 'Ex: Massa de chocolate...' }
                        ],
                        isBirthdayCake: true // Flag especial
                    }
                ],
                "Salgados": [
                    { "id": "B2B_EMPADA_GALINHA", "name": "Empada de Galinha", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_EMPADA_CARNE", "name": "Empada de Carne", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_EMPADA_SALSICHA", "name": "Empada Salsicha", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_CROQUETE_CARNE", "name": "Croquete de Carne", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_RISSOL_CARNE", "name": "Rissol de Carne", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_RISSOL_CAMARAO", "name": "Rissol de Camarão", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_COXINHA_FRANGO", "name": "Coxinha de Frango", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_RISSOL_LEITAO", "name": "Rissol de Leitão", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ALMOFADA_QF", "name": "Almofada Q./Fiambre", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PASTEL_BACALHAU", "name": "Pastel de Bacalhau", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_MILANESA_MISTA_FOLHADA", "name": "Milanesa Mista Folhada", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_MILANESA_MISTA_BRIOCHE", "name": "Milanesa Mista Brioche", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_FOLHADO_MISTO_ALFACE", "name": "Folhado Misto C/Alface", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_CHOURICO", "name": "Pão C/Chouriço", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_FOLAR_CARNE", "name": "Folar de Carne", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_ROLINHOS_SALSICHA", "name": "Rolinhos Salsicha", "price": 1.00, "unit": "unid" }
                ],
                "Pão": [
                    { "id": "B2B_CARCACAS", "name": "Carcaças", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BOLAS_MISTURA", "name": "Bolas de Mistura", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BOLAS_AGUA", "name": "Bolas de Água", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_INTEGRAL", "name": "Pão Integral", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_FORMA_BAIXO", "name": "Pão de Forma Baixo", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_FORMA_ALTO", "name": "Pão de Forma Alto", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_MISTURA_GRANDE", "name": "Pão de Mistura Grande", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BAGUETE_TRIGO_GRANDE", "name": "Baguete Trigo Grande", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BAGUETE_TRIGO_PEQUENA", "name": "Baguete Trigo Pequena", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_BAGUETE_CEREAIS", "name": "Baguete Cereais", "price": 1.00, "unit": "unid" },
                    { "id": "B2B_PAO_AZEITE", "name": "Pão de Azeite", "price": 1.00, "unit": "unid" }
                ],
                "Natal": [
                    { "id": "B2B_BOLO_DOCE_OVO_NATAL", "name": "Bolo com doce de ovo de Natal", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_BOLO_CHANTILLY_FRUTA", "name": "Bolo Chantilly (com fruta)", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TRANCHE_CARAMELO", "name": "Tranche de Caramelo", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TRANCHE_CHANTILLY_FRUTA", "name": "Tranche Chantilly (C/Fruta)", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_SEMIFRIOS", "name": "Semifrios (Morango, Laranja)", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TARTE_AMENDOA", "name": "Tartes de Amêndoa", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TARTE_NATA", "name": "Tartes de Nata", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TRAVESSEIRO_NOIVA", "name": "Travesseiro de Noiva", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TORTAS_VARIAS", "name": "Tortas (Ovo, Choc, Mant, Simples)", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TORTA_LEITE", "name": "Torta de Leite", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TORTA_LARANJA", "name": "Torta de Laranja", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_RUSSO_MANTEIGA", "name": "Russo de Manteiga", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_BOLO_NOZ", "name": "Bolo de Noz", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_BOLO_BRIGADEIRO", "name": "Bolo Brigadeiro", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_PROFITEROLES", "name": "Profiteroles", "price": 11.00, "unit": "Unid", "iva": true },
                    { "id": "B2B_PUDIM", "name": "Pudim", "price": 10.00, "unit": "Unid", "iva": true },
                    { "id": "B2B_MOLOTOF", "name": "Molotof", "price": 10.00, "unit": "Unid", "iva": true },
                    { "id": "B2B_BOLO_BOLACHA", "name": "Bolo de Bolacha", "price": 11.00, "unit": "Unid", "iva": true },
                    { "id": "B2B_LAMPREIA", "name": "Lampreia", "price": 22.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_TRONCO_NATAL", "name": "Tronco de Natal (Choc/Ovo)", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_PAO_LO_SIMPLES", "name": "Pão de Ló Simples", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_BOLO_REI", "name": "Bolo-Rei", "price": 11.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_BOLO_RAINHA", "name": "Bolo-Rainha", "price": 11.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_BROA_CASTELAR", "name": "Broa Castelar", "price": 10.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_SONHOS", "name": "Sonhos", "price": 13.00, "unit": "Kg", "step": 0.5, "min": 0.5, "iva": true },
                    { "id": "B2B_COSCOROES", "name": "Coscorões", "price": 1.20, "unit": "Unid", "iva": true },
                    { "id": "B2B_FILHOS", "name": "Filhós", "price": 1.20, "unit": "Unid", "iva": true },
                    { "id": "B2B_FATIAS_DOURADAS", "name": "Fatias Douradas", "price": 1.20, "unit": "Unid", "iva": true },
                    { "id": "B2B_AZEVIAS", "name": "Azevias", "price": 1.20, "unit": "Unid", "iva": true }
                ],
                "Extras": [
                    { "id": "B2B_CAIXA_CONDUCAO", "name": "Caixa de Condução", "price": 0.80, "unit": "Unid", "iva": true }
                ]
            };

            // --- ELEMENTOS DOM GLOBAIS ---
            const launchBtn = document.getElementById('launch-app-btn');
            const launchWrapper = document.getElementById('launch-button-wrapper');
            const appContainer = document.getElementById('app-container');
            const pageContent = document.getElementById('page-content');
            const navButtons = document.querySelectorAll('.nav-button');
            
            const toast = document.getElementById('toast-notification');
            const toastMsg = document.getElementById('toast-message');
            
            const imgModal = document.getElementById('image-modal');
            const imgModalSrc = document.getElementById('image-modal-src');
            const imgModalCloseBtn = document.getElementById('image-modal-close-btn');
            const imgModalDownloadBtn = document.getElementById('image-modal-download');
            
            const confettiContainer = document.getElementById('confetti-container');

            // --- 1. CORE APP (FULLSCREEN, NAVEGAÇÃO, MODAIS) ---

            function initAppCore() {
                // Atualiza branding
                document.getElementById('header-logo-img').src = NEW_LOGO_URL;
              document.getElementById('header-logo-img').alt = "Pastelaria Filipe";
                document.getElementById('phone-number-display').textContent = NEW_PHONE_NUMBER;
                document.getElementById('b2b-phone-contact').textContent = NEW_PHONE_NUMBER;

                launchBtn.addEventListener('click', openFullscreen);
                document.addEventListener('fullscreenchange', onFullscreenChange);

                document.getElementById('bottom-nav').addEventListener('click', (e) => {
                    const navButton = e.target.closest('.nav-button');
                    if (navButton && navButton.dataset.page) {
                        showPage(navButton.dataset.page);
                    }
                });
                
                imgModalCloseBtn.addEventListener('click', hideImageModal);
                imgModal.addEventListener('click', (e) => {
                    if (e.target === imgModal) {
                        hideImageModal();
                    }
                });
                imgModalDownloadBtn.addEventListener('click', (e) => {
                    // O 'href' é definido dinamicamente quando a modal abre
                    e.stopPropagation(); // Impede o overlay de fechar
                });
            }

            function openFullscreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
                
                launchWrapper.style.display = 'none';
                appContainer.classList.add('running');
            }

            function closeFullscreen() {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
                
                launchWrapper.style.display = 'flex';
                appContainer.classList.remove('running');
            }

            function onFullscreenChange() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                    launchWrapper.style.display = 'flex';
                    appContainer.classList.remove('running');
                }
            }

            function showPage(pageId) {
                pageContent.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                
                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageId);
                });
                
                if (pageId === 'page-my-orders') {
                    renderMyOrdersPage();
                }
                if (pageId === 'page-staff') {
                    renderStaffPage();
                }
                if (pageId === 'page-admin') {
                    renderAdminDashboard(); 
                }
            }
            
            let toastTimer;
            function showToast(message) {
                clearTimeout(toastTimer);
                toastMsg.textContent = message;
                toast.classList.add('show');
                toastTimer = setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000); // 3 segundos
            }

            // CORREÇÃO DEFINITIVA BUG MOBILE:
            function showModal(modalElement) {
                modalElement.style.display = 'flex';
                setTimeout(() => { // Delay de 10ms para forçar o reflow
                    modalElement.classList.add('visible');
                }, 10);
            }

            function hideModal(modalElement) {
                // Remove a animação de fade-out e esconde imediatamente
                modalElement.classList.remove('visible');
                modalElement.style.display = 'none';
                // Força o browser a recalcular o layout, matando qualquer "fantasma"
                void document.body.offsetHeight;
            }
            
            function showImageModal(src, alt, allowDownload = false) {
                imgModalSrc.src = src;
                imgModalSrc.alt = alt;
                if (allowDownload) {
                    imgModalDownloadBtn.href = src;
                    imgModalDownloadBtn.style.display = 'block';
                } else {
                    imgModalDownloadBtn.style.display = 'none';
                }
                showModal(imgModal);
            }

            function hideImageModal() {
                hideModal(imgModal);
            }

            function playConfettiEffect() {
                confettiContainer.innerHTML = ''; // Limpa confettis antigos
                for (let i = 0; i < 30; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                    confettiContainer.appendChild(confetti);
                }
                // Limpa os confettis do DOM após a animação
                setTimeout(() => {
                    confettiContainer.innerHTML = '';
                }, 3500);
            }


            // --- 2. GESTÃO DE ESTADO (LOCAL STORAGE & SEEDING) ---

            function saveState() {
                const data = {
                    orders: state.orders,
                    nextOrderId: state.nextOrderId
                };
                localStorage.setItem('novaPastelariaState', JSON.stringify(data));
            }

            function loadState() {
                const data = localStorage.getItem('novaPastelariaState');
                if (data) {
                    const parsedData = JSON.parse(data);
                    state.orders = parsedData.orders || [];
                    state.nextOrderId = parsedData.nextOrderId || 1001;
                } else {
                    seedInitialData();
                    saveState();
                }
                renderCart();
                renderStaffPage();
            }
            
            function seedInitialData() {
                console.log("A criar dados de demonstração (seeding)...");
                const demoOrders = [];
                let orderId = 1001;
                const clients = [
                    { name: 'Ana Silva', phone: '912345678' },
                    { name: 'Bruno Martins', phone: '965432100' },
                    { name: 'Carla Dias', phone: '934567890' },
                    { name: 'David Rocha', phone: '923456789' }
                ];
                const locations = ["Casa Mãe – Praça da Figueira 18B", "Belém – Av Brasília", "Quisque Amoreiras Shopping", "Fábrica – Campo de Ourique"];
                const b2cItem = B2C_PRODUCT_CATALOG.especiais[0]; // Bolo Aniv
                const today = new Date();
                
                // CORREÇÃO GRÁFICOS: Adicionar dados para os últimos 7 dias
                for (let i = 0; i < 10; i++) {
                    const dayOffset = Math.floor(Math.random() * 7); // 0-6 dias atrás
                    const pickupDate = new Date(today);
                    pickupDate.setDate(today.getDate() - dayOffset);
                    pickupDate.setHours(Math.floor(Math.random() * 10) + 9);
                    
                    const orderDate = new Date(pickupDate);
                    orderDate.setDate(pickupDate.getDate() - 1);
                    
                    const client = clients[i % clients.length];
                    const quantity = (Math.random() * 1.5 + 1).toFixed(1); // 1-2.5kg
                    const total = (b2cItem.prices.pao_de_lo * quantity);
                    
                    const status = (dayOffset < 2) ? 'producao' : 'levantado';

                    demoOrders.push({
                        id: `CN-${orderId++}`,
                        clientName: client.name,
                        clientPhone: client.phone,
                        orderDate: orderDate.toISOString(),
                        pickupDate: pickupDate.toISOString(),
                        pickupLocation: locations[i % locations.length],
                        clientCode: 'N/A',
                        total: total,
                        status: status,
                        paid: (status === 'levantado'),
                        type: 'particular', // TIPO
                        items: [{
                            itemId: b2cItem.id, name: b2cItem.name, quantity: quantity,
                            unit: b2cItem.unit.split(' ')[0], price: b2cItem.prices.pao_de_lo,
                            status: status, customFields: { tipo_bolo: 'pao_de_lo' }
                        }],
                        timestamps: {
                            recebido: orderDate.toISOString(),
                            producao: (status !== 'recebido') ? new Date(orderDate.getTime() + 3600000).toISOString() : null,
                            terminado: (status === 'terminado' || status === 'levantado') ? new Date(orderDate.getTime() + 14400000).toISOString() : null,
                            levantado: (status === 'levantado') ? new Date(pickupDate.getTime() + 3600000).toISOString() : null,
                            cancelado: null
                        }
                    });
                }
                
                // Adiciona encomendas futuras (para o staff ver)
                const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1); tomorrow.setHours(14, 0, 0);
                const dayAfter = new Date(); dayAfter.setDate(today.getDate() + 2); dayAfter.setHours(10, 30, 0);

                demoOrders.push({
                    id: `CN-${orderId++}`, clientName: 'Filipe Antunes', clientPhone: '919999999',
                    orderDate: today.toISOString(), pickupDate: tomorrow.toISOString(),
                    pickupLocation: 'Casa Mãe – Praça da Figueira 18B', total: 28, status: 'recebido', paid: true, type: 'particular',
                    items: [{ itemId: 'B2C_BOLO_ANIV', name: 'Bolo de Aniversário', quantity: 2, unit: 'kg', price: 14, status: 'recebido', customFields: { tipo_bolo: 'manteiga', nome_aniversariante: 'Parabéns' } }],
                    timestamps: { recebido: today.toISOString(), producao: null, terminado: null, levantado: null, cancelado: null }
                });
                
                // Adiciona encomendas de REVENDA (B2B) para HOJE
                const b2bItem = B2B_CATALOG.Pastelaria[0]; // Trança
                const yesterday = new Date(); yesterday.setDate(today.getDate() - 1); yesterday.setHours(18, 0, 0);
                const todayPickup = new Date(); todayPickup.setHours(9, 0, 0);

                 demoOrders.push({
                    id: `CN-${orderId++}`, clientName: 'maxipao', clientPhone: 'N/A',
                    orderDate: yesterday.toISOString(), pickupDate: todayPickup.toISOString(),
                    pickupLocation: 'Revenda', clientCode: 'maxipao',
                    total: 50.00, status: 'producao', paid: false, type: 'revenda',
                    items: [
                        { itemId: b2bItem.id, name: b2bItem.name, quantity: 20, unit: 'unid', price: 1.00, status: 'producao', customFields: {} },
                        { itemId: 'B2B_PASTEL_NATA', name: 'Pastel de Nata', quantity: 30, unit: 'unid', price: 1.00, status: 'recebido', customFields: {} }
                    ],
                    timestamps: { recebido: yesterday.toISOString(), producao: today.toISOString(), terminado: null, levantado: null, cancelado: null }
                });
                
                state.orders = demoOrders;
                state.nextOrderId = orderId;
            }

            // --- 3. PÁGINA "ENCOMENDAR" (GERAL) ---
            
            const b2cView = document.getElementById('b2c-particular-view');
            const b2bView = document.getElementById('b2c-revenda-view');
            
            function initEncomendarPage() {
                document.getElementById('b2c-view-toggle-particular').addEventListener('click', () => setEncomendarView('particular'));
                document.getElementById('b2c-view-toggle-revenda').addEventListener('click', () => setEncomendarView('revenda'));
                
                initClientPage(); // Inicia a view B2C
                initB2BPage(); // Inicia a view B2B
            }

            function setEncomendarView(view) {
                if (view === 'particular') {
                    b2cView.style.display = 'block';
                    b2bView.style.display = 'none';
                    document.getElementById('b2c-view-toggle-particular').classList.add('active');
                    document.getElementById('b2c-view-toggle-revenda').classList.remove('active');
                } else {
                    b2cView.style.display = 'none';
                    b2bView.style.display = 'block';
                    document.getElementById('b2c-view-toggle-particular').classList.remove('active');
                    document.getElementById('b2c-view-toggle-revenda').classList.add('active');
                    
                    // Verifica login B2B
                    checkB2BLogin();
                }
            }

            // --- 3A. LÓGICA PARTICULAR (B2C) ---
            
            const productListContainer = document.getElementById('product-list-container');
            const cartItemsList = document.getElementById('cart-items-list');
            const cartEmptyMsg = document.getElementById('cart-empty-msg');
            const cartTotalEl = document.getElementById('cart-summary-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const checkoutFormContainer = document.getElementById('checkout-form-container');
            const b2cForm = document.getElementById('form-b2c-checkout');
            const pickupDateInput = document.getElementById('b2c-data-levantamento');
            const pickupTimeInput = document.getElementById('b2c-hora-levantamento');
            const pickupDateNote = document.getElementById('pickup-date-note');

            function initClientPage() {
                renderAllProducts();
                initPickupDatePicker();
                
                productListContainer.addEventListener('click', handleProductClick);
                cartItemsList.addEventListener('click', handleCartItemRemove);
                checkoutBtn.addEventListener('click', () => {
                    checkoutFormContainer.style.display = 'block';
                    checkoutFormContainer.scrollIntoView({ behavior: 'smooth' });
                });
                b2cForm.addEventListener('submit', handleOrderSubmit);
                
                pickupDateInput.addEventListener('change', initPickupDatePicker);
            }
            
            function renderAllProducts() {
                let html = '';
                
                html += '<h3>🎂 Bolos Especiais</h3>';
                B2C_PRODUCT_CATALOG.especiais.forEach(p => html += createProductCard(p));
                
                // (Outras secções B2C removidas conforme pedido)
                
                productListContainer.innerHTML = html;
            }
            
            // Lógica de Bolo de Aniversário melhorada
            function createProductCard(product) {
                const isKg = product.unit.includes('kg');
                const step = product.step || 1;
                const min = product.min || (isKg ? 0.5 : 1);
                
                let customFieldsHtml = '';
                if (product.customFields) {
                    customFieldsHtml = '<div class="bolo-aniversario-fields">';
                    product.customFields.forEach(field => {
                        if (field.type === 'select') {
                            customFieldsHtml += `
                                <div class="form-group">
                                    <label for="field-${product.id}-${field.id}">${field.label}</label>
                                    <select id="field-${product.id}-${field.id}" data-field-id="${field.id}">
                                        ${field.options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                    </select>
                                </div>`;
                        } else if (field.type === 'textarea') {
                            customFieldsHtml += `
                                <div class="form-group">
                                    <label for="field-${product.id}-${field.id}">${field.label}</label>
                                    <textarea id="field-${product.id}-${field.id}" data-field-id="${field.id}" placeholder="${field.placeholder || ''}"></textarea>
                                </div>`;
                        } else if (field.type === 'checkbox') {
                             customFieldsHtml += `
                                <div class="form-group form-group-checkbox" data-toggles="field-${product.id}-imagem_upload">
                                    <input type="checkbox" id="field-${product.id}-${field.id}" data-field-id="${field.id}">
                                    <label for="field-${product.id}-${field.id}">${field.label}</label>
                                    <span class="price-tag">+${formatCurrency(product.extras.imagem)}</span>
                                </div>`;
                        } else if (field.type === 'file') {
                            customFieldsHtml += `
                                <div class="form-group file-upload-wrapper" id="wrapper-field-${product.id}-${field.id}" style="${field.hidden ? 'display: none;' : ''}">
                                    <label for="field-${product.id}-${field.id}">
                                        Carregar Ficheiro
                                        <span id="filename-field-${product.id}-${field.id}">Nenhum ficheiro selecionado (Max 10MB)</span>
                                    </label>
                                    <input type="file" id="field-${product.id}-${field.id}" data-field-id="${field.id}" accept="image/*">
                                </div>`;
                        } else {
                             customFieldsHtml += `
                                <div class="form-group">
                                    <label for="field-${product.id}-${field.id}">${field.label}</label>
                                    <input type="${field.type}" id="field-${product.id}-${field.id}" data-field-id="${field.id}" placeholder="${field.placeholder || ''}">
                                </div>`;
                        }
                    });
                    customFieldsHtml += '</div>';
                }

                return `
                    <div class="product-card" id="form-${product.id}" data-product-id="${product.id}">
                        ${product.img ? `
                        <div class="product-image-thumb" data-img-src="${product.img}" data-img-alt="${product.name}">
                            <img src="${product.img}" alt="${product.name}">
                        </div>` : `<div class="product-image-thumb">${product.name.charAt(0)}</div>`}
                        
                        <div class="product-info">
                            <strong>${product.name}</strong>
                            <span class="product-price" id="price-display-${product.id}">A partir de ${formatCurrency(product.prices.pao_de_lo)}/kg</span>
                            
                            <div class="product-actions">
                                <div class="quantity-stepper">
                                    <button type="button" class="qty-minus" data-step="${step}" data-min="${min}">-</button>
                                    <input type="number" value="${min}" min="${min}" step="${step}" class="qty-input">
                                    <button type="button" class="qty-plus" data-step="${step}" data-min="${min}">+</button>
                                </div>
                            </div>
                            
                            ${customFieldsHtml}
                            
                            <button type="button" class="btn btn-secondary btn-add-cart" style="width: auto; padding: 8px 15px; font-size: 0.9rem; margin-top: 15px;">
                                Adicionar
                            </button>
                        </div>
                    </div>
                `;
            }
            
            function handleProductClick(e) {
                const target = e.target;
                const card = target.closest('.product-card');
                if (!card) return;
                
                const productId = card.dataset.productId;
                const product = B2C_PRODUCT_CATALOG.especiais.find(p => p.id === productId); // Apenas B2C tem esta lógica
                
                // Toggle de Upload de Imagem
                if (target.closest('.form-group-checkbox')) {
                    const checkWrapper = target.closest('.form-group-checkbox');
                    const checkbox = checkWrapper.querySelector('input[type="checkbox"]');
                    if (e.target !== checkbox) checkbox.checked = !checkbox.checked; // Simula clique
                    
                    const targetId = checkWrapper.dataset.toggles;
                    document.getElementById(`wrapper-${targetId}`).style.display = checkbox.checked ? 'block' : 'none';
                    updateB2CPrice(card, product);
                }
                
                // Atualiza preço dinâmico ao mudar tipo de bolo
                if (target.dataset.fieldId === 'tipo_bolo') {
                    updateB2CPrice(card, product);
                }
                
                // Upload de Ficheiro
                if (target.closest('.file-upload-wrapper')) {
                    card.querySelector('input[type="file"]').click();
                }
                if (target.type === 'file') {
                    target.addEventListener('change', () => {
                        const file = target.files[0];
                        if (file) {
                            if (file.size > 10 * 1024 * 1024) { // 10MB
                                showToast("Erro: Ficheiro demasiado grande (Max 10MB).");
                                target.value = ''; // Limpa
                            } else {
                                card.querySelector(`#filename-${target.id}`).textContent = file.name;
                                card.querySelector(`#wrapper-${target.id}`).classList.add('active');
                            }
                        }
                    });
                }
                
                if (target.closest('.product-image-thumb')) {
                    const thumb = target.closest('.product-image-thumb');
                    if(thumb.dataset.imgSrc) {
                        showImageModal(thumb.dataset.imgSrc, thumb.dataset.imgAlt);
                    }
                }
                
                const stepper = target.closest('.quantity-stepper');
                if (stepper) {
                    const input = stepper.querySelector('.qty-input');
                    const step = parseFloat(target.dataset.step || 1);
                    const min = parseFloat(target.dataset.min || 0);
                    let val = parseFloat(input.value);
                    
                    if (target.classList.contains('qty-plus')) {
                        val = (val < min) ? min : val + step;
                    } else if (target.classList.contains('qty-minus')) {
                        val = Math.max(0, val - step);
                    }
                    
                    input.value = (step < 1) ? val.toFixed(1) : val.toFixed(0);
                }
                
                if (target.classList.contains('btn-add-cart')) {
                    const quantity = parseFloat(card.querySelector('.qty-input').value);
                    if (quantity <= 0) {
                        showToast("Por favor, adicione uma quantidade válida.");
                        return;
                    }
                    
                    let customFields = {};
                    let customDesc = [];
                    let pricePerKg = product.prices.pao_de_lo; // Default
                    let extraCost = 0;
                    
                    if (product.customFields) {
                        const tipoBoloEl = card.querySelector('[data-field-id="tipo_bolo"]');
                        if (tipoBoloEl) {
                            pricePerKg = product.prices[tipoBoloEl.value] || pricePerKg;
                            customFields.tipo_bolo = tipoBoloEl.value;
                            customDesc.push(tipoBoloEl.options[tipoBoloEl.selectedIndex].text);
                        }
                        
                        card.querySelectorAll('[data-field-id]:not([type="file"]):not([type="select"])').forEach(field => {
                            if (field.type === 'checkbox') {
                                if (field.checked) {
                                    customFields[field.dataset.fieldId] = true;
                                    if(field.dataset.fieldId === 'imagem_check') extraCost += product.extras.imagem;
                                    customDesc.push(field.labels[0].textContent);
                                }
                            } else if (field.value) {
                                customFields[field.dataset.fieldId] = field.value;
                                customDesc.push(`${field.labels[0].textContent}: ${field.value}`);
                            }
                        });
                        
                        // Lidar com upload de ficheiro
                        const fileInput = card.querySelector('[data-field-id="imagem_upload"]');
                        if (fileInput && fileInput.files[0]) {
                            // Salva como Base64
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                customFields.imagem_upload = e.target.result; // Salva o Base64
                                // Adiciona ao carrinho SÓ DEPOIS de ler o ficheiro
                                addB2CItemToCart(product, quantity, pricePerKg, extraCost, customFields, customDesc.join(', '));
                            };
                            reader.readAsDataURL(fileInput.files[0]);
                            fileInput.value = ''; // Limpa
                            card.querySelector(`#filename-${fileInput.id}`).textContent = 'Nenhum ficheiro selecionado (Max 10MB)';
                            card.querySelector(`#wrapper-${fileInput.id}`).classList.remove('active');
                        } else {
                            // Adiciona imediatamente se não houver ficheiro
                            addB2CItemToCart(product, quantity, pricePerKg, extraCost, customFields, customDesc.join(', '));
                        }
                    } else {
                        // Para produtos simples (Natal, etc., se existirem)
                         addB2CItemToCart(product, quantity, product.price, 0, {}, "");
                    }
                    
                    // Resetar campos
                    card.querySelector('.qty-input').value = product.min || 1;
                    card.querySelectorAll('.bolo-aniversario-fields input[type="text"], .bolo-aniversario-fields input[type="number"], .bolo-aniversario-fields textarea').forEach(el => el.value = '');
                    card.querySelectorAll('.bolo-aniversario-fields input[type="checkbox"]').forEach(el => el.checked = false);
                    card.querySelector('[data-field-id="tipo_bolo"]').value = 'pao_de_lo';
                    document.getElementById('wrapper-field-B2C_BOLO_ANIV-imagem_upload').style.display = 'none';
                    updateB2CPrice(card, product);
                }
            }

            // Atualiza o preço "A partir de"
            function updateB2CPrice(card, product) {
                const tipoBolo = card.querySelector('[data-field-id="tipo_bolo"]').value;
                const price = product.prices[tipoBolo];
                card.querySelector(`#price-display-${product.id}`).textContent = `${formatCurrency(price)}/kg`;
            }

            function addB2CItemToCart(product, quantity, pricePerKg, extraCost, customFields, customDesc) {
                // Preço final do item é (preço/kg * kg) + extras
                const finalPrice = (pricePerKg * quantity) + extraCost;
                
                const cartId = `${product.id}_${JSON.stringify(customFields)}`;
                const existingItem = state.cart.find(item => item.cartId === cartId);
                
                if (existingItem) {
                    existingItem.quantity += parseFloat(quantity);
                    showToast(`Quantidade atualizada.`);
                } else {
                    const cartItem = {
                        cartId: cartId, id: product.id, name: product.name,
                        quantity: quantity, unit: product.unit.split(' ')[0],
                        price: pricePerKg, // Preço base (para cálculo)
                        totalPrice: finalPrice, // Preço total (com extras)
                        customFields: customFields, customDesc: customDesc
                    };
                    state.cart.push(cartItem);
                    showToast(`${quantity}x ${product.name} adicionado ao carrinho.`);
                }
                renderCart();
            }
            
            function handleCartItemRemove(e) {
                if (e.target.classList.contains('cart-item-remove')) {
                    const cartId = e.target.dataset.cartId;
                    state.cart = state.cart.filter(item => item.cartId !== cartId);
                    renderCart();
                    showToast("Item removido do carrinho.");
                }
            }

            function renderCart() {
                if (state.cart.length === 0) {
                    cartItemsList.innerHTML = '';
                    cartEmptyMsg.style.display = 'block';
                    cartTotalEl.textContent = 'Total: 0.00€';
                    checkoutBtn.disabled = true;
                    checkoutFormContainer.style.display = 'none';
                    return;
                }
                
                cartEmptyMsg.style.display = 'none';
                let html = '';
                let total = 0;
                
                state.cart.forEach(item => {
                    // O preço do item no carrinho é o (preço/kg * kg) + extras
                    const itemTotal = (item.price * item.quantity) + (item.customFields.imagem_check ? 3 : 0);
                    total += itemTotal;
                    
                    const qtyDisplay = item.unit === 'kg' ? `${item.quantity} kg` : `${item.quantity}x`;
                    
                    html += `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <strong>${qtyDisplay} ${item.name}</strong>
                                <span>${formatCurrency(itemTotal)}</span>
                                <span style="font-size: 0.8rem; color: var(--theme-text-light);">${item.customDesc}</span>
                            </div>
                            <button class="cart-item-remove" data-cart-id="${item.cartId}">&times;</button>
                        </div>
                    `;
                });
                
                cartItemsList.innerHTML = html;
                cartTotalEl.textContent = `Total: ${formatCurrency(total)}`;
                checkoutBtn.disabled = false;
            }
            
            function getMinPickupDate() {
                const now = new Date();
                const minDate = new Date();
                const cutoffHour = 15;
                
                if (now.getHours() >= cutoffHour) {
                    minDate.setDate(minDate.getDate() + 2);
                } else {
                    minDate.setDate(minDate.getDate() + 1);
                }
                minDate.setHours(0, 0, 0, 0);
                return minDate;
            }

            function initPickupDatePicker() {
                const minDate = getMinPickupDate();
                const minDateString = minDate.toISOString().split('T')[0];
                
                pickupDateInput.min = minDateString;
                
                const now = new Date();
                const cutoffHour = 15;
                if (now.getHours() >= cutoffHour) {
                    pickupDateNote.textContent = 'Encomendas após as 15h, levantamento a partir de depois de amanhã.';
                } else {
                    pickupDateNote.textContent = 'Encomendas antes das 15h, levantamento a partir de amanhã.';
                }
            }
            
            function handleOrderSubmit(e) {
                e.preventDefault();
                
                const selectedDateStr = pickupDateInput.value;
                const selectedTimeStr = pickupTimeInput.value;
                
                if (!selectedDateStr || !selectedTimeStr) {
                    showToast("Por favor, preencha a data e hora de levantamento.");
                    return;
                }
                
                const selectedDate = new Date(selectedDateStr + "T00:00:00");
                const minDate = getMinPickupDate();

                if (selectedDate < minDate) {
                    showToast("Data de levantamento inválida. Por favor, verifique as regras.");
                    initPickupDatePicker();
                    return;
                }
                
                if (selectedTimeStr < "08:00" || selectedTimeStr > "20:00") {
                    showToast("Hora de levantamento inválida. (Disponível das 08:00 às 20:00)");
                    return;
                }

                const orderId = `CN-${state.nextOrderId}`;
                state.nextOrderId++;
                
                const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity) + (item.customFields.imagem_check ? 3 : 0), 0);
                const orderDateISO = new Date().toISOString();
                const clientPhone = document.getElementById('b2c-telemovel').value;
                
                const newOrder = {
                    id: orderId,
                    type: 'particular', // TIPO DE ENCOMENDA
                    clientName: document.getElementById('b2c-nome-cliente').value,
                    clientPhone: clientPhone,
                    orderDate: orderDateISO,
                    pickupDate: `${selectedDateStr}T${selectedTimeStr}:00`,
                    pickupLocation: document.getElementById('b2c-pickup-location').value,
                    clientCode: document.getElementById('b2c-codigo-cliente').value || 'N/A',
                    total: total,
                    status: 'recebido',
                    paid: false,
                    items: state.cart.map(cartItem => ({
                        itemId: cartItem.id, name: cartItem.name, quantity: cartItem.quantity,
                        unit: cartItem.unit, price: cartItem.price, // preço/kg
                        totalPrice: (cartItem.price * cartItem.quantity) + (cartItem.customFields.imagem_check ? 3 : 0),
                        status: 'recebido',
                        customFields: cartItem.customFields
                    })),
                    timestamps: {
                        recebido: orderDateISO, producao: null, terminado: null,
                        levantado: null, cancelado: null
                    }
                };

                state.orders.push(newOrder);
                saveState();
                
                localStorage.setItem('currentUserPhone', clientPhone);
                
                state.cart = [];
                renderCart();
                b2cForm.reset();
                initPickupDatePicker();
                checkoutFormContainer.style.display = 'none';
                
                // CORREÇÃO: Trocar Modal por Toast
                showToast(`Encomenda #${orderId} recebida! Pode vê-la em "As Minhas".`);
            }
            
            // --- 3B. LÓGICA REVENDA (B2B) ---
            
            const b2bLoginScreen = document.getElementById('b2b-login-screen');
            const b2bOrderScreen = document.getElementById('b2b-order-screen');
            const b2bCountdown = document.getElementById('b2b-countdown');
            const b2bProductList = document.getElementById('b2b-product-list-container');
            const b2bSearchInput = document.getElementById('b2b-search-input');
            
            function initB2BPage() {
                document.getElementById('b2b-login-form').addEventListener('submit', handleB2BLogin);
                document.getElementById('b2b-submit-order').addEventListener('click', handleB2BOrderSubmit);
                b2bSearchInput.addEventListener('input', handleB2BSearch);
                b2bProductList.addEventListener('change', saveB2BOrder); // Salva ao mudar quantidade
            }

            function checkB2BLogin() {
                const storedUser = localStorage.getItem('b2bUser');
                if (storedUser && B2B_USERS[storedUser]) { // Valida se o user guardado ainda existe
                    state.b2bUser = storedUser;
                    showB2BOrderScreen(storedUser);
                } else {
                    b2bLoginScreen.style.display = 'block';
                    b2bOrderScreen.style.display = 'none';
                }
            }

            function handleB2BLogin(e) {
                e.preventDefault();
                const user = document.getElementById('b2b-username').value;
                const pass = document.getElementById('b2b-password').value;

                if (B2B_USERS[user] && B2B_USERS[user] === pass) {
                    state.b2bUser = user;
                    localStorage.setItem('b2bUser', user);
                    showB2BOrderScreen(user);
                } else {
                    showToast("Utilizador ou palavra-passe inválidos.");
                }
            }
            
            function showB2BOrderScreen(user) {
                b2bLoginScreen.style.display = 'none';
                b2bOrderScreen.style.display = 'block';
                document.getElementById('b2b-welcome-msg').textContent = `Bem-vindo, ${user}!`;
                
                startB2BCountdown();
                renderB2BCatalog(); // Renderiza o catálogo
                loadB2BOrder(); // Carrega a encomenda guardada
            }
            
            function startB2BCountdown() {
                if (state.b2bCountdownTimer) clearInterval(state.b2bCountdownTimer);
                
                const b2bCutoff = new Date();
                b2bCutoff.setHours(19, 0, 0, 0); // 19:00:00
                
                state.b2bCountdownTimer = setInterval(() => {
                    const now = new Date();
                    let diff = b2bCutoff - now;
                    
                    if (diff < 0) { // Já passou das 19h
                        b2bCountdown.textContent = "00:00:00";
                        document.getElementById('b2b-submit-order').disabled = true;
                        document.getElementById('b2b-submit-order').textContent = "Encomendas para amanhã fechadas";
                        return;
                    }
                    
                    const hours = Math.floor(diff / 3600000).toString().padStart(2, '0');
                    diff %= 3600000;
                  const minutes = Math.floor(diff / 60000).toString().padStart(2, '0');
                    diff %= 60000;
                    const seconds = Math.floor(diff / 1000).toString().padStart(2, '0');
                    
                    b2bCountdown.textContent = `${hours}:${minutes}:${seconds}`;
                    
                    // Verifica se a encomenda já foi feita
                    const orderKey = getB2BOrderKey(state.b2bUser, 1); // 1 = amanhã
                    const existingOrder = localStorage.getItem(orderKey);
                    const headerCard = document.querySelector('.b2b-header-card');
                    
                    if (!existingOrder) {
                        b2bCountdown.previousElementSibling.textContent = "Ainda não fez a sua encomenda para amanhã. Encomendas fecham às 19:00h.";
                        headerCard.style.backgroundColor = 'var(--status-cancelado)'; // Alerta
                    } else {
                        b2bCountdown.previousElementSibling.textContent = "A sua encomenda para amanhã está guardada. Pode atualizá-la até às 19:00h.";
                        headerCard.style.backgroundColor = 'var(--status-terminado)'; // OK
                    }
                    document.getElementById('b2b-submit-order').disabled = false;
                    document.getElementById('b2b-submit-order').textContent = "Enviar/Atualizar Encomenda para Amanhã";

                }, 1000);
            }
            
            // Função para normalizar texto (para pesquisa)
            function normalizeText(text) {
                return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }

            function renderB2BCatalog() {
                let html = '';
                for (const category in B2B_CATALOG) {
                    html += `
                        <details class="b2b-accordion-section" open>
                            <summary>${category}</summary>
                            <div class="b2b-accordion-content">
                    `;
                    
                    B2B_CATALOG[category].forEach(product => {
                        if (product.isBirthdayCake) {
                            // O bolo de aniversário é um card especial
                            html += createB2BBirthdayCakeCard(product);
                        } else {
                            // Item normal
                            html += createB2BProductItem(product);
                        }
                    });
                    
                    html += `
                            </div>
                        </details>
                    `;
                }
                b2bProductList.innerHTML = html;
                
                // Adicionar listeners para os bolos (upload, etc)
                b2bProductList.querySelectorAll('.product-card[data-product-id="B2B_BOLO_ANIV"]').forEach(card => {
                    card.addEventListener('click', handleB2BCakeCardClick);
                    card.addEventListener('change', handleB2BCakeCardClick); // Para selects
                });
                b2bProductList.querySelectorAll('.b2b-product-item .qty-input').forEach(input => {
                    input.addEventListener('change', saveB2BOrder);
                });
                b2bProductList.querySelectorAll('.b2b-product-item .quantity-stepper button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const input = e.target.closest('.quantity-stepper').querySelector('input');
                        const step = parseInt(input.step) || 1;
                        let val = parseInt(input.value) || 0;
                        if (e.target.classList.contains('qty-plus')) {
                            val += step;
                        } else if (e.target.classList.contains('qty-minus')) {
                            val = Math.max(0, val - step);
                        }
                        input.value = val;
                        saveB2BOrder(); // Salva
                    });
                });
            }
            
            function createB2BProductItem(product) {
                const step = product.step || 1;
                const min = product.min || 0;
                const isKg = product.unit.toLowerCase() === 'kg';
                const priceDisplay = `${formatCurrency(product.price)} / ${product.unit} ${product.iva ? '(+IVA)' : ''}`;

                return `
                    <div class="b2b-product-item" data-name="${normalizeText(product.name)}">
                        <div class="b2b-placeholder-img">${product.name.charAt(0)}</div>
                        <div class="b2b-product-info">
                            <strong>${product.name}</strong>
                            <span class="b2b-price">${priceDisplay}</span>
                        </div>
                        <div class="quantity-stepper">
                            <button type="button" class="qty-minus">-</button>
                            <input type="number" value="0" min="${min}" step="${step}" class="qty-input" data-product-id="${product.id}" ${isKg ? '' : 'pattern="[0-9]*"'} >
                            <button type="button" class="qty-plus">+</button>
                        </div>
                    </div>
                `;
            }
            
            function createB2BBirthdayCakeCard(product) {
                // Reutiliza a lógica do B2C mas com preços B2B
                const step = product.step || 1;
                const min = product.min || 1.0;
                
                let customFieldsHtml = '';
                if (product.customFields) {
                    customFieldsHtml = '<div class="bolo-aniversario-fields">';
                    product.customFields.forEach(field => {
                        const fieldId = `field-${product.id}-${field.id}`;
                        if (field.type === 'select') {
                            customFieldsHtml += `
                                <div class="form-group">
                                    <label for="${fieldId}">${field.label}</label>
                                    <select id="${fieldId}" data-field-id="${field.id}">
                                        ${field.options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                    </select>
                                </div>`;
                        } else if (field.type === 'checkbox') {
                             customFieldsHtml += `
                                <div class="form-group form-group-checkbox" data-toggles="${fieldId}-upload">
                                    <input type="checkbox" id="${fieldId}" data-field-id="${field.id}">
                                    <label for="${fieldId}">${field.label}</label>
                                    <span class="price-tag">+${formatCurrency(product.extras.imagem)}</span>
                                </div>`;
                        } else if (field.type === 'file') {
                            const wrapperId = `${fieldId}-upload`; // Corresponde ao data-toggles
                            customFieldsHtml += `
                                <div class="form-group file-upload-wrapper" id="wrapper-${wrapperId}" style="${field.hidden ? 'display: none;' : ''}">
                                    <label for="${fieldId}">
                                        Carregar Ficheiro
                                        <span id="filename-${fieldId}">Nenhum ficheiro selecionado (Max 10MB)</span>
                                    </label>
                                    <input type="file" id="${fieldId}" data-field-id="${field.id}" accept="image/*">
                                </div>`;
                        } else {
                            customFieldsHtml += `
                                <div class="form-group">
                                    <label for="${fieldId}">${field.label}</label>
                                    <${field.type === 'textarea' ? 'textarea' : 'input type="' + field.type + '"'}
                                        id="${fieldId}" data-field-id="${field.id}" placeholder="${field.placeholder || ''}"
                                    >${field.type === 'textarea' ? '</textarea>' : ''}
                                </div>`;
                        }
                    });
                    customFieldsHtml += '</div>';
                }
                
                return `
                <div class="product-card" data-name="${normalizeText(product.name)}" data-product-id="${product.id}">
                    <div class="product-image-thumb">${product.name.charAt(0)}</div>
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <span class="product-price" id="price-display-${product.id}">A partir de ${formatCurrency(product.prices.pao_de_lo)}/kg</span>
                        <div class="product-actions">
                            <div class="quantity-stepper">
                                <button type="button" class="qty-minus" data-step="${step}" data-min="${min}">-</button>
                                <input type="number" value="0" min="0" step="${step}" class="qty-input" data-product-id="${product.id}">
                                <button type="button" class="qty-plus" data-step="${step}" data-min="${min}">+</button>
                            </div>
                        </div>
                        ${customFieldsHtml}
                    </div>
                </div>
                `;
            }

            function handleB2BCakeCardClick(e) {
                const target = e.target;
                const card = target.closest('.product-card');
                if (!card) return;
                
                const product = B2B_CATALOG["Bolos Especiais"].find(p => p.id === card.dataset.productId);
                if (!product) return;
                
                // Toggle de Upload de Imagem
                if (target.closest('.form-group-checkbox')) {
                    const checkWrapper = target.closest('.form-group-checkbox');
                    const checkbox = checkWrapper.querySelector('input[type="checkbox"]');
                    if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
                    const targetId = checkWrapper.dataset.toggles;
                    document.getElementById(`wrapper-${targetId}`).style.display = checkbox.checked ? 'block' : 'none';
                }
                
                // Atualiza preço dinâmico
                if (target.dataset.fieldId === 'tipo_bolo') {
                    const tipoBolo = target.value;
                    const price = product.prices[tipoBolo];
                    card.querySelector(`#price-display-${product.id}`).textContent = `${formatCurrency(price)}/kg`;
                }
                
                // Stepper
                const stepper = target.closest('.quantity-stepper');
                if (stepper) {
                    const input = stepper.querySelector('.qty-input');
                    const step = parseFloat(target.dataset.step || 1);
                    const min = parseFloat(target.dataset.min || 0);
                    let val = parseFloat(input.value) || 0;
                    
                    if (target.classList.contains('qty-plus')) {
                        val = (val < min && val == 0) ? min : val + step;
                    } else if (target.classList.contains('qty-minus')) {
                        val = Math.max(0, val - step);
                    }
                    input.value = (step < 1) ? val.toFixed(1) : val.toFixed(0);
                }

                // Upload
                if (target.closest('.file-upload-wrapper')) card.querySelector('input[type="file"]').click();
                if (target.type === 'file') {
                    target.addEventListener('change', () => {
                        const file = target.files[0];
                        if (file) {
                            if (file.size > 10 * 1024 * 1024) { // 10MB
                                showToast("Erro: Ficheiro demasiado grande (Max 10MB).");
                                target.value = '';
                            } else {
                                card.querySelector(`#filename-${target.id}`).textContent = file.name;
                                card.querySelector(`#wrapper-${target.id}-upload`).classList.add('active');
                            }
                        }
                    });
                }
                
                saveB2BOrder(); // Salva qualquer alteração
            }

            function handleB2BSearch(e) {
                const query = normalizeText(e.target.value);
                
                b2bProductList.querySelectorAll('.b2b-accordion-section').forEach(section => {
                    let sectionVisible = false;
                    // Pesquisa em items normais e bolos (cards)
                    section.querySelectorAll('.b2b-product-item, .product-card').forEach(item => {
                        const name = item.dataset.name;
                        const isVisible = name.includes(query);
                        item.style.display = isVisible ? (item.classList.contains('b2b-product-item') ? 'grid' : 'flex') : 'none';
                        if (isVisible) sectionVisible = true;
                    });
                    
                    // Esconde a secção inteira se nenhum item corresponder
                    section.style.display = sectionVisible ? 'block' : 'none';
                    if (sectionVisible && query) {
                        section.open = true; // Abre secções com resultados
                    }
                });
            }

            // Gera a chave de storage (ex: b2b_maxipao_2025-11-02)
            function getB2BOrderKey(user, dayOffset = 0) {
                const date = new Date();
                date.setDate(date.getDate() + dayOffset);
                const dateString = date.toISOString().split('T')[0];
                return `b2b_${user}_${dateString}`;
            }
            
            // Salva a encomenda B2B em progresso
            function saveB2BOrder() {
                const orderKey = getB2BOrderKey(state.b2bUser, 1); // Encomenda de hoje para amanhã
                let currentOrder = {};
                
                // Items normais
                b2bProductList.querySelectorAll('.b2b-product-item .qty-input').forEach(input => {
                    const qty = input.valueAsNumber;
                    if (qty > 0) {
                        currentOrder[input.dataset.productId] = { quantity: qty };
                    }
                });
                
                // Bolo de Aniversário
                b2bProductList.querySelectorAll('.product-card[data-product-id="B2B_BOLO_ANIV"]').forEach(card => {
                    const qty = parseFloat(card.querySelector('.qty-input').value);
                    if (qty > 0) {
                        let customFields = {};
                        card.querySelectorAll('[data-field-id]').forEach(field => {
                            if (field.type === 'checkbox') {
                                customFields[field.dataset.fieldId] = field.checked;
                            } else if (field.type !== 'file') {
                                customFields[field.dataset.fieldId] = field.value;
                            }
                        });
                        // Lidamos com o ficheiro no submit, por agora guardamos os campos
                        currentOrder[card.dataset.productId] = { quantity: qty, customFields: customFields };
                    }
                });

                localStorage.setItem(orderKey, JSON.stringify(currentOrder));
                state.currentB2BOrder = currentOrder; // Guarda em state também
            }
            
            // Carrega a encomenda B2B guardada
            function loadB2BOrder() {
                const orderKey = getB2BOrderKey(state.b2bUser, 1); // Encomenda para amanhã
                const savedOrder = localStorage.getItem(orderKey);
                if (!savedOrder) {
                    state.currentB2BOrder = {};
                    return;
                }
                
                const order = JSON.parse(savedOrder);
                state.currentB2BOrder = order;
                
                for (const productId in order) {
                    const item = order[productId];
                    
                    if (productId === 'B2B_BOLO_ANIV') {
                        const card = b2bProductList.querySelector(`.product-card[data-product-id="${productId}"]`);
                        if (card) {
                            card.querySelector('.qty-input').value = item.quantity;
                            for(const fieldId in item.customFields) {
                                const field = card.querySelector(`[data-field-id="${fieldId}"]`);
                                if (field) {
                                    if (field.type === 'checkbox') {
                                        field.checked = item.customFields[fieldId];
                                        // Dispara o toggle da imagem
                                        if (fieldId === 'imagem_check' && field.checked) {
                                            const wrapper = document.getElementById(`wrapper-field-${productId}-imagem_upload`);
                                            if (wrapper) wrapper.style.display = 'block';
                                        }
                                    } else {
                                        field.value = item.customFields[fieldId];
                                    }
                                }
                            }
                        }
                    } else {
                        const input = b2bProductList.querySelector(`.qty-input[data-product-id="${productId}"]`);
                        if (input) {
                            input.value = item.quantity;
                        }
                    }
                }
            }
            
            async function handleB2BOrderSubmit() {
                const btn = document.getElementById('b2b-submit-order');
                btn.disabled = true;
                btn.textContent = 'A processar...';
                
                saveB2BOrder(); // Garante que os dados mais recentes estão no state
                const orderData = state.currentB2BOrder;
                
                if (Object.keys(orderData).length === 0) {
                    showToast("Não tem nenhum item na encomenda.");
                    btn.disabled = false;
                    btn.textContent = "Enviar/Atualizar Encomenda para Amanhã";
                    return;
                }

                const orderId = `REV-${state.b2bUser.toUpperCase()}-${state.nextOrderId}`;
                state.nextOrderId++;
                
                const orderDateISO = new Date().toISOString();
                const pickupDate = new Date();
                pickupDate.setDate(pickupDate.getDate() + 1);
                pickupDate.setHours(9, 0, 0, 0); // Revenda levanta às 9h por defeito
                
                let total = 0;
                let items = [];
                let allProducts = Object.values(B2B_CATALOG).flat();

                // Processa o bolo de aniversário primeiro (para o upload)
                const cakeData = orderData['B2B_BOLO_ANIV'];
                if (cakeData && cakeData.quantity > 0) {
                    const product = allProducts.find(p => p.id === 'B2B_BOLO_ANIV');
                    const pricePerKg = product.prices[cakeData.customFields.tipo_bolo];
                    let extraCost = 0;
                    let customFields = { ...cakeData.customFields };
                    
                    if (customFields.imagem_check) {
                        extraCost += product.extras.imagem;
                        const fileInput = document.getElementById('field-B2B_BOLO_ANIV-imagem_upload');
                        if (fileInput && fileInput.files[0]) {
                            try {
                                customFields.imagem_upload = await fileToBase64(fileInput.files[0]);
                            } catch (err) {
                                showToast("Erro a processar a imagem.");
                            }
                        }
                    }
                    
                    const itemTotal = (pricePerKg * cakeData.quantity) + extraCost;
                    total += itemTotal;
                    items.push({
                        itemId: product.id, name: product.name, quantity: cakeData.quantity,
                        unit: product.unit, price: pricePerKg, totalPrice: itemTotal,
                        status: 'recebido', customFields: customFields, iva: (product.iva || false)
                    });
                }
                
                // Processa items normais
                for (const productId in orderData) {
                    if (productId === 'B2B_BOLO_ANIV') continue; // Já tratado
                    
                    const product = allProducts.find(p => p.id === productId);
                    if (product) {
                        const item = orderData[productId];
                        const itemTotal = product.price * item.quantity;
                        total += itemTotal;
                        items.push({
                            itemId: product.id, name: product.name, quantity: item.quantity,
                            unit: product.unit, price: product.price, totalPrice: itemTotal,
                            status: 'recebido', customFields: {}, iva: (product.iva || false)
                        });
                    }
                }
                
                const newOrder = {
                    id: orderId,
                    type: 'revenda',
                    clientName: state.b2bUser,
                    clientPhone: 'N/A',
                    orderDate: orderDateISO,
                    pickupDate: pickupDate.toISOString(),
                    pickupLocation: 'Revenda',
                    clientCode: state.b2bUser,
                    total: total,
                    status: 'recebido',
                    paid: false,
                    items: items,
                    timestamps: {
                        recebido: orderDateISO, producao: null, terminado: null,
                        levantado: null, cancelado: null
                    }
                };
                
                // Verifica se já existe uma encomenda para amanhã e substitui
                const existingOrderIndex = state.orders.findIndex(o =>
                    o.type === 'revenda' &&
                    o.clientName === state.b2bUser &&
                    o.pickupDate.startsWith(pickupDate.toISOString().split('T')[0])
                );
                
                if (existingOrderIndex > -1) {
                    newOrder.id = state.orders[existingOrderIndex].id; // Mantém o ID original
                    state.orders[existingOrderIndex] = newOrder;
                    showToast("Encomenda atualizada com sucesso!");
                } else {
                    state.orders.push(newOrder);
                    showToast("Encomenda enviada com sucesso!");
                }

                saveState();
                playConfettiEffect();
                startB2BCountdown(); // Atualiza a mensagem de "encomenda feita"
                
                // Limpa campos de upload
                document.querySelectorAll('#b2b-order-screen input[type="file"]').forEach(input => {
                    input.value = '';
                    document.getElementById(`filename-${input.id}`).textContent = 'Nenhum ficheiro selecionado (Max 10MB)';
                    document.getElementById(`wrapper-${input.id}-upload`).classList.remove('active');
                });
            }
            
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // --- 4. PÁGINA "MINHAS ENCOMENDAS" (B2C) ---
            
            const myOrdersPage = document.getElementById('page-my-orders');
            const myOrdersLogin = document.getElementById('my-orders-login');
            const myOrdersLoginForm = document.getElementById('my-orders-login-form');
            const myOrdersLoginInput = document.getElementById('my-orders-phone-input');
            const myOrdersListContainer = document.getElementById('my-orders-list-container');
            const myOrdersList = document.getElementById('my-orders-list');
            const myOrdersPhoneDisplay = document.getElementById('my-orders-phone-display');
            const myOrdersLogoutBtn = document.getElementById('my-orders-logout-btn');

            function initMyOrdersPage() {
                myOrdersLoginForm.addEventListener('submit', handleMyOrdersLogin);
                myOrdersLogoutBtn.addEventListener('click', handleMyOrdersLogout);
                renderMyOrdersPage();
            }

            function handleMyOrdersLogin(e) {
                e.preventDefault();
                const phone = myOrdersLoginInput.value;
                if (phone) {
                    localStorage.setItem('currentUserPhone', phone);
                    renderMyOrdersPage();
                }
            }

            function handleMyOrdersLogout() {
                localStorage.removeItem('currentUserPhone');
                myOrdersLoginInput.value = '';
                renderMyOrdersPage();
            }

            function renderMyOrdersPage() {
                const phone = localStorage.getItem('currentUserPhone');
                
                if (!phone) {
                    myOrdersLogin.style.display = 'block';
                    myOrdersListContainer.style.display = 'none';
                } else {
                    myOrdersLogin.style.display = 'none';
                    myOrdersListContainer.style.display = 'block';
                    myOrdersPhoneDisplay.textContent = phone;
                    
                    const clientOrders = state.orders
                        .filter(o => o.type === 'particular' && o.clientPhone === phone)
                        .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                        
                    if (clientOrders.length === 0) {
                        myOrdersList.innerHTML = '<p class="card">Ainda não tem encomendas registadas com este número.</p>';
                        return;
                    }
                    
                    myOrdersList.innerHTML = clientOrders.map(createMyOrderTicket).join('');
                }
            }
            
            function createMyOrderTicket(order) {
                const pickupDate = new Date(order.pickupDate);
                
                const statusMap = {
                    recebido: 'Recebida',
                    producao: 'Em Produção',
                    terminado: 'Pronta a Levantar',
                    levantado: 'Levantada',
                    cancelado: 'Cancelada'
                };
                
                return `
                <div class="card order-ticket my-order-ticket status-${order.status}">
                    <div class="ticket-header">
                        <strong>Encomenda #${order.id}</strong>
                        <span class="ticket-id" style="color: var(--theme-primary); font-weight: 700;">${statusMap[order.status] || order.status}</span>
                    </div>
                    <div class="ticket-details">
                        <p><strong>Levantamento:</strong> ${formatDateTime(pickupDate)}</p>
                        <p><strong>Local:</strong> ${order.pickupLocation}</p>
                        <p><strong>Total:</strong> ${formatCurrency(order.total)}</p>
                        <p><strong>Pagamento:</strong> <span style="font-weight: 700; color: ${order.paid ? 'var(--status-terminado)' : 'var(--status-cancelado)'}">${order.paid ? 'Pago' : 'Pendente'}</span></p>
                    </div>
                    <div class="ticket-items">
                        <strong>Itens:</strong>
                        <ul class="ticket-items-list" style="max-height: none; list-style-type: none; padding-left: 0;">
                            ${order.items.map(item => {
                                const qtyDisplay = item.unit === 'kg' ? `${item.quantity} kg` : `${item.quantity}x`;
                                let desc = `<li>- ${qtyDisplay} ${item.name}</li>`;
                                if (item.customFields) {
                                    if (item.customFields.tipo_bolo) desc += `<li style="font-size: 0.9em; padding-left: 10px;">&nbsp;&nbsp;Tipo: ${item.customFields.tipo_bolo}</li>`;
                                    if (item.customFields.nome_aniversariante) desc += `<li style="font-size: 0.9em; padding-left: 10px;">&nbsp;&nbsp;Nome: ${item.customFields.nome_aniversariante}</li>`;
                                    if (item.customFields.imagem_check) desc += `<li style="font-size: 0.9em; padding-left: 10px;">&nbsp;&nbsp;Com Imagem</li>`;
                                }
                                return desc;
                            }).join('')}
                        </ul>
                    </div>
                </div>`;
            }

            // --- 5. PÁGINA STAFF ---
            
            const staffOrderList = document.getElementById('staff-order-list');
            const noOrdersMsg = document.getElementById('no-orders-message');
            
            const staffControls = document.querySelector('.staff-controls');
            const staffTypeParticularBtn = document.getElementById('staff-type-toggle-particular');
            const staffTypeRevendaBtn = document.getElementById('staff-type-toggle-revenda');
            const staffViewOrderBtn = document.getElementById('staff-view-toggle-order');
            const staffViewItemAggBtn = document.getElementById('staff-view-toggle-item');
            
            const staffSearchInput = document.getElementById('staff-search-input');
            const staffFilterStatus = document.getElementById('staff-filter-status');
            const staffSortBy = document.getElementById('staff-sort-by');
            const staffFilterPickupDate = document.getElementById('staff-filter-pickup-date');
            const staffFilterOrderDate = document.getElementById('staff-filter-order-date');

            function initStaffPage() {
                staffFilterStatus.value = 'all_active';
                staffSortBy.value = 'pickupDateAsc';
                
                // Toggles Principais (Tipo)
                staffTypeParticularBtn.addEventListener('click', () => setStaffType('particular'));
                staffTypeRevendaBtn.addEventListener('click', () => setStaffType('revenda'));
                
                // Toggles Secundários (View)
                staffViewOrderBtn.addEventListener('click', () => setStaffView('order'));
                staffViewItemAggBtn.addEventListener('click', () => setStaffView('item_agg'));
                
                [staffSearchInput, staffFilterStatus, staffSortBy, staffFilterPickupDate, staffFilterOrderDate].forEach(el => {
                    el.addEventListener('input', renderStaffPage);
                });
                
                staffOrderList.addEventListener('click', handleStaffTicketClick);
                
                setStaffType(state.staffType); // Inicia a view
            }
            
            function setStaffType(type) {
                state.staffType = type;
              staffTypeParticularBtn.classList.toggle('active', type === 'particular');
                staffTypeRevendaBtn.classList.toggle('active', type === 'revenda');
                
                const pickupDateFilter = staffFilterPickupDate.parentElement;
                const orderDateFilter = staffFilterOrderDate.parentElement;

                // A view agregada só existe para revenda
                if (type === 'particular') {
                    staffViewItemAggBtn.style.display = 'none';
                    staffControls.classList.remove('revenda-view');
                    // Filtros normais para particular
                    pickupDateFilter.style.display = 'block';
                    orderDateFilter.style.display = 'block';
                    // Se estava na view agregada, força a volta para 'order'
                    if (state.staffView === 'item_agg') {
                        setStaffView('order');
                    }
                } else { // Revenda
                    staffViewItemAggBtn.style.display = 'block';
                    staffControls.classList.add('revenda-view');
                    // Filtro de data de encomenda não faz sentido para revenda (é sempre 'ontem')
                    orderDateFilter.style.display = 'none';
                    // Filtro de data de levantamento é o mais importante
                    pickupDateFilter.style.display = 'block';
                    // Define a data de levantamento para hoje por defeito
                    if (!staffFilterPickupDate.value) {
                        staffFilterPickupDate.value = new Date().toISOString().split('T')[0];
                    }
                }
                
                renderStaffPage();
            }
            
            function setStaffView(view) {
                state.staffView = view;
                staffViewOrderBtn.classList.toggle('active', view === 'order');
                staffViewItemAggBtn.classList.toggle('active', view === 'item_agg');
                renderStaffPage();
            }
            
            function getFilteredAndSortedData() {
                const search = normalizeText(staffSearchInput.value);
                const status = staffFilterStatus.value;
                const sort = staffSortBy.value;
                const pickupDate = staffFilterPickupDate.value;
                const orderDate = staffFilterOrderDate.value;
                
                // 1. Filtra por TIPO (Particular / Revenda)
                let data = state.orders.filter(o => o.type === state.staffType);
                
                // 2. Aplica filtros de UI
                let filteredData = data.filter(d => {
                    const clientName = normalizeText(d.clientName);
                    if (search && !clientName.includes(search)) return false;
                    
                    const itemStatus = d.status;
                    if (status === 'all_active' && (itemStatus === 'levantado' || itemStatus === 'cancelado')) return false;
                    else if (status !== 'all' && status !== 'all_active' && itemStatus !== status) return false;
                    
                    if (pickupDate && !d.pickupDate.startsWith(pickupDate)) return false;
                    
                    if (orderDate && state.staffType === 'particular' && !d.orderDate.startsWith(orderDate)) return false;
                    
                    return true;
                });
                
                // 3. Ordena
                filteredData.sort((a, b) => {
                    switch (sort) {
                        case 'pickupDateAsc': return new Date(a.pickupDate) - new Date(b.pickupDate);
                        case 'pickupDateDesc': return new Date(b.pickupDate) - new Date(a.pickupDate);
                        case 'orderDateAsc': return new Date(a.orderDate) - new Date(b.orderDate);
                        case 'orderDateDesc': return new Date(b.orderDate) - new Date(a.orderDate);
                        default: return new Date(a.pickupDate) - new Date(b.pickupDate);
                    }
                });
                
                return filteredData;
            }

            function renderStaffPage() {
                const data = getFilteredAndSortedData();
                
                renderStaffSubtotals(data); // Renderiza os subtotais
                
                if (data.length === 0) {
                    staffOrderList.innerHTML = '';
                    staffOrderList.appendChild(noOrdersMsg.cloneNode(true));
                    return;
                }
                
                let html = '';
                if (state.staffType === 'revenda' && state.staffView === 'item_agg') {
                    html = renderStaffAggregatedView(data);
                } else {
                    // A "view por item" (antiga) foi removida, agora é "agregada" ou "encomenda"
                    html = data.map(createOrderTicket).join('');
                }
                staffOrderList.innerHTML = html;
            }
            
            function renderStaffSubtotals(data) {
                let pending = 0;
                let paid = 0;
                
                data.forEach(order => {
                    if (order.paid) {
                        paid += order.total;
                    } else if (order.status !== 'cancelado') {
                        pending += order.total;
                    }
                });
                
                document.getElementById('staff-subtotal-pending').textContent = `Pendente: ${formatCurrency(pending)}`;
                document.getElementById('staff-subtotal-paid').textContent = `Pago: ${formatCurrency(paid)}`;
            }
            
            function renderStaffAggregatedView(data) {
                const itemMap = new Map();
                
                // 1. Agregar todos os items
                data.forEach(order => {
                    order.items.forEach(item => {
                        const key = item.name; // Agrega por nome
                        if (!itemMap.has(key)) {
                            itemMap.set(key, {
                                totalQty: 0,
                                unit: item.unit.toLowerCase() === 'kg' ? 'kg' : 'unid',
                                sources: [] // [ {orderId, clientName, qty} ]
                            });
                        }
                        const aggItem = itemMap.get(key);
                        aggItem.totalQty += parseFloat(item.quantity);
                        aggItem.sources.push({ orderId: order.id, clientName: order.clientName, qty: item.quantity, status: item.status });
                    });
                });
                
                // 2. Ordenar o mapa por nome
                const sortedItems = new Map([...itemMap.entries()].sort());
                
                // 3. Gerar HTML
                let html = '';
                sortedItems.forEach((item, name) => {
                    const qtyDisplay = `${item.totalQty.toFixed(item.unit === 'kg' ? 1 : 0)} ${item.unit}`;
                    // Lógica de status agregado
                    const allSources = item.sources;
                    const isTerminado = allSources.every(s => s.status === 'terminado' || s.status === 'levantado');
                    const isProducao = allSources.some(s => s.status === 'producao');
                    let status = 'recebido';
                    if (isTerminado) status = 'terminado';
                    else if (isProducao) status = 'producao';
                    
                    html += `
                    <div class="card order-ticket status-${status}" data-agg-item-name="${name}">
                        <div class="ticket-header">
                            <strong>${name}</strong>
                            <span class="ticket-id" style="font-size: 1.2rem; color: var(--theme-primary);">${qtyDisplay} Total</span>
                        </div>
                        <div class="ticket-items">
                            <strong>Origem (${item.sources.length} clientes):</strong>
                            <ul class="ticket-items-list ${item.sources.length > 3 ? 'expandable' : ''}">
                                ${item.sources.map(src => `<li><strong>${src.qty} ${item.unit}</strong> - ${src.clientName} (#${src.orderId})</li>`).join('')}
                            </ul>
                            ${item.sources.length > 3 ? '<button class="expand-items-btn" data-action="expand-items">[Ver Todos]</button>' : ''}
                        </div>
                        <div class="order-status-segmented">
                            <button data-action="set-agg-status" data-status="producao" class="${status === 'producao' ? 'active' : ''}">Em Produção</button>
                            <button data-action="set-agg-status" data-status="terminado" class="${status === 'terminado' ? 'active' : ''}">Marcar Todos Terminados</button>
                        </div>
                    </div>
                    `;
                });
                return html;
            }

            function createOrderTicket(order) {
                const orderDate = new Date(order.orderDate);
                const pickupDate = new Date(order.pickupDate);
                const needsExpansion = order.items.length > 3;
                
                let itemHtml = '';
                let imageActionsHtml = '';
                
                order.items.forEach((item, index) => {
                    const qtyDisplay = item.unit === 'kg' ? `${parseFloat(item.quantity).toFixed(1)} kg` : `${parseInt(item.quantity)}x`;
                    let itemDesc = `
                        <li>
                            ${qtyDisplay} ${item.name}
                            <span class="item-status item-status-${item.status}">${item.status}</span>
                        </li>`;
                    
                    // Detalhes do bolo
                    if (item.customFields) {
                        const cf = item.customFields;
                        const tipoBolo = cf.tipo_bolo ? (B2C_PRODUCT_CATALOG.especiais[0].customFields[0].options.find(o => o.value === cf.tipo_bolo)?.text || cf.tipo_bolo) : null;
                        if (tipoBolo) itemDesc += `<li style="font-size: 0.9em; padding-left: 10px; color: var(--theme-text-dark);">&nbsp;&nbsp;↳ Tipo: ${tipoBolo}</li>`;
                        if (cf.nome_aniversariante) itemDesc += `<li style="font-size: 0.9em; padding-left: 10px; color: var(--theme-text-dark);">&nbsp;&nbsp;↳ Nome: ${cf.nome_aniversariante}</li>`;
                        if (cf.idade_aniversariante) itemDesc += `<li style="font-size: 0.9em; padding-left: 10px; color: var(--theme-text-dark);">&nbsp;&nbsp;↳ Idade: ${cf.idade_aniversariante}</li>`;
                        if (cf.obs_bolo) itemDesc += `<li style="font-size: 0.9em; padding-left: 10px; color: var(--theme-text-dark);">&nbsp;&nbsp;↳ Obs: ${cf.obs_bolo}</li>`;
                        
                        if (cf.imagem_check) {
                            itemDesc += `<li style="font-size: 0.9em; padding-left: 10px; color: var(--theme-primary); font-weight: 700;">&nbsp;&nbsp;↳ COM IMAGEM</li>`;
                            if (cf.imagem_upload) {
                                imageActionsHtml += `
                                    <div class="ticket-image-actions">
                                        <button class="btn btn-secondary" data-action="view-image" data-item-index="${index}">Ver Imagem (${item.name})</button>
                                    </div>
                                `;
                            }
                        }
                    }
                    itemHtml += itemDesc;
                });

                return `
                <div class="card order-ticket status-${order.status}" data-order-id="${order.id}">
                    <div class="ticket-header">
                        <strong>${order.clientName}</strong>
                        <span class="ticket-id" style="font-size: 1.2rem; color: var(--theme-primary);">${formatCurrency(order.total)}</span>
                    </div>
                    <div class="ticket-details">
                        <p><strong>Levantamento:</strong> ${formatDateTime(pickupDate)}</p>
                        <p><strong>Encomenda:</strong> ${formatDateTime(orderDate)} (#${order.id})</p>
                        ${order.clientPhone !== 'N/A' ? `<p><strong>Contacto:</strong> ${order.clientPhone}</p>` : ''}
                        <p><strong>Pagamento:</strong> <span style="font-weight: 700; color: ${order.paid ? 'var(--status-terminado)' : 'var(--status-cancelado)'}">${order.paid ? 'Pago' : 'Pendente'}</span></p>
                    </div>
                    <div class="ticket-items">
                        <strong>Itens (${order.items.length}):</strong>
                        <ul class="ticket-items-list ${needsExpansion ? 'expandable' : ''}">
                            ${itemHtml}
                        </ul>
                        ${needsExpansion ? '<button class="expand-items-btn" data-action="expand-items">[Ver Todos]</button>' : ''}
                    </div>
                    ${imageActionsHtml}
                    
                    <div class="order-status-segmented">
                        <button data-action="set-status" data-status="recebido" class="${order.status === 'recebido' ? 'active' : ''}">Recebido</button>
                        <button data-action="set-status" data-status="producao" class="${order.status === 'producao' ? 'active' : ''}">Produção</button>
                        <button data-action="set-status" data-status="terminado" class="${order.status === 'terminado' ? 'active' : ''}">Terminado</button>
                        <button data-action="set-status" data-status="levantado" class="${order.status === 'levantado' ? 'active' : ''}">Levantado</button>
                        <button data-action="set-status" data-status="cancelado" class="${order.status === 'cancelado' ? 'active' : ''}">x</button>
                    </div>
                    
                    <div class="ticket-status-control">
                        <button class="btn ${order.paid ? 'btn-secondary' : 'btn-primary'}" data-action="toggle-paid">
                            ${order.paid ? 'Marcar Pendente' : 'Marcar Pago'}
                        </button>
                    </div>
                </div>`;
            }
            
            function handleStaffTicketClick(e) {
                const action = e.target.dataset.action;
                const card = e.target.closest('.order-ticket');
                if (!action || !card) return;
                
                // Ação de expandir (comum)
                if (action === 'expand-items') {
                    const list = card.querySelector('.ticket-items-list');
                    list.classList.toggle('expanded');
                    list.classList.remove('expandable');
                    e.target.textContent = list.classList.contains('expanded') ? '[Esconder]' : '[Ver Todos]';
                    return;
                }
                
                // Ações da view Agregada
                if (action === 'set-agg-status') {
                    const newStatus = e.target.dataset.status;
                    const itemName = card.dataset.aggItemName;
                    
                    // Encontra todas as encomendas filtradas
                    const filteredOrders = getFilteredAndSortedData();
                    
                    filteredOrders.forEach(order => {
                        let orderStatusChanged = false;
                        order.items.forEach(item => {
                            if (item.name === itemName && item.status !== 'levantado' && item.status !== 'cancelado') {
                                item.status = newStatus;
                                orderStatusChanged = true;
                            }
                        });
                        if (orderStatusChanged) {
                            updateOrderStatusFromItems(order);
                        }
                    });
                    
                    showToast(`Todos os items "${itemName}" atualizados para ${newStatus}.`);
                    saveState();
                    renderStaffPage();
                    return;
                }
                
                // Ações da view por Encomenda
                const orderId = card.dataset.orderId;
                const order = state.orders.find(o => o.id === orderId);
                if (!order) return;
                
                if (action === 'view-image') {
                    const itemIndex = e.target.dataset.itemIndex;
                    const item = order.items[itemIndex];
                    if (item && item.customFields.imagem_upload) {
                        showImageModal(item.customFields.imagem_upload, `Imagem para ${item.name}`, true);
                    }
                    return;
                }

                if (action === 'toggle-paid') {
                    order.paid = !order.paid;
                    showToast(`Pagamento da #${orderId} atualizado para "${order.paid ? 'Pago' : 'Pendente'}".`);
                }
                
                if (action === 'set-status') {
                    const newStatus = e.target.dataset.status;
                    
                    // Na view por encomenda, atualiza a encomenda toda e todos os seus items
                    order.status = newStatus;
                    if (!order.timestamps[newStatus]) order.timestamps[newStatus] = new Date().toISOString();
                    
                    order.items.forEach(item => {
                        // Só atualiza se o estado for "para a frente"
                        if (item.status !== 'cancelado' && item.status !== 'levantado') {
                           item.status = newStatus;
                        }
                    });
                    showToast(`Encomenda #${orderId} atualizada para "${newStatus}".`);
                }
                
                saveState();
                renderStaffPage();
            }
            
            function updateOrderStatusFromItems(order) {
                const itemStatuses = order.items.map(i => i.status);
                
                if (itemStatuses.every(s => s === 'levantado')) order.status = 'levantado';
                else if (itemStatuses.every(s => s === 'terminado' || s === 'levantado')) order.status = 'terminado';
                else if (itemStatuses.some(s => s === 'producao')) order.status = 'producao';
                else if (itemStatuses.every(s => s === 'recebido')) order.status = 'recebido';

                if(order.status === 'terminado' && !order.timestamps.terminado) order.timestamps.terminado = new Date().toISOString();
                if(order.status === 'levantado' && !order.timestamps.levantado) order.timestamps.levantado = new Date().toISOString();
            }

            // --- 6. PÁGINA ADMIN ---
            
            const adminFilterDate = document.getElementById('admin-filter-date');
            const adminFilterStatus = document.getElementById('admin-filter-status');
            const adminFilterItem = document.getElementById('admin-filter-item');
            const adminFilterClient = document.getElementById('admin-filter-client');
            const adminFilterLocation = document.getElementById('admin-filter-location');
            const adminExportBtn = document.getElementById('admin-export-csv');

            function initAdminPage() {
                adminFilterDate.value = ''; 
                
                populateAdminFilters();
                
                const filters = [adminFilterDate, adminFilterStatus, adminFilterItem, adminFilterClient, adminFilterLocation];
                filters.forEach(f => f.addEventListener('change', () => {
                    state.adminFilters.chartViewDate = new Date(adminFilterDate.value || new Date());
                    renderAdminDashboard();
                }));
                
                adminExportBtn.addEventListener('click', exportDataToCSV);
                
                document.getElementById('admin-chart-week-prev').addEventListener('click', () => navigateChart('week', -1));
                document.getElementById('admin-chart-week-next').addEventListener('click', () => navigateChart('week', 1));
                document.getElementById('admin-chart-month-prev').addEventListener('click', () => navigateChart('month', -1));
                document.getElementById('admin-chart-month-next').addEventListener('click', () => navigateChart('month', 1));

                renderAdminDashboard();
            }
            
            function navigateChart(unit, direction) {
                const d = state.adminFilters.chartViewDate;
                if (unit === 'week') {
                    d.setDate(d.getDate() + (7 * direction));
                } else if (unit === 'month') {
                    d.setMonth(d.getMonth() + direction);
                }
                state.adminFilters.chartViewDate = new Date(d);
                renderCharts();
            }

            function populateAdminFilters() {
                const itemNames = new Set();
                const clientNames = new Set();
                const locations = new Set();
                
                state.orders.forEach(order => {
                    clientNames.add(order.clientName);
                    locations.add(order.pickupLocation);
                    order.items.forEach(item => itemNames.add(item.name));
                });
                
                adminFilterItem.innerHTML = '<option value="all">Todos os Itens</option>';
                [...itemNames].sort().forEach(name => {
                    adminFilterItem.innerHTML += `<option value="${name}">${name}</option>`;
                });
                
                adminFilterClient.innerHTML = '<option value="all">Todos os Clientes</option>';
                [...clientNames].sort().forEach(name => {
                    adminFilterClient.innerHTML += `<option value="${name}">${name}</option>`;
                });

                adminFilterLocation.innerHTML = '<option value="all">Todos os Locais</option>';
                [...locations].sort().forEach(name => {
                    adminFilterLocation.innerHTML += `<option value="${name}">${name}</option>`;
                });
            }
            
            function getFilteredAdminOrders() {
                const date = adminFilterDate.value;
                const status = adminFilterStatus.value;
                const item = adminFilterItem.value;
                const client = adminFilterClient.value;
                const location = adminFilterLocation.value;
                
                return state.orders.filter(order => {
                    if (date && !order.pickupDate.startsWith(date)) return false;
                    
                    if (status !== 'all') {
                        if (status === 'pago' && !order.paid) return false;
                        if (status !== 'pago' && order.status !== status) return false;
                    }
                    
                    if (client !== 'all' && order.clientName !== client) return false;
                    
                    if (location !== 'all' && order.pickupLocation !== location) return false;
                    
                    if (item !== 'all' && !order.items.some(i => i.name === item)) return false;
                    
                    return true;
                });
            }

            function renderAdminDashboard() {
                const filteredOrders = getFilteredAdminOrders();
                
                const totalRevenue = filteredOrders.reduce((sum, o) => sum + o.total, 0);
                const totalOrders = filteredOrders.length;
                const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                
                document.getElementById('admin-kpi-revenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('admin-kpi-orders').textContent = totalOrders;
                document.getElementById('admin-kpi-avg-ticket').textContent = formatCurrency(avgTicket);
                
                const canceledOrders = filteredOrders.filter(o => o.status === 'cancelado').length;
                const wastePerc = totalOrders > 0 ? (canceledOrders / totalOrders) * 100 : 0;
                
                document.getElementById('admin-kpi-waste').textContent = `${wastePerc.toFixed(0)}%`;
                document.getElementById('admin-kpi-waste-sub').textContent = `${canceledOrders} / ${totalOrders}`;
                
                const fullTimes = [], prodTimes = [];
                let lateProd = 0, notPicked = 0;
                const now = new Date();
                
                filteredOrders.forEach(o => {
                    if (o.timestamps.recebido && o.timestamps.terminado) {
                        fullTimes.push(new Date(o.timestamps.terminado) - new Date(o.timestamps.recebido));
                    }
                    if (o.timestamps.producao && o.timestamps.terminado) {
                        prodTimes.push(new Date(o.timestamps.terminado) - new Date(o.timestamps.producao));
                    }
                    if (o.timestamps.terminado && new Date(o.timestamps.terminado) > new Date(o.pickupDate)) {
                        lateProd++;
                    }
                    if (now > new Date(o.pickupDate) && o.status !== 'levantado' && o.status !== 'cancelado') {
                        notPicked++;
                    }
                });

                document.getElementById('admin-kpi-time-full').textContent = formatAvgTime(fullTimes);
                document.getElementById('admin-kpi-time-prod').textContent = formatAvgTime(prodTimes);
                document.getElementById('admin-kpi-time-deadline').textContent = totalOrders > 0 ? `${((lateProd / totalOrders) * 100).toFixed(0)}%` : '0%';
                document.getElementById('admin-kpi-time-pickup').textContent = totalOrders > 0 ? `${((notPicked / totalOrders) * 100).toFixed(0)}%` : '0%';

                renderCharts();
            }
            
            function renderCharts() {
                const viewDate = state.adminFilters.chartViewDate;
                
                const weekStart = new Date(viewDate);
                weekStart.setDate(viewDate.getDate() - (viewDate.getDay() + 6) % 7); // Começa à Segunda
                const weekData = [];
                const weekLabels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
                
                for(let i=0; i<7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(weekStart.getDate() + i);
                    const dayStr = d.toISOString().split('T')[0];
                    const dayTotal = getFilteredAdminOrders() // Filtra pelos filtros de admin!
                        .filter(o => o.pickupDate.startsWith(dayStr))
                        .reduce((sum, o) => sum + o.total, 0);
                    weekData.push({ label: weekLabels[i], value: dayTotal });
                }
                
                document.getElementById('admin-chart-week-title').textContent = `Receita (€) - Semana de ${weekStart.toLocaleDateString('pt-PT', {day:'2-digit', month:'2-digit'})}`;
                renderChart('admin-chart-week', weekData);

                const monthStart = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
                const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
                const monthData = [];
                
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(monthStart);
                    d.setDate(i);
                    const dayStr = d.toISOString().split('T')[0];
                    const dayTotal = getFilteredAdminOrders() // Filtra pelos filtros de admin!
                        .filter(o => o.pickupDate.startsWith(dayStr))
                        .reduce((sum, o) => sum + o.total, 0);
                    monthData.push({ label: `${i}`, value: dayTotal });
                }

                document.getElementById('admin-chart-month-title').textContent = `Receita (€) - ${monthStart.toLocaleString('pt-PT', { month: 'long', year: 'numeric' })}`;
                renderChart('admin-chart-month', monthData);
            }
            
            function renderChart(containerId, data) {
                const container = document.getElementById(containerId);
                const maxValue = Math.max(10, ...data.map(d => d.value));
                let html = '';
                
                data.forEach(bar => {
                    const height = maxValue > 0 ? (bar.value / maxValue) * 100 : 0;
                    html += `
                        <div class="chart-bar" style="height: ${height.toFixed(0)}%;" title="${bar.label}: ${formatCurrency(bar.value)}">
                            <span class="bar-value">${bar.value > 1 ? formatCurrency(bar.value, 0) : ''}</span>
                            <span class="bar-label">${bar.label}</span>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            
            function exportDataToCSV() {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                const headers = [
                    "OrderID", "Tipo", "Cliente", "Telemovel", "Data Encomenda", "Data Levantamento", 
                    "Local", "Status", "Pago", "Total Encomenda", "ItemID", "ItemNome", "Quantidade", 
                    "Unidade", "Preco Item", "Total Item", "IVA", "ItemStatus", "CustomFields"
                ];
                csvContent += headers.join(";") + "\r\n";
                
                state.orders.forEach(order => {
                    order.items.forEach(item => {
                        const row = [
                            order.id, order.type, `"${order.clientName}"`, order.clientPhone,
                            order.orderDate, order.pickupDate, `"${order.pickupLocation}"`,
                            order.status, order.paid, order.total, item.itemId,
                            `"${item.name}"`, item.quantity, item.unit, item.price, item.totalPrice, (item.iva || false), item.status,
                            `"${JSON.stringify(item.customFields).replace(/"/g, '""')}"`
                        ];
                        csvContent += row.join(";") + "\r\n";
                    });
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "export_encomendas_pastelaria_filipe.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // --- 7. HELPERS ---
            
            function formatCurrency(value, decimals = 2) {
                return new Intl.NumberFormat('pt-PT', { 
                    style: 'currency', currency: 'EUR',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            }
            
            function formatDateTime(date) {
                return date.toLocaleString('pt-PT', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }
            
            function formatAvgTime(times) {
                if (times.length === 0) return '--';
                const avgMs = times.reduce((a, b) => a + b, 0) / times.length;
                if (avgMs < 0) return 'Inválido';
                const hours = Math.floor(avgMs / 3600000);
                const minutes = Math.floor((avgMs % 3600000) / 60000);
                return `${hours}h ${minutes}m`;
            }

            // --- INICIALIZAÇÃO ---
            loadState();
            initAppCore();
            initEncomendarPage(); // Substitui initClientPage()
            initMyOrdersPage();
            initStaffPage();
            initAdminPage();
        });
    </script>
</body>
</html>
